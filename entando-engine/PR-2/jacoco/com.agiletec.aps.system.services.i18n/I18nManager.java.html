<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>I18nManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Entando Core: Engine</a> &gt; <a href="index.source.html" class="el_package">com.agiletec.aps.system.services.i18n</a> &gt; <span class="el_source">I18nManager.java</span></div><h1>I18nManager.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2015-Present Entando Inc. (http://www.entando.com) All rights reserved.
 *
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 */

package com.agiletec.aps.system.services.i18n;

import com.agiletec.aps.system.common.AbstractService;
import com.agiletec.aps.system.exception.ApsSystemException;
import com.agiletec.aps.system.services.i18n.cache.II18nManagerCacheWrapper;
import com.agiletec.aps.system.services.lang.ILangManager;
import com.agiletec.aps.util.ApsProperties;
import java.util.ArrayList;
import java.util.Enumeration;
import java.util.List;
import java.util.Map;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import org.apache.commons.lang.StringUtils;
import org.apache.commons.lang.text.StrSubstitutor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Servizio che fornisce stringhe &quot;localizzate&quot;. Le stringhe sono specificate da una chiave di identificazione e dalla lingua di
 * riferimento.
 */
<span class="fc" id="L37">public class I18nManager extends AbstractService implements II18nManager {</span>

<span class="fc" id="L39">    private static final Logger logger = LoggerFactory.getLogger(I18nManager.class);</span>

    private II18nManagerCacheWrapper cacheWrapper;

    private ILangManager langManager;

    private II18nDAO i18nDAO;

    protected II18nDAO getI18nDAO() {
<span class="fc" id="L48">        return i18nDAO;</span>
    }

    public void setI18nDAO(II18nDAO i18nDao) {
<span class="fc" id="L52">        i18nDAO = i18nDao;</span>
<span class="fc" id="L53">    }</span>

    protected ILangManager getLangManager() {
<span class="fc" id="L56">        return langManager;</span>
    }

    public void setLangManager(ILangManager langManager) {
<span class="fc" id="L60">        this.langManager = langManager;</span>
<span class="fc" id="L61">    }</span>

    protected II18nManagerCacheWrapper getCacheWrapper() {
<span class="fc" id="L64">        return cacheWrapper;</span>
    }

    public void setCacheWrapper(II18nManagerCacheWrapper cacheWrapper) {
<span class="fc" id="L68">        this.cacheWrapper = cacheWrapper;</span>
<span class="fc" id="L69">    }</span>

    protected String getDefaultLang() {
<span class="fc" id="L72">        return this.getLangManager().getDefaultLang().getCode();</span>
    }

    @Override
    public void init() throws Exception {
<span class="fc" id="L77">        this.getCacheWrapper().initCache(this.getI18nDAO());</span>
<span class="fc" id="L78">        logger.debug(&quot;{} : initialized {} labels&quot;, this.getClass().getName(), this.getLabelGroups().size());</span>
<span class="fc" id="L79">    }</span>

    /**
     * Return the group of labels.
     *
     * @return The group of labels.
     */
    @Override
    public Map&lt;String, ApsProperties&gt; getLabelGroups() {
<span class="fc" id="L88">        return this.getCacheWrapper().getLabelGroups();</span>
    }

    @Override
    public String renderLabel(String key, String renderingLang,
            boolean keyIfEmpty) throws ApsSystemException {
<span class="fc" id="L94">        String label = null;</span>
<span class="fc" id="L95">        ApsProperties labelsProp = this.getLabelGroup(key);</span>
<span class="fc bfc" id="L96" title="All 2 branches covered.">        if (labelsProp != null) {</span>
<span class="fc" id="L97">            label = labelsProp.getProperty(renderingLang);</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">            if (StringUtils.isEmpty(label)) {</span>
<span class="fc" id="L99">                label = labelsProp.getProperty(this.getDefaultLang());</span>
            }
        }
<span class="fc bfc" id="L102" title="All 4 branches covered.">        if (keyIfEmpty &amp;&amp; StringUtils.isEmpty(label)) {</span>
<span class="fc" id="L103">            label = key;</span>
        }
<span class="fc" id="L105">        return label;</span>
    }

    @Override
    public String renderLabel(String key, String renderingLang,
            boolean keyIfEmpty, Map&lt;String, String&gt; params) throws ApsSystemException {
<span class="fc" id="L111">        String value = this.renderLabel(key, renderingLang, keyIfEmpty);</span>
<span class="pc bpc" id="L112" title="2 of 6 branches missed.">        if (params != null &amp;&amp; !params.isEmpty() &amp;&amp; value != null) {</span>
<span class="fc" id="L113">            value = this.parseText(value, params);</span>
        }
<span class="fc" id="L115">        return value;</span>
    }

    protected String parseText(String defaultText, Map&lt;String, String&gt; params) {
<span class="fc" id="L119">        StrSubstitutor strSub = new StrSubstitutor(params);</span>
<span class="fc" id="L120">        return strSub.replace(defaultText);</span>
    }

    /**
     * Restituisce una label in base alla chiave ed alla lingua specificata.
     *
     * @param key La chiave
     * @param langCode Il codice della lingua.
     * @return La label richiesta.
     */
    @Override
    public String getLabel(String key, String langCode) {
<span class="fc" id="L132">        String label = null;</span>
<span class="fc" id="L133">        ApsProperties labelsProp = this.getCacheWrapper().getLabelGroup(key);</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">        if (labelsProp != null) {</span>
<span class="fc" id="L135">            label = labelsProp.getProperty(langCode);</span>
        }
<span class="fc" id="L137">        return label;</span>
    }

    @Override
    public ApsProperties getLabelGroup(String key) throws ApsSystemException {
<span class="fc" id="L142">        ApsProperties labelsProp = this.getCacheWrapper().getLabelGroup(key);</span>
<span class="fc bfc" id="L143" title="All 2 branches covered.">        if (null == labelsProp) {</span>
<span class="fc" id="L144">            return null;</span>
        }
<span class="fc" id="L146">        return labelsProp.clone();</span>
    }

    /**
     * Add a group of labels on db.
     *
     * @param key The key of the labels.
     * @param labels The labels to add.
     * @throws ApsSystemException In case of Exception.
     */
    @Override
    public void addLabelGroup(String key, ApsProperties labels) throws ApsSystemException {
        try {
<span class="fc" id="L159">            this.getI18nDAO().addLabelGroup(key, labels);</span>
<span class="fc" id="L160">            this.getCacheWrapper().addLabelGroup(key, labels);</span>
<span class="nc" id="L161">        } catch (Throwable t) {</span>
<span class="nc" id="L162">            logger.error(&quot;Error while adding a group of labels by key '{}'&quot;, key, t);</span>
<span class="nc" id="L163">            throw new ApsSystemException(&quot;Error while adding a group of labels&quot;, t);</span>
<span class="fc" id="L164">        }</span>
<span class="fc" id="L165">    }</span>

    /**
     * Delete a group of labels from db.
     *
     * @param key The key of the labels to delete.
     * @throws ApsSystemException In case of Exception.
     */
    @Override
    public void deleteLabelGroup(String key) throws ApsSystemException {
        try {
<span class="fc" id="L176">            this.getI18nDAO().deleteLabelGroup(key);</span>
<span class="fc" id="L177">            this.getCacheWrapper().removeLabelGroup(key);</span>
<span class="nc" id="L178">        } catch (Throwable t) {</span>
<span class="nc" id="L179">            logger.error(&quot;Error while deleting a label by key {}&quot;, key, t);</span>
<span class="nc" id="L180">            throw new ApsSystemException(&quot;Error while deleting a label&quot;, t);</span>
<span class="fc" id="L181">        }</span>
<span class="fc" id="L182">    }</span>

    /**
     * Update a group of labels on db.
     *
     * @param key The key of the labels.
     * @param labels The key of the labels to update.
     * @throws ApsSystemException In case of Exception.
     */
    @Override
    public void updateLabelGroup(String key, ApsProperties labels) throws ApsSystemException {
        try {
<span class="fc" id="L194">            this.getI18nDAO().updateLabelGroup(key, labels);</span>
<span class="fc" id="L195">            this.getCacheWrapper().updateLabelGroup(key, labels);</span>
<span class="nc" id="L196">        } catch (Throwable t) {</span>
<span class="nc" id="L197">            logger.error(&quot;Error while updating label with key {}&quot;, key, t);</span>
<span class="nc" id="L198">            throw new ApsSystemException(&quot;Error while updating a label&quot;, t);</span>
<span class="fc" id="L199">        }</span>
<span class="fc" id="L200">    }</span>

    /**
     * Restituisce la lista di chiavi di gruppi di labels in base ai parametri segnalati.
     *
     * @param insertedText Il testo tramite il quale effettuare la ricerca.
     * @param doSearchByKey Specifica se effettuare la ricerca sulle chiavi, in base al testo inserito.
     * @param doSearchByLang Specifica se effettuare la ricerca sul testo di una lingua, in base al testo inserito.
     * @param langCode Specifica la lingua della label sulla quale effettuare la ricerca, in base al testo inserito.
     * @return La lista di chiavi di gruppi di labels in base ai parametri segbalati.
     */
    @Override
    public List&lt;String&gt; searchLabelsKey(String insertedText, boolean doSearchByKey,
            boolean doSearchByLang, String langCode) {
<span class="fc" id="L214">        List&lt;String&gt; keys = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L215">        Pattern pattern = Pattern.compile(insertedText, Pattern.CASE_INSENSITIVE + Pattern.LITERAL);</span>
<span class="fc" id="L216">        Matcher matcher = pattern.matcher(&quot;&quot;);</span>
<span class="fc" id="L217">        List&lt;String&gt; allKeys = new ArrayList&lt;&gt;(this.getLabelGroups().keySet());</span>
<span class="fc bfc" id="L218" title="All 2 branches covered.">        for (String key : allKeys) {</span>
<span class="fc" id="L219">            ApsProperties properies = this.getLabelGroups().get(key);</span>
<span class="fc bfc" id="L220" title="All 4 branches covered.">            if (!doSearchByKey &amp;&amp; !doSearchByLang) {</span>
<span class="fc" id="L221">                matcher = matcher.reset(key);</span>
<span class="fc bfc" id="L222" title="All 2 branches covered.">                if (matcher.find()) {</span>
<span class="fc" id="L223">                    keys.add(key);</span>
                } else {
<span class="fc" id="L225">                    Enumeration&lt;Object&gt; langKeys = properies.keys();</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">                    while (langKeys.hasMoreElements()) {</span>
<span class="fc" id="L227">                        String lang = (String) langKeys.nextElement();</span>
<span class="fc" id="L228">                        String target = properies.getProperty(lang);</span>
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">                        if (this.labelMatch(target, matcher)) {</span>
<span class="nc" id="L230">                            keys.add(key);</span>
<span class="nc" id="L231">                            break;</span>
                        }
<span class="fc" id="L233">                    }</span>
<span class="fc" id="L234">                }</span>
<span class="pc bpc" id="L235" title="1 of 4 branches missed.">            } else if (doSearchByKey &amp;&amp; !doSearchByLang) {</span>
<span class="fc" id="L236">                matcher = matcher.reset(key);</span>
<span class="fc bfc" id="L237" title="All 2 branches covered.">                if (matcher.find()) {</span>
<span class="fc" id="L238">                    keys.add(key);</span>
                }
<span class="pc bpc" id="L240" title="2 of 4 branches missed.">            } else if (!doSearchByKey &amp;&amp; doSearchByLang) {</span>
<span class="fc" id="L241">                String target = properies.getProperty(langCode);</span>
<span class="fc bfc" id="L242" title="All 2 branches covered.">                if (this.labelMatch(target, matcher)) {</span>
<span class="fc" id="L243">                    keys.add(key);</span>
                }
            }
<span class="fc" id="L246">        }</span>
<span class="fc" id="L247">        return keys;</span>
    }

    private boolean labelMatch(String target, Matcher matcher) {
<span class="fc" id="L251">        boolean match = false;</span>
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">        if (null != target) {</span>
<span class="fc" id="L253">            matcher = matcher.reset(target);</span>
<span class="fc bfc" id="L254" title="All 2 branches covered.">            if (matcher.find()) {</span>
<span class="fc" id="L255">                match = true;</span>
            }
        }
<span class="fc" id="L258">        return match;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>