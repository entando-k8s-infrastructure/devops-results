<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ResponseBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Entando Core: Engine</a> &gt; <a href="index.source.html" class="el_package">org.entando.entando.aps.system.services.api.server</a> &gt; <span class="el_source">ResponseBuilder.java</span></div><h1>ResponseBuilder.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2015-Present Entando Inc. (http://www.entando.com) All rights reserved.
 *
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 */

package org.entando.entando.aps.system.services.api.server;

import com.agiletec.aps.system.common.renderer.IVelocityRenderer;
import com.agiletec.aps.system.exception.ApsSystemException;
import com.agiletec.aps.util.ApsWebApplicationUtils;
import com.agiletec.aps.util.FileTextReader;
import java.io.InputStream;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.ArrayList;
import java.util.List;
import java.util.Properties;
import javax.servlet.ServletContext;
import javax.ws.rs.core.Response;
import org.entando.entando.aps.system.services.api.IApiCatalogManager;
import org.entando.entando.aps.system.services.api.IApiErrorCodes;
import org.entando.entando.aps.system.services.api.model.AbstractApiResponse;
import org.entando.entando.aps.system.services.api.model.ApiError;
import org.entando.entando.aps.system.services.api.model.ApiException;
import org.entando.entando.aps.system.services.api.model.ApiMethod;
import org.entando.entando.aps.system.services.api.model.ApiMethodParameter;
import org.entando.entando.aps.system.services.api.model.ApiMethodResult;
import org.entando.entando.aps.system.services.api.model.StringApiResponse;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeansException;
import org.springframework.beans.factory.BeanFactory;
import org.springframework.beans.factory.BeanFactoryAware;
import org.springframework.core.io.Resource;
import org.springframework.web.context.ServletContextAware;

/**
 * @author E.Santoboni
 */
<span class="nc" id="L49">public class ResponseBuilder implements IResponseBuilder, BeanFactoryAware, ServletContextAware {</span>

<span class="nc" id="L51">    private static final Logger _logger = LoggerFactory.getLogger(ApiRestStatusServer.class);</span>
    private IApiCatalogManager _apiCatalogManager;
    private IVelocityRenderer _velocityRenderer;
    private BeanFactory _beanFactory;
    private ServletContext _servletContext;

    @Override
    @Deprecated
    public Object createResponse(String resourceName, Properties parameters) throws ApsSystemException {
<span class="nc" id="L60">        Object apiResponse = null;</span>
        try {
<span class="nc" id="L62">            ApiMethod method = this.extractApiMethod(ApiMethod.HttpMethod.GET, null, resourceName);</span>
<span class="nc" id="L63">            apiResponse = this.createResponse(method, parameters);</span>
<span class="nc" id="L64">        } catch (ApiException e) {</span>
<span class="nc" id="L65">            _logger.error(&quot;Error creating response for method GET, resource '{}'&quot;, resourceName, e);</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">            if (apiResponse == null) {</span>
<span class="nc" id="L67">                apiResponse = new StringApiResponse();</span>
            }
<span class="nc" id="L69">            ((AbstractApiResponse) apiResponse).addErrors(e.getErrors());</span>
<span class="nc" id="L70">        }</span>
<span class="nc" id="L71">        return apiResponse;</span>
    }

    @Override
    public Object createResponse(ApiMethod method, Properties parameters) throws ApsSystemException {
<span class="nc" id="L76">        return createResponse(method, null, parameters);</span>
    }

    @Override
    public Object createResponse(ApiMethod method, Object bodyObject, Properties parameters) throws ApsSystemException {
<span class="nc" id="L81">        AbstractApiResponse response = null;</span>
        try {
<span class="nc" id="L83">            this.checkParameter(method, parameters);</span>
<span class="nc" id="L84">            Object bean = this.extractBean(method);</span>
<span class="nc" id="L85">            Object masterResult = null;</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            if (method.getHttpMethod().equals(ApiMethod.HttpMethod.GET)) {</span>
<span class="nc" id="L87">                masterResult = this.invokeGetMethod(method, bean, null, parameters, true);</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">                if (null == masterResult) {</span>
<span class="nc" id="L89">                    ApiError error = new ApiError(IApiErrorCodes.API_INVALID_RESPONSE, &quot;Invalid or null Response&quot;,</span>
                            Response.Status.SERVICE_UNAVAILABLE);
<span class="nc" id="L91">                    throw new ApiException(error);</span>
                }
            } else {
<span class="nc" id="L94">                masterResult = this.invokePutPostDeleteMethod(method, bean, parameters, bodyObject);</span>
            }
<span class="nc bnc" id="L96" title="All 2 branches missed.">            if (null == method.getResponseClassName()) {</span>
<span class="nc" id="L97">                return masterResult;</span>
            }
<span class="nc" id="L99">            response = this.buildApiResponseObject(method);</span>
<span class="nc bnc" id="L100" title="All 4 branches missed.">            if (null == response &amp;&amp; (masterResult instanceof String)) {</span>
<span class="nc" id="L101">                return masterResult;</span>
            }
<span class="nc" id="L103">            String htmlResult = this.extractHtmlResult(masterResult, response, method, parameters, bean);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">            if (masterResult instanceof ApiMethodResult) {</span>
<span class="nc" id="L105">                response.addErrors(((ApiMethodResult) masterResult).getErrors());</span>
<span class="nc" id="L106">                response.setResult(((ApiMethodResult) masterResult).getResult(), htmlResult);</span>
            } else {
<span class="nc" id="L108">                response.setResult(masterResult, htmlResult);</span>
            }
<span class="nc" id="L110">        } catch (ApiException e) {</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">            if (response == null) {</span>
<span class="nc" id="L112">                response = new StringApiResponse();</span>
            }
<span class="nc" id="L114">            response.addErrors(e.getErrors());</span>
<span class="nc" id="L115">            response.setResult(FAILURE, null);</span>
<span class="nc" id="L116">        } catch (Throwable t) {</span>
<span class="nc" id="L117">            _logger.error(&quot;Error creating response - {}&quot;, this.buildApiSignature(method), t);</span>
<span class="nc" id="L118">            String message = &quot;Error creating response - &quot; + this.buildApiSignature(method);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">            if (response == null) {</span>
<span class="nc" id="L120">                response = new StringApiResponse();</span>
            }
<span class="nc" id="L122">            ApiError error = new ApiError(IApiErrorCodes.API_METHOD_ERROR, message, Response.Status.INTERNAL_SERVER_ERROR);</span>
<span class="nc" id="L123">            response.addError(error);</span>
<span class="nc" id="L124">            response.setResult(FAILURE, null);</span>
<span class="nc" id="L125">        }</span>
<span class="nc" id="L126">        return response;</span>
    }

    private String extractHtmlResult(Object masterResult,
            AbstractApiResponse apiResponse, ApiMethod apiMethod, Properties parameters, Object bean) {
<span class="nc" id="L131">        String htmlResult = null;</span>
        try {
<span class="nc" id="L133">            htmlResult = (String) this.invokeGetMethod(apiMethod, bean, &quot;ToHtml&quot;, parameters, false);</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">            if (null != htmlResult) {</span>
<span class="nc" id="L135">                return htmlResult;</span>
            }
<span class="nc" id="L137">            String template = this.extractTemplate(apiMethod);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">            if (null == template) {</span>
<span class="nc" id="L139">                return null;</span>
            }
<span class="nc" id="L141">            htmlResult = this.getVelocityRenderer().render(masterResult, template);</span>
<span class="nc" id="L142">        } catch (ApiException t) {</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">            if (null != t.getErrors()) {</span>
<span class="nc" id="L144">                apiResponse.addErrors(t.getErrors());</span>
            } else {
<span class="nc" id="L146">                _logger.error(&quot;Error creating html response - {}&quot;, this.buildApiSignature(apiMethod), t);</span>
            }
<span class="nc" id="L148">        } catch (Throwable t) {</span>
<span class="nc" id="L149">            _logger.error(&quot;Error creating html response - {}&quot;, this.buildApiSignature(apiMethod), t);</span>
<span class="nc" id="L150">        }</span>
<span class="nc" id="L151">        return htmlResult;</span>
    }

    protected String extractTemplate(ApiMethod apiMethod) throws Exception {
<span class="nc" id="L155">        String template = null;</span>
<span class="nc" id="L156">        InputStream is = null;</span>
        try {
<span class="nc" id="L158">            StringBuilder path = new StringBuilder(&quot;classpath*:/api/&quot;);</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">            if (null != apiMethod.getPluginCode()) {</span>
<span class="nc" id="L160">                path.append(&quot;plugins/&quot;).append(apiMethod.getPluginCode()).append(&quot;/&quot;);</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">            } else if (!apiMethod.getSource().equalsIgnoreCase(&quot;core&quot;)) {</span>
<span class="nc" id="L162">                path.append(apiMethod.getSource()).append(&quot;/&quot;);</span>
            }
<span class="nc" id="L164">            path.append(&quot;aps/get/&quot;);</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">            if (null != apiMethod.getNamespace()) {</span>
<span class="nc" id="L166">                path.append(apiMethod.getNamespace()).append(&quot;/&quot;);</span>
            }
<span class="nc" id="L168">            path.append(apiMethod.getResourceName()).append(&quot;/description-item.vm&quot;);</span>
<span class="nc" id="L169">            Resource[] resources = ApsWebApplicationUtils.getResources(path.toString(), this.getServletContext());</span>
<span class="nc bnc" id="L170" title="All 4 branches missed.">            if (null != resources &amp;&amp; resources.length == 1) {</span>
<span class="nc" id="L171">                Resource resource = resources[0];</span>
<span class="nc" id="L172">                is = resource.getInputStream();</span>
            }
<span class="nc bnc" id="L174" title="All 2 branches missed.">            if (null == is) {</span>
<span class="nc" id="L175">                _logger.debug(&quot;Null Input Stream - template file path {}&quot;, path.toString());</span>
<span class="nc" id="L176">                return null;</span>
            }
<span class="nc" id="L178">            template = FileTextReader.getText(is);</span>
<span class="nc" id="L179">        } catch (Throwable t) {</span>
<span class="nc" id="L180">            _logger.error(&quot;Error extracting template - {}&quot;, this.buildApiSignature(apiMethod), t);</span>
        } finally {
<span class="nc bnc" id="L182" title="All 2 branches missed.">            if (null != is) {</span>
<span class="nc" id="L183">                is.close();</span>
            }
        }
<span class="nc" id="L186">        return template;</span>
    }

    private void checkParameter(ApiMethod apiMethod, Properties parameters) throws Throwable {
        try {
<span class="nc" id="L191">            List&lt;ApiMethodParameter&gt; apiParameters = apiMethod.getParameters();</span>
<span class="nc bnc" id="L192" title="All 4 branches missed.">            if (null == apiParameters || apiParameters.isEmpty()) {</span>
<span class="nc" id="L193">                return;</span>
            }
<span class="nc" id="L195">            List&lt;ApiError&gt; errors = new ArrayList&lt;ApiError&gt;();</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">            for (int i = 0; i &lt; apiParameters.size(); i++) {</span>
<span class="nc" id="L197">                ApiMethodParameter apiParam = apiParameters.get(i);</span>
<span class="nc" id="L198">                String paramName = apiParam.getKey();</span>
<span class="nc" id="L199">                Object value = parameters.get(paramName);</span>
<span class="nc bnc" id="L200" title="All 6 branches missed.">                if (apiParam.isRequired() &amp;&amp; (null == value || value.toString().trim().length() == 0)) {</span>
<span class="nc" id="L201">                    errors.add(new ApiError(IApiErrorCodes.API_PARAMETER_REQUIRED, &quot;Parameter '&quot; + paramName + &quot;' is required&quot;,</span>
                            Response.Status.BAD_REQUEST));
                }
            }
<span class="nc bnc" id="L205" title="All 2 branches missed.">            if (!errors.isEmpty()) {</span>
<span class="nc" id="L206">                throw new ApiException(errors);</span>
            }
<span class="nc" id="L208">        } catch (ApiException t) {</span>
<span class="nc" id="L209">            throw t;</span>
<span class="nc" id="L210">        } catch (Throwable t) {</span>
<span class="nc" id="L211">            _logger.error(&quot;Error checking api parameters&quot;, t);</span>
<span class="nc" id="L212">            throw new ApsSystemException(&quot;Internal Error&quot;, t);</span>
<span class="nc" id="L213">        }</span>
<span class="nc" id="L214">    }</span>

    private AbstractApiResponse buildApiResponseObject(ApiMethod apiMethod) throws ApiException {
<span class="nc" id="L217">        AbstractApiResponse apiResponse = null;</span>
        try {
<span class="nc" id="L219">            Class responseClass = Class.forName(apiMethod.getResponseClassName());</span>
<span class="nc" id="L220">            apiResponse = (AbstractApiResponse) responseClass.newInstance();</span>
<span class="nc" id="L221">        } catch (Exception e) {</span>
<span class="nc" id="L222">            _logger.error(&quot;Error creating instance of response '{}'&quot;, apiMethod.getResponseClassName(), e);</span>
<span class="nc" id="L223">        }</span>
<span class="nc" id="L224">        return apiResponse;</span>
    }

    @Override
    @Deprecated
    public Object invoke(String resourceName, Properties parameters) throws ApiException, ApsSystemException {
<span class="nc" id="L230">        Object result = null;</span>
        try {
<span class="nc" id="L232">            ApiMethod api = this.extractApiMethod(ApiMethod.HttpMethod.GET, null, resourceName);</span>
<span class="nc" id="L233">            this.checkParameter(api, parameters);</span>
<span class="nc" id="L234">            Object bean = this.extractBean(api);</span>
<span class="nc" id="L235">            result = this.invokeGetMethod(api, bean, &quot;&quot;, parameters, true);</span>
<span class="nc" id="L236">        } catch (ApiException ae) {</span>
<span class="nc" id="L237">            _logger.error(&quot;Error invoking method GET for resource '{}'&quot;, resourceName, ae);</span>
<span class="nc" id="L238">            throw ae;</span>
<span class="nc" id="L239">        } catch (Throwable t) {</span>
<span class="nc" id="L240">            _logger.error(&quot;Error invoking method GET for resource '{}'&quot;, resourceName, t);</span>
<span class="nc" id="L241">            throw new ApsSystemException(&quot;Error invoking method GET for resource '&quot; + resourceName + &quot;'&quot;, t);</span>
<span class="nc" id="L242">        }</span>
<span class="nc" id="L243">        return result;</span>
    }

    @Override
    public ApiMethod extractApiMethod(ApiMethod.HttpMethod httpMethod, String namespace, String resourceName) throws ApiException {
<span class="nc" id="L248">        ApiMethod api = null;</span>
<span class="nc" id="L249">        String signature = this.buildApiSignature(httpMethod, namespace, resourceName);</span>
        try {
<span class="nc" id="L251">            api = this.getApiCatalogManager().getMethod(httpMethod, namespace, resourceName);</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">            if (null == api) {</span>
<span class="nc" id="L253">                ApiError error = new ApiError(IApiErrorCodes.API_INVALID, signature + &quot; does not exists&quot;, Response.Status.NOT_FOUND);</span>
<span class="nc" id="L254">                throw new ApiException(error);</span>
            }
<span class="nc bnc" id="L256" title="All 2 branches missed.">            if (!api.isActive()) {</span>
<span class="nc" id="L257">                ApiError error = new ApiError(IApiErrorCodes.API_INVALID, signature + &quot; does not exists&quot;, Response.Status.NOT_FOUND);</span>
<span class="nc" id="L258">                throw new ApiException(error);</span>
            }
<span class="nc" id="L260">        } catch (ApiException ae) {</span>
<span class="nc" id="L261">            _logger.error(&quot;Error extracting api method {}&quot;, this.buildApiSignature(httpMethod, namespace, resourceName), ae);</span>
<span class="nc" id="L262">            throw ae;</span>
<span class="nc" id="L263">        } catch (Throwable t) {</span>
<span class="nc" id="L264">            _logger.error(&quot;Error extracting api method {}&quot;, this.buildApiSignature(httpMethod, namespace, resourceName), t);</span>
<span class="nc" id="L265">            throw new ApiException(IApiErrorCodes.SERVER_ERROR, signature + &quot; is not supported&quot;, Response.Status.INTERNAL_SERVER_ERROR);</span>
<span class="nc" id="L266">        }</span>
<span class="nc" id="L267">        return api;</span>
    }

    private String buildApiSignature(ApiMethod apiMethod) {
<span class="nc" id="L271">        return this.buildApiSignature(apiMethod.getHttpMethod(), apiMethod.getNamespace(), apiMethod.getResourceName());</span>
    }

    private String buildApiSignature(ApiMethod.HttpMethod httpMethod, String namespace, String resourceName) {
<span class="nc" id="L275">        StringBuilder buffer = new StringBuilder();</span>
<span class="nc" id="L276">        buffer.append(&quot;Method '&quot;).append(httpMethod.toString()).append(&quot;' Resource '&quot;).append(resourceName).append(&quot;'&quot;);</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">        if (null != namespace) {</span>
<span class="nc" id="L278">            buffer.append(&quot; Namespace '&quot;).append(namespace).append(&quot;'&quot;);</span>
        }
<span class="nc" id="L280">        return buffer.toString();</span>
    }

    protected Object extractBean(ApiMethod api) throws ApsSystemException, ApiException {
<span class="nc" id="L284">        Object bean = this.getBeanFactory().getBean(api.getSpringBean());</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">        if (null == bean) {</span>
<span class="nc" id="L286">            _logger.error(&quot;Null bean '{}' for api {}&quot;, api.getSpringBean(), this.buildApiSignature(api));</span>
<span class="nc" id="L287">            throw new ApiException(IApiErrorCodes.SERVER_ERROR, this.buildApiSignature(api) + &quot; is not supported&quot;,</span>
                    Response.Status.INTERNAL_SERVER_ERROR);
        }
<span class="nc" id="L290">        return bean;</span>
    }

    @Deprecated
    protected Object invokeMethod(ApiMethod api, Object bean,
            String methodSuffix, Properties parameters, boolean throwException) throws Throwable {
<span class="nc" id="L296">        return this.invokeGetMethod(api, bean, methodSuffix, parameters, throwException);</span>
    }

    protected Object invokeGetMethod(ApiMethod apiMethod, Object bean,
            String methodSuffix, Properties parameters, boolean throwException) throws Throwable {
<span class="nc" id="L301">        String methodName = null;</span>
<span class="nc" id="L302">        Object result = null;</span>
        try {
<span class="nc" id="L304">            Class[] parameterTypes = new Class[]{Properties.class};</span>
<span class="nc" id="L305">            Class beanClass = bean.getClass();</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">            methodName = (null != methodSuffix) ? apiMethod.getSpringBeanMethod() + methodSuffix.trim() : apiMethod.getSpringBeanMethod();</span>
<span class="nc" id="L307">            Method method = beanClass.getDeclaredMethod(methodName, parameterTypes);</span>
<span class="nc" id="L308">            result = method.invoke(bean, parameters);</span>
<span class="nc" id="L309">        } catch (NoSuchMethodException e) {</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">            if (throwException) {</span>
<span class="nc" id="L311">                _logger.error(&quot;No such method '{}' of class '{}'&quot;, methodName, bean.getClass(), e);</span>
<span class="nc" id="L312">                throw new ApiException(IApiErrorCodes.API_METHOD_ERROR, &quot;Method not supported - &quot; + this.buildApiSignature(apiMethod),</span>
                        Response.Status.INTERNAL_SERVER_ERROR);
            }
<span class="nc" id="L315">        } catch (InvocationTargetException e) {</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">            if (e.getTargetException() instanceof ApiException) {</span>
<span class="nc" id="L317">                throw e.getTargetException();</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">            } else if (throwException) {</span>
<span class="nc" id="L319">                _logger.error(&quot;Error invoking method '{}' of class '{}'&quot;, methodName, bean.getClass());</span>
<span class="nc" id="L320">                throw new ApiException(IApiErrorCodes.API_METHOD_ERROR, &quot;Error invoking Method - &quot; + this.buildApiSignature(apiMethod),</span>
                        Response.Status.INTERNAL_SERVER_ERROR);
            }
<span class="nc" id="L323">        } catch (Throwable t) {</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">            if (throwException) {</span>
<span class="nc" id="L325">                _logger.error(&quot;Error invoking method - {} {} of class '{}'&quot;, this.buildApiSignature(apiMethod), methodName, bean.getClass(),</span>
                        t);
<span class="nc" id="L327">                throw t;</span>
            }
<span class="nc" id="L329">        }</span>
<span class="nc" id="L330">        return result;</span>
    }

    protected Object invokePutPostDeleteMethod(ApiMethod apiMethod, Object bean,
            Properties parameters, Object bodyObject) throws Throwable {
<span class="nc" id="L335">        Object result = null;</span>
        try {
<span class="nc bnc" id="L337" title="All 2 branches missed.">            if (apiMethod.getHttpMethod().equals(ApiMethod.HttpMethod.DELETE)) {</span>
<span class="nc" id="L338">                result = this.invokeDeleteMethod(apiMethod, bean, parameters);</span>
            } else {
<span class="nc" id="L340">                result = this.invokePutPostMethod(apiMethod, bean, parameters, bodyObject);</span>
            }
<span class="nc bnc" id="L342" title="All 2 branches missed.">            if (null != result) {</span>
<span class="nc" id="L343">                return result;</span>
            }
<span class="nc" id="L345">            StringApiResponse response = new StringApiResponse();</span>
<span class="nc" id="L346">            response.setResult(SUCCESS, null);</span>
<span class="nc" id="L347">            result = response;</span>
<span class="nc" id="L348">        } catch (NoSuchMethodException e) {</span>
<span class="nc" id="L349">            _logger.error(&quot;No such method '{}' of class '{}'&quot;, apiMethod.getSpringBeanMethod(), bean.getClass(), e);</span>
<span class="nc" id="L350">            throw new ApiException(IApiErrorCodes.API_METHOD_ERROR, &quot;Method not supported - &quot; + this.buildApiSignature(apiMethod),</span>
                    Response.Status.INTERNAL_SERVER_ERROR);
<span class="nc" id="L352">        } catch (InvocationTargetException e) {</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">            if (e.getTargetException() instanceof ApiException) {</span>
<span class="nc" id="L354">                throw e.getTargetException();</span>
            } else {
<span class="nc" id="L356">                _logger.error(&quot;Error invoking method '{}' of class '{}'&quot;, apiMethod.getSpringBeanMethod(), bean.getClass());</span>
<span class="nc" id="L357">                throw new ApiException(IApiErrorCodes.API_METHOD_ERROR, &quot;Error invoking Method - &quot; + this.buildApiSignature(apiMethod),</span>
                        Response.Status.INTERNAL_SERVER_ERROR);
            }
<span class="nc" id="L360">        } catch (Throwable t) {</span>
<span class="nc" id="L361">            _logger.error(&quot;Error invoking method '{}' of class '{}'&quot;, apiMethod.getSpringBeanMethod(), bean.getClass(), t);</span>
<span class="nc" id="L362">            throw t;</span>
<span class="nc" id="L363">        }</span>
<span class="nc" id="L364">        return result;</span>
    }

    private Object invokePutPostMethod(ApiMethod api, Object bean,
            Properties parameters, Object bodyObject) throws Throwable {
<span class="nc" id="L369">        Object result = null;</span>
<span class="nc" id="L370">        Class beanClass = bean.getClass();</span>
<span class="nc" id="L371">        String methodName = api.getSpringBeanMethod();</span>
        try {
<span class="nc" id="L373">            Class[] parameterTypes = new Class[]{bodyObject.getClass(), Properties.class};</span>
<span class="nc" id="L374">            Method method = beanClass.getDeclaredMethod(methodName, parameterTypes);</span>
<span class="nc" id="L375">            result = method.invoke(bean, bodyObject, parameters);</span>
<span class="nc" id="L376">        } catch (NoSuchMethodException e) {</span>
            //the first exception of type &quot;NoSuchMethodException&quot; will not catched... the second yes
<span class="nc" id="L378">            Class[] parameterTypes = new Class[]{bodyObject.getClass()};</span>
<span class="nc" id="L379">            Method method = beanClass.getDeclaredMethod(methodName, parameterTypes);</span>
<span class="nc" id="L380">            result = method.invoke(bean, bodyObject);</span>
<span class="nc" id="L381">        } catch (InvocationTargetException e) {</span>
<span class="nc" id="L382">            throw e;</span>
<span class="nc" id="L383">        } catch (Throwable t) {</span>
<span class="nc" id="L384">            throw t;</span>
<span class="nc" id="L385">        }</span>
<span class="nc" id="L386">        return result;</span>
    }

    private Object invokeDeleteMethod(ApiMethod api, Object bean,
            Properties parameters) throws Throwable {
<span class="nc" id="L391">        Class[] parameterTypes = new Class[]{Properties.class};</span>
<span class="nc" id="L392">        Class beanClass = bean.getClass();</span>
<span class="nc" id="L393">        String methodName = api.getSpringBeanMethod();</span>
<span class="nc" id="L394">        Method method = beanClass.getDeclaredMethod(methodName, parameterTypes);</span>
<span class="nc" id="L395">        return method.invoke(bean, parameters);</span>
    }

    protected IApiCatalogManager getApiCatalogManager() {
<span class="nc" id="L399">        return _apiCatalogManager;</span>
    }

    public void setApiCatalogManager(IApiCatalogManager apiCatalogManager) {
<span class="nc" id="L403">        this._apiCatalogManager = apiCatalogManager;</span>
<span class="nc" id="L404">    }</span>

    protected IVelocityRenderer getVelocityRenderer() {
<span class="nc" id="L407">        return _velocityRenderer;</span>
    }

    public void setVelocityRenderer(IVelocityRenderer velocityRenderer) {
<span class="nc" id="L411">        this._velocityRenderer = velocityRenderer;</span>
<span class="nc" id="L412">    }</span>

    protected BeanFactory getBeanFactory() {
<span class="nc" id="L415">        return this._beanFactory;</span>
    }

    @Override
    public void setBeanFactory(BeanFactory beanFactory) throws BeansException {
<span class="nc" id="L420">        this._beanFactory = beanFactory;</span>
<span class="nc" id="L421">    }</span>

    protected ServletContext getServletContext() {
<span class="nc" id="L424">        return this._servletContext;</span>
    }

    @Override
    public void setServletContext(ServletContext servletContext) {
<span class="nc" id="L429">        this._servletContext = servletContext;</span>
<span class="nc" id="L430">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>