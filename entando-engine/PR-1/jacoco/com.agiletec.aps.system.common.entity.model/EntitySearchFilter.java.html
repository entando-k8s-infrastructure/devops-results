<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EntitySearchFilter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Entando Core: Engine</a> &gt; <a href="index.source.html" class="el_package">com.agiletec.aps.system.common.entity.model</a> &gt; <span class="el_source">EntitySearchFilter.java</span></div><h1>EntitySearchFilter.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2015-Present Entando Inc. (http://www.entando.com) All rights reserved.
 *
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 */

package com.agiletec.aps.system.common.entity.model;

import com.agiletec.aps.system.common.FieldSearchFilter;
import com.agiletec.aps.system.common.entity.model.attribute.AttributeInterface;
import com.agiletec.aps.system.common.entity.model.attribute.BooleanAttribute;
import com.agiletec.aps.system.common.entity.model.attribute.DateAttribute;
import com.agiletec.aps.system.common.entity.model.attribute.ITextAttribute;
import com.agiletec.aps.system.common.entity.model.attribute.NumberAttribute;
import com.agiletec.aps.system.exception.ApsSystemException;
import com.agiletec.aps.util.DateConverter;
import java.io.Serializable;
import java.math.BigDecimal;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.List;
import java.util.Properties;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * This class implements a filter to search among entities.
 *
 * @author E.Santoboni
 */
public class EntitySearchFilter&lt;T&gt; extends FieldSearchFilter implements Serializable {

    public static final String SEPARATOR = &quot;;&quot;;
    public static final String KEY_PARAM = &quot;key&quot;;
    public static final String ROLE_PARAM = &quot;role&quot;;
    public static final String FILTER_TYPE_PARAM = &quot;attributeFilter&quot;;
    public static final String VALUE_PARAM = &quot;value&quot;;
    public static final String ALLOWED_VALUES_PARAM = &quot;allowedValues&quot;;
    public static final String ALLOWED_VALUES_SEPARATOR = &quot;,&quot;;
    public static final String LIKE_OPTION_PARAM = &quot;likeOption&quot;;
    public static final String LIKE_OPTION_TYPE_PARAM = &quot;likeOptionType&quot;;
    public static final String LANG_PARAM = &quot;lang&quot;;
    public static final String START_PARAM = &quot;start&quot;;
    public static final String END_PARAM = &quot;end&quot;;
    public static final String ORDER_PARAM = &quot;order&quot;;
    public static final String DATA_TYPE_PARAM = &quot;dataType&quot;;
    public static final String NULL_VALUE_PARAM = &quot;nullValue&quot;;
    public static final String DATA_TYPE_STRING = &quot;string&quot;;
    public static final String DATA_TYPE_DATE = &quot;date&quot;;
    public static final String DATA_TYPE_NUMBER = &quot;number&quot;;
    public static final String DATE_PATTERN = &quot;dd/MM/yyyy&quot;;
    public static final String START_DATE_DELAY_PARAM = &quot;startDateDelay&quot;;
    public static final String END_DATE_DELAY_PARAM = &quot;endDateDelay&quot;;
    public static final String VALUE_DATE_DELAY_PARAM = &quot;valueDateDelay&quot;;
<span class="fc" id="L66">    private static final Logger _logger = LoggerFactory.getLogger(EntitySearchFilter.class);</span>
    private boolean _attributeFilter;
    private String _langCode;
    private String _roleName;

<span class="fc" id="L71">    protected EntitySearchFilter() {</span>
<span class="fc" id="L72">    }</span>

    public EntitySearchFilter(Integer limit, Integer offset) {
<span class="nc" id="L75">        super(limit, offset);</span>
<span class="nc" id="L76">    }</span>

    /**
     * Filter constructor. This constructor is used when checking the presence of a value contained either in the attribute field or in the
     * entity metadata.
     *
     * @param key The key of the filtering element; it may be a content attribute of type {@link AttributeInterface} or the ID of
     * metadata).
     * @param isAttributeFilter Decide whether the filter is applied to an Entity Attribute (true) or to a metadata (false).
     */
    public EntitySearchFilter(String key, boolean isAttributeFilter) {
<span class="fc" id="L87">        super(key);</span>
<span class="fc" id="L88">        this.setAttributeFilter(isAttributeFilter);</span>
<span class="fc" id="L89">    }</span>

    /**
     * Filter constructor. This constructor must be used to filter the attribute values or entity metadata looking for a specific value.
     *
     * @param key The key of the filtering element; it may be a content attribute of type {@link AttributeInterface} or the ID of
     * metadata).
     * @param isAttributeFilter Decide whether the filter is applied to an Entity Attribute (true) or to a metadata (false).
     * @param value The value to look for. If null, the filter checks if the attribute (or metadata) has been valued.
     * @param useLikeOption When true the database search will be performed using the &quot;LIKE&quot; clause. This option can be used to filter by
     * the value of a string attribute (or metadata). It can be used only with string and with not null values.
     */
    public EntitySearchFilter(String key, boolean isAttributeFilter, T value, boolean useLikeOption) {
<span class="fc" id="L102">        this(key, isAttributeFilter);</span>
<span class="pc bpc" id="L103" title="4 of 6 branches missed.">        if (null != value &amp;&amp; value instanceof Collection &amp;&amp; ((Collection) value).size() &gt; 0) {</span>
<span class="nc" id="L104">            List&lt;T&gt; allowedValues = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L105">            allowedValues.addAll((Collection) value);</span>
<span class="nc" id="L106">            this.setAllowedValues(allowedValues);</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">            if (allowedValues.get(0) instanceof String) {</span>
<span class="nc" id="L108">                this.setLikeOption(useLikeOption);</span>
            }
<span class="nc" id="L110">        } else {</span>
<span class="fc" id="L111">            this.setValue(value);</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">            if (value instanceof String) {</span>
<span class="fc" id="L113">                this.setLikeOption(useLikeOption);</span>
            }
        }
<span class="fc" id="L116">    }</span>

    public EntitySearchFilter(String key, boolean isAttributeFilter, T value, boolean useLikeOption, LikeOptionType likeOptionType) {
<span class="fc" id="L119">        this(key, isAttributeFilter, value, useLikeOption);</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">        if (this.isLikeOption()) {</span>
<span class="fc" id="L121">            this.setLikeOptionType(likeOptionType);</span>
        }
<span class="fc" id="L123">    }</span>

    /**
     * Filter constructor. This constructor is used when filtering by a range of values; this can applied to both Entity Attributes and
     * metadata).
     *
     * @param key The key of the filtering element; it may be a content attribute of type {@link AttributeInterface} or the ID of
     * metadata).
     * @param isAttributeFilter Decide whether the filter is applied to an Entity Attribute (true) or to a metadata (false).
     * @param start The starting value of the interval. It can be an object of type &quot;String&quot;, &quot;Date&quot;, &quot;BigDecimal&quot;, &quot;Boolean&quot; o null.
     * @param end The ending value of the interval. It can be an object of type &quot;String&quot;, &quot;Date&quot;, &quot;BigDecimal&quot;, &quot;Boolean&quot; o null.
     */
    public EntitySearchFilter(String key, boolean isAttributeFilter, T start, T end) {
<span class="fc" id="L136">        this(key, isAttributeFilter);</span>
<span class="pc bpc" id="L137" title="1 of 6 branches missed.">        if (start != null &amp;&amp; end != null &amp;&amp; !start.getClass().equals(end.getClass())) {</span>
<span class="nc" id="L138">            throw new RuntimeException(&quot;Error: 'start' and 'end' types have to be equals&quot;);</span>
        }
<span class="fc" id="L140">        this.setStart(start);</span>
<span class="fc" id="L141">        this.setEnd(end);</span>
<span class="fc" id="L142">    }</span>

    /**
     * Filter constructor. This constructor is used when filtering by a collection of allowed values; this can applied to both Entity
     * Attributes and metadata).
     *
     * @param key The key of the filtering element; it may be a content attribute of type {@link AttributeInterface} or the ID of
     * metadata).
     * @param isAttributeFilter Decide whether the filter is applied to an Entity Attribute (true) or to a metadata (false).
     * @param allowedValues The allowed values to look for. If null, the filter checks if the attribute (or metadata) has been valued.
     * @param useLikeOption When true the database search will be performed using the &quot;LIKE&quot; clause. This option can be used to filter by
     * the value of a string attribute (or metadata). It can be used only with string and with allowed values not null.
     */
    public EntitySearchFilter(String key, boolean isAttributeFilter, List&lt;T&gt; allowedValues, boolean useLikeOption) {
<span class="fc" id="L156">        this(key, isAttributeFilter);</span>
<span class="fc" id="L157">        this.setAllowedValues(allowedValues);</span>
<span class="fc" id="L158">        this.setLikeOption(useLikeOption);</span>
<span class="fc" id="L159">    }</span>

    public EntitySearchFilter(String key, boolean isAttributeFilter, List&lt;T&gt; allowedValues, boolean useLikeOption,
            LikeOptionType likeOptionType) {
<span class="nc" id="L163">        this(key, isAttributeFilter, allowedValues, useLikeOption);</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (this.isLikeOption()) {</span>
<span class="nc" id="L165">            this.setLikeOptionType(likeOptionType);</span>
        }
<span class="nc" id="L167">    }</span>

    public static EntitySearchFilter createRoleFilter(String roleName) {
<span class="fc" id="L170">        EntitySearchFilter filter = new EntitySearchFilter();</span>
<span class="fc" id="L171">        filter.setAttributeFilter(true);</span>
<span class="fc" id="L172">        filter.setRoleName(roleName);</span>
<span class="fc" id="L173">        return filter;</span>
    }

    public static &lt;T&gt; EntitySearchFilter createRoleFilter(String roleName, T value, boolean useLikeOption) {
<span class="fc" id="L177">        EntitySearchFilter filter = new EntitySearchFilter();</span>
<span class="fc" id="L178">        filter.setAttributeFilter(true);</span>
<span class="fc" id="L179">        filter.setRoleName(roleName);</span>
<span class="pc bpc" id="L180" title="4 of 6 branches missed.">        if (null != value &amp;&amp; value instanceof Collection &amp;&amp; ((Collection) value).size() &gt; 0) {</span>
<span class="nc" id="L181">            List&lt;T&gt; allowedValues = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L182">            allowedValues.addAll((Collection) value);</span>
<span class="nc" id="L183">            filter.setAllowedValues(allowedValues);</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">            if (allowedValues.get(0) instanceof String) {</span>
<span class="nc" id="L185">                filter.setLikeOption(useLikeOption);</span>
            }
<span class="nc" id="L187">        } else {</span>
<span class="fc" id="L188">            filter.setValue(value);</span>
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">            if (value instanceof String) {</span>
<span class="fc" id="L190">                filter.setLikeOption(useLikeOption);</span>
            }
        }
<span class="fc" id="L193">        return filter;</span>
    }

    public static &lt;T&gt; EntitySearchFilter createRoleFilter(String roleName, T value, boolean useLikeOption, LikeOptionType likeOptionType) {
<span class="nc" id="L197">        EntitySearchFilter filter = EntitySearchFilter.createRoleFilter(roleName, value, useLikeOption);</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">        if (filter.isLikeOption()) {</span>
<span class="nc" id="L199">            filter.setLikeOptionType(likeOptionType);</span>
        }
<span class="nc" id="L201">        return filter;</span>
    }

    public static &lt;T&gt; EntitySearchFilter createRoleFilter(String roleName, T start, T end) {
<span class="fc" id="L205">        EntitySearchFilter filter = new EntitySearchFilter();</span>
<span class="fc" id="L206">        filter.setAttributeFilter(true);</span>
<span class="fc" id="L207">        filter.setRoleName(roleName);</span>
<span class="pc bpc" id="L208" title="3 of 6 branches missed.">        if (start != null &amp;&amp; end != null &amp;&amp; !start.getClass().equals(end.getClass())) {</span>
<span class="nc" id="L209">            throw new RuntimeException(&quot;Error: 'start' and 'end' types have to be equals&quot;);</span>
        }
<span class="fc" id="L211">        filter.setStart(start);</span>
<span class="fc" id="L212">        filter.setEnd(end);</span>
<span class="fc" id="L213">        return filter;</span>
    }

    public static &lt;T&gt; EntitySearchFilter createRoleFilter(String roleName, List&lt;T&gt; allowedValues, boolean useLikeOption) {
<span class="fc" id="L217">        EntitySearchFilter filter = new EntitySearchFilter();</span>
<span class="fc" id="L218">        filter.setAttributeFilter(true);</span>
<span class="fc" id="L219">        filter.setRoleName(roleName);</span>
<span class="fc" id="L220">        filter.setAllowedValues(allowedValues);</span>
<span class="fc" id="L221">        filter.setLikeOption(useLikeOption);</span>
<span class="fc" id="L222">        return filter;</span>
    }

    public static &lt;T&gt; EntitySearchFilter createRoleFilter(String roleName, List&lt;T&gt; allowedValues, boolean useLikeOption,
            LikeOptionType likeOptionType) {
<span class="nc" id="L227">        EntitySearchFilter filter = EntitySearchFilter.createRoleFilter(roleName, allowedValues, useLikeOption);</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">        if (filter.isLikeOption()) {</span>
<span class="nc" id="L229">            filter.setLikeOptionType(likeOptionType);</span>
        }
<span class="nc" id="L231">        return filter;</span>
    }

    @Deprecated
    public static EntitySearchFilter getInstance(IApsEntity prototype, String toStringFilter) {
<span class="nc" id="L236">        return getInstance(prototype, getProperties(toStringFilter));</span>
    }

    @Deprecated
    public static Properties getProperties(String toStringFilter) {
<span class="nc" id="L241">        Properties props = new Properties();</span>
<span class="nc" id="L242">        String[] params = toStringFilter.split(SEPARATOR);</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">        for (int i = 0; i &lt; params.length; i++) {</span>
<span class="nc" id="L244">            String[] elements = params[i].split(&quot;=&quot;);</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">            if (elements.length != 2) {</span>
<span class="nc" id="L246">                continue;</span>
            }
<span class="nc" id="L248">            props.setProperty(elements[0], elements[1]);</span>
        }
<span class="nc" id="L250">        return props;</span>
    }

    public static EntitySearchFilter getInstance(IApsEntity prototype, Properties props) {
<span class="fc" id="L254">        EntitySearchFilter filter = null;</span>
        try {
<span class="fc" id="L256">            String key = props.getProperty(KEY_PARAM);</span>
<span class="fc" id="L257">            String roleName = props.getProperty(ROLE_PARAM);</span>
<span class="pc bpc" id="L258" title="3 of 4 branches missed.">            if (null == key &amp;&amp; null == roleName) {</span>
<span class="nc" id="L259">                return null;</span>
            }
<span class="fc" id="L261">            boolean isAttributeFilter = Boolean.parseBoolean(props.getProperty(FILTER_TYPE_PARAM));</span>
<span class="fc" id="L262">            filter = new EntitySearchFilter();</span>
<span class="fc" id="L263">            boolean isDateAttribute = false;</span>
<span class="fc bfc" id="L264" title="All 2 branches covered.">            if (!isAttributeFilter) {</span>
<span class="fc" id="L265">                filter.setKey(key);</span>
<span class="fc" id="L266">                String dataType = props.getProperty(DATA_TYPE_PARAM);</span>
<span class="pc bpc" id="L267" title="1 of 2 branches missed.">                if (null == dataType) {</span>
<span class="fc" id="L268">                    dataType = DATA_TYPE_STRING;</span>
                }
<span class="fc" id="L270">                setValues(filter, props, dataType);</span>
<span class="fc" id="L271">            } else {</span>
<span class="fc" id="L272">                AttributeInterface attr = null;</span>
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">                if (null != key) {</span>
<span class="fc" id="L274">                    attr = prototype.getAttribute(key);</span>
<span class="fc" id="L275">                    filter.setKey(key);</span>
                } else {
<span class="nc" id="L277">                    attr = prototype.getAttributeByRole(roleName);</span>
<span class="nc" id="L278">                    filter.setRoleName(roleName);</span>
                }
<span class="fc" id="L280">                filter.setAttributeFilter(true);</span>
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">                if (null != attr) {</span>
<span class="fc" id="L282">                    String dataType = null;</span>
<span class="fc bfc" id="L283" title="All 2 branches covered.">                    if (attr instanceof DateAttribute) {</span>
<span class="fc" id="L284">                        dataType = DATA_TYPE_DATE;</span>
<span class="fc" id="L285">                        isDateAttribute = true;</span>
<span class="pc bpc" id="L286" title="3 of 4 branches missed.">                    } else if (attr instanceof ITextAttribute || attr instanceof BooleanAttribute) {</span>
<span class="fc" id="L287">                        dataType = DATA_TYPE_STRING;</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">                    } else if (attr instanceof NumberAttribute) {</span>
<span class="nc" id="L289">                        dataType = DATA_TYPE_NUMBER;</span>
                    }
<span class="fc" id="L291">                    setValues(filter, props, dataType);</span>
<span class="fc" id="L292">                } else {</span>
<span class="nc" id="L293">                    throw new ApsSystemException(&quot;ERROR: Entity type '&quot; + prototype.getTypeCode()</span>
                            + &quot;' and attribute '&quot; + key + &quot;' not recognized&quot;);
                }
            }
<span class="fc bfc" id="L297" title="All 2 branches covered.">            if (isDateAttribute) {</span>
<span class="fc" id="L298">                String valueDateDelay = props.getProperty(EntitySearchFilter.VALUE_DATE_DELAY_PARAM);</span>
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">                filter.setValueDateDelay(null != valueDateDelay ? Integer.valueOf(valueDateDelay) : null);</span>

<span class="fc" id="L301">                String endDateDelay = props.getProperty(EntitySearchFilter.END_DATE_DELAY_PARAM);</span>
<span class="pc bpc" id="L302" title="1 of 2 branches missed.">                filter.setEndDateDelay(null != endDateDelay ? Integer.valueOf(endDateDelay) : null);</span>

<span class="fc" id="L304">                String startDateDelay = props.getProperty(EntitySearchFilter.START_DATE_DELAY_PARAM);</span>
<span class="pc bpc" id="L305" title="1 of 2 branches missed.">                filter.setStartDateDelay(null != startDateDelay ? Integer.valueOf(startDateDelay) : null);</span>
            }
<span class="fc" id="L307">            String order = props.getProperty(EntitySearchFilter.ORDER_PARAM);</span>
<span class="fc" id="L308">            filter.setOrder(order);</span>
<span class="nc" id="L309">        } catch (ApsSystemException | NumberFormatException t) {</span>
<span class="nc" id="L310">            _logger.error(&quot;Error on creation of filter instance&quot;, t);</span>
<span class="nc" id="L311">            throw new RuntimeException(&quot;Error on creation of filter instance&quot;, t);</span>
<span class="fc" id="L312">        }</span>
<span class="fc" id="L313">        return filter;</span>
    }

    private static void setValues(EntitySearchFilter filter, Properties props, String dataType) {
<span class="pc bpc" id="L317" title="1 of 2 branches missed.">        if (null == dataType) {</span>
<span class="nc" id="L318">            return;</span>
        }
<span class="fc" id="L320">        String value = props.getProperty(VALUE_PARAM);</span>
<span class="fc" id="L321">        String allowedValues = props.getProperty(ALLOWED_VALUES_PARAM);</span>
<span class="fc" id="L322">        String start = props.getProperty(START_PARAM);</span>
<span class="fc" id="L323">        String end = props.getProperty(END_PARAM);</span>
<span class="fc" id="L324">        Object objectValue = getDataObject(value, dataType);</span>
<span class="fc" id="L325">        List&lt;Object&gt; objectAllowedValues = buildAllowedValues(allowedValues, dataType);</span>
<span class="fc" id="L326">        Object objectStart = getDataObject(start, dataType);</span>
<span class="fc" id="L327">        Object objectEnd = getDataObject(end, dataType);</span>
<span class="fc" id="L328">        String likeOptionString = props.getProperty(LIKE_OPTION_PARAM);</span>
<span class="pc bpc" id="L329" title="3 of 4 branches missed.">        boolean likeOption = (null != likeOptionString) &amp;&amp; Boolean.parseBoolean(likeOptionString);</span>
<span class="fc" id="L330">        String likeOptionTypeString = props.getProperty(LIKE_OPTION_TYPE_PARAM);</span>
<span class="fc" id="L331">        LikeOptionType likeOptionType = LikeOptionType.COMPLETE;</span>
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">        if (null != likeOptionTypeString) {</span>
            try {
<span class="nc" id="L334">                likeOptionType = Enum.valueOf(LikeOptionType.class, likeOptionTypeString.trim().toUpperCase());</span>
<span class="nc" id="L335">            } catch (Throwable t) {</span>
<span class="nc" id="L336">                _logger.error(&quot;Error parsing 'like option type' parameter&quot;, t);</span>
<span class="nc" id="L337">            }</span>
        }
<span class="fc bfc" id="L339" title="All 2 branches covered.">        if (objectValue != null) {</span>
<span class="fc" id="L340">            filter.setValue(objectValue);</span>
<span class="fc" id="L341">            filter.setLikeOption(likeOption);</span>
<span class="pc bpc" id="L342" title="1 of 2 branches missed.">            if (filter.isLikeOption()) {</span>
<span class="nc" id="L343">                filter.setLikeOptionType(likeOptionType);</span>
            }
<span class="pc bpc" id="L345" title="1 of 2 branches missed.">        } else if (objectAllowedValues != null) {</span>
<span class="nc" id="L346">            filter.setAllowedValues(objectAllowedValues);</span>
<span class="nc" id="L347">            filter.setLikeOption(likeOption);</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">            if (filter.isLikeOption()) {</span>
<span class="nc" id="L349">                filter.setLikeOptionType(likeOptionType);</span>
            }
<span class="pc bpc" id="L351" title="1 of 4 branches missed.">        } else if ((null != objectStart) || (null != objectEnd)) {</span>
<span class="fc" id="L352">            filter.setStart(objectStart);</span>
<span class="fc" id="L353">            filter.setEnd(objectEnd);</span>
        } else {
<span class="fc" id="L355">            String nullValue = props.getProperty(NULL_VALUE_PARAM);</span>
<span class="pc bpc" id="L356" title="3 of 4 branches missed.">            boolean nullOption = (null != nullValue &amp;&amp; nullValue.equalsIgnoreCase(&quot;true&quot;));</span>
<span class="fc" id="L357">            filter.setNullOption(nullOption);</span>
        }
<span class="fc" id="L359">        String langCode = props.getProperty(LANG_PARAM);</span>
<span class="fc" id="L360">        filter.setLangCode(langCode);</span>
<span class="fc" id="L361">    }</span>

    private static List&lt;Object&gt; buildAllowedValues(String allowedValues, String dataType) {
<span class="pc bpc" id="L364" title="1 of 2 branches missed.">        if (null == allowedValues) {</span>
<span class="fc" id="L365">            return null;</span>
        }
<span class="nc" id="L367">        List&lt;Object&gt; values = null;</span>
<span class="nc" id="L368">        String[] stringValues = allowedValues.split(ALLOWED_VALUES_SEPARATOR);</span>
<span class="nc bnc" id="L369" title="All 4 branches missed.">        if (null != stringValues &amp;&amp; stringValues.length &gt; 0) {</span>
<span class="nc" id="L370">            values = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">            for (int i = 0; i &lt; stringValues.length; i++) {</span>
<span class="nc" id="L372">                String stringValue = stringValues[i];</span>
<span class="nc" id="L373">                Object object = getDataObject(stringValue, dataType);</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">                if (null != object) {</span>
<span class="nc" id="L375">                    values.add(object);</span>
                }
            }
        }
<span class="nc bnc" id="L379" title="All 4 branches missed.">        if (null == values || values.isEmpty()) {</span>
<span class="nc" id="L380">            return null;</span>
        }
<span class="nc" id="L382">        return values;</span>
    }

    private static Object getDataObject(String stringValue, String dataType) {
<span class="fc bfc" id="L386" title="All 2 branches covered.">        if (null == stringValue) {</span>
<span class="fc" id="L387">            return null;</span>
        }
<span class="fc" id="L389">        Object object = null;</span>
<span class="fc bfc" id="L390" title="All 2 branches covered.">        if (dataType.equals(DATA_TYPE_DATE)) {</span>
<span class="fc" id="L391">            object = buildDate(stringValue);</span>
<span class="pc bpc" id="L392" title="1 of 2 branches missed.">        } else if (dataType.equals(DATA_TYPE_STRING)) {</span>
<span class="fc" id="L393">            object = stringValue;</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">        } else if (dataType.equals(DATA_TYPE_NUMBER)) {</span>
<span class="nc" id="L395">            object = buildNumber(stringValue);</span>
        }
<span class="fc" id="L397">        return object;</span>
    }

    private static Date buildDate(String dateString) {
<span class="fc" id="L401">        String today = &quot;today, oggi, odierna&quot;;</span>
<span class="fc" id="L402">        Date data = null;</span>
        try {
<span class="pc bpc" id="L404" title="1 of 2 branches missed.">            if (today.contains(dateString)) {</span>
<span class="nc" id="L405">                data = new java.util.Date();</span>
            } else {
<span class="fc" id="L407">                SimpleDateFormat dataF = new SimpleDateFormat(EntitySearchFilter.DATE_PATTERN);</span>
<span class="fc" id="L408">                data = dataF.parse(dateString);</span>
            }
<span class="nc" id="L410">        } catch (ParseException ex) {</span>
<span class="nc" id="L411">            _logger.error(&quot;Invalid string - '{}'&quot;, dateString);</span>
<span class="fc" id="L412">        }</span>
<span class="fc" id="L413">        return data;</span>
    }

    private static BigDecimal buildNumber(String numberString) {
<span class="nc" id="L417">        BigDecimal number = null;</span>
        try {
<span class="nc" id="L419">            number = new BigDecimal(numberString);</span>
<span class="nc" id="L420">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L421">            _logger.error(&quot;Invalid string - '{}'&quot;, numberString);</span>
<span class="nc" id="L422">        }</span>
<span class="nc" id="L423">        return number;</span>
    }

    /**
     * This method shows if the filter must be applied on a Entity Attribute or a metadata.
     *
     * @return true if the filter is to be applied to an attribute entity or a to a metadata of the an entity.
     */
    public boolean isAttributeFilter() {
<span class="fc" id="L432">        return _attributeFilter;</span>
    }

    protected void setAttributeFilter(boolean attributeFilter) {
<span class="fc" id="L436">        this._attributeFilter = attributeFilter;</span>
<span class="fc" id="L437">    }</span>

    public String getRoleName() {
<span class="fc" id="L440">        return _roleName;</span>
    }

    protected void setRoleName(String roleName) {
<span class="fc" id="L444">        this._roleName = roleName;</span>
<span class="fc" id="L445">    }</span>

    public String getLangCode() {
<span class="fc" id="L448">        return this._langCode;</span>
    }

    public void setLangCode(String langCode) {
<span class="fc bfc" id="L452" title="All 2 branches covered.">        if (null == langCode) {</span>
<span class="fc" id="L453">            return;</span>
        }
<span class="pc bpc" id="L455" title="1 of 2 branches missed.">        if (!this.isAttributeFilter()) {</span>
<span class="nc" id="L456">            throw new RuntimeException(&quot;Error: The language can be only specified on attribute filters&quot;);</span>
        }
<span class="pc bpc" id="L458" title="1 of 4 branches missed.">        if ((null != this.getValue() &amp;&amp; !(this.getValue() instanceof String))</span>
<span class="pc bpc" id="L459" title="1 of 4 branches missed.">                || (null != this.getStart() &amp;&amp; !(this.getStart() instanceof String))</span>
<span class="pc bpc" id="L460" title="1 of 4 branches missed.">                || (null != this.getEnd() &amp;&amp; !(this.getEnd() instanceof String))</span>
<span class="pc bpc" id="L461" title="1 of 4 branches missed.">                || (this.getAllowedValues() != null &amp;&amp; !this.getAllowedValues().isEmpty() &amp;&amp; !(this.getAllowedValues()</span>
<span class="pc bpc" id="L462" title="1 of 2 branches missed.">                .get(0) instanceof String))) {</span>
<span class="nc" id="L463">            throw new RuntimeException(&quot;Error: The language can be only specified on a null value of type string&quot;);</span>
        }
<span class="fc" id="L465">        this._langCode = langCode;</span>
<span class="fc" id="L466">    }</span>

    @Override
    public void setNullOption(boolean nullOption) {
<span class="pc bpc" id="L470" title="3 of 4 branches missed.">        if (null == this.getKey() &amp;&amp; null != this.getRoleName()) {</span>
<span class="nc" id="L471">            throw new RuntimeException(&quot;Error: the NULL cluase may be used only in conjunction with not null key&quot;);</span>
        }
<span class="fc" id="L473">        super.setNullOption(nullOption);</span>
<span class="fc" id="L474">    }</span>

    @Override
    public String toString() {
<span class="nc" id="L478">        StringBuffer param = new StringBuffer();</span>
<span class="nc bnc" id="L479" title="All 2 branches missed.">        if (null != this.getKey()) {</span>
<span class="nc" id="L480">            param.append(KEY_PARAM).append(&quot;=&quot;).append(this.getKey()).append(SEPARATOR);</span>
        }
<span class="nc" id="L482">        this.appendParamValue(param, this.getRoleName(), ROLE_PARAM);</span>
<span class="nc" id="L483">        param.append(FILTER_TYPE_PARAM).append(&quot;=&quot;).append(this.isAttributeFilter());</span>
<span class="nc" id="L484">        this.appendParamValue(param, this.getValue(), VALUE_PARAM);</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">        if (this.getValue() instanceof String) {</span>
<span class="nc" id="L486">            this.appendParamValue(param, this.isLikeOption(), LIKE_OPTION_PARAM);</span>
        }
<span class="nc bnc" id="L488" title="All 4 branches missed.">        if (null != this.getAllowedValues() &amp;&amp; !this.getAllowedValues().isEmpty()) {</span>
<span class="nc" id="L489">            this.appendParamValue(param, this.getAllowedValues(), ALLOWED_VALUES_PARAM);</span>
        }
<span class="nc" id="L491">        this.appendParamValue(param, this.getLangCode(), LANG_PARAM);</span>
<span class="nc" id="L492">        this.appendParamValue(param, this.getStart(), START_PARAM);</span>
<span class="nc" id="L493">        this.appendParamValue(param, this.getEnd(), END_PARAM);</span>
<span class="nc" id="L494">        this.appendParamValue(param, this.getOrder(), ORDER_PARAM);</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">        if (null != this.getValueDateDelay()) {</span>
<span class="nc" id="L496">            this.appendParamValue(param, this.getValueDateDelay(), VALUE_DATE_DELAY_PARAM);</span>
        }
<span class="nc bnc" id="L498" title="All 2 branches missed.">        if (null != this.getStartDateDelay()) {</span>
<span class="nc" id="L499">            this.appendParamValue(param, this.getStartDateDelay(), START_DATE_DELAY_PARAM);</span>
        }
<span class="nc bnc" id="L501" title="All 2 branches missed.">        if (null != this.getEndDateDelay()) {</span>
<span class="nc" id="L502">            this.appendParamValue(param, this.getEndDateDelay(), END_DATE_DELAY_PARAM);</span>
        }
<span class="nc bnc" id="L504" title="All 2 branches missed.">        if (this.isNullOption()) {</span>
<span class="nc" id="L505">            this.appendParamValue(param, this.isNullOption(), NULL_VALUE_PARAM);</span>
        }
<span class="nc" id="L507">        return param.toString();</span>
    }

    private void appendParamValue(StringBuffer param, Object value, String paramValue) {
<span class="nc bnc" id="L511" title="All 2 branches missed.">        if (null != value) {</span>
<span class="nc" id="L512">            param.append(SEPARATOR).append(paramValue).append(&quot;=&quot;);</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">            if (value instanceof List) {</span>
<span class="nc" id="L514">                List&lt;Object&gt; values = (List&lt;Object&gt;) value;</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">                for (int i = 0; i &lt; values.size(); i++) {</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">                    if (i &gt; 0) {</span>
<span class="nc" id="L517">                        param.append(ALLOWED_VALUES_SEPARATOR);</span>
                    }
<span class="nc" id="L519">                    param.append(values.get(i));</span>
                }
<span class="nc" id="L521">            } else {</span>
<span class="nc" id="L522">                param.append(this.getToStringValue(value));</span>
            }
        }
<span class="nc" id="L525">    }</span>

    private String getToStringValue(Object value) {
<span class="nc bnc" id="L528" title="All 2 branches missed.">        if (value instanceof String) {</span>
<span class="nc" id="L529">            return value.toString();</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">        } else if (value instanceof Date) {</span>
<span class="nc" id="L531">            return DateConverter.getFormattedDate((Date) value, DATE_PATTERN);</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">        } else if (value instanceof BigDecimal) {</span>
<span class="nc" id="L533">            value = value.toString();</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">        } else if (value instanceof Boolean) {</span>
<span class="nc" id="L535">            value = ((Boolean) value).toString();</span>
        }
<span class="nc" id="L537">        return value.toString();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>