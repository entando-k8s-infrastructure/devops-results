<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InternalServletTag.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Entando Core: Engine</a> &gt; <a href="index.source.html" class="el_package">com.agiletec.aps.tags</a> &gt; <span class="el_source">InternalServletTag.java</span></div><h1>InternalServletTag.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2015-Present Entando Inc. (http://www.entando.com) All rights reserved.
 *
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 */

package com.agiletec.aps.tags;

import com.agiletec.aps.system.RequestContext;
import com.agiletec.aps.system.SystemConstants;
import com.agiletec.aps.system.services.page.IPage;
import com.agiletec.aps.system.services.page.Widget;
import com.agiletec.aps.util.ApsProperties;
import java.io.CharArrayWriter;
import java.io.IOException;
import java.io.PrintWriter;
import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpServletResponseWrapper;
import javax.servlet.jsp.JspException;
import javax.servlet.jsp.tagext.TagSupport;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Tag for widget &quot;InternalServlet&quot;. Publish a function erogated throw a internal Servlet; the servlet is invoked by a path specificated by
 * the tag attribute &quot;actionPath&quot; or by the widget parameter of the same name.
 *
 * @author M.Casari - E.Santoboni
 */
<span class="nc" id="L43">public class InternalServletTag extends TagSupport {</span>

    public static final String CONFIG_PARAM_ACTIONPATH = &quot;actionPath&quot;;
    public static final String REQUEST_PARAM_ACTIONPATH = &quot;internalServletActionPath&quot;;
    public static final String REQUEST_PARAM_FRAMEDEST = &quot;internalServletFrameDest&quot;;
    public static final String EXTRAPAR_STATIC_ACTION = &quot;internalServletStaticAction&quot;;
<span class="nc" id="L49">    private static final Logger _logger = LoggerFactory.getLogger(InternalServletTag.class);</span>
    private String _actionPath;
    private boolean _staticAction;

    /**
     * Invokes the widget configured in the current page.
     *
     * @throws JspException in case of error that occurred in both this method or in one of the included JSPs
     */
    @Override
    public int doEndTag() throws JspException {
<span class="nc" id="L60">        int result = super.doEndTag();</span>
<span class="nc" id="L61">        ServletRequest req = this.pageContext.getRequest();</span>
<span class="nc" id="L62">        RequestContext reqCtx = (RequestContext) req.getAttribute(RequestContext.REQCTX);</span>
        try {
<span class="nc" id="L64">            IPage page = (IPage) reqCtx.getExtraParam(SystemConstants.EXTRAPAR_CURRENT_PAGE);</span>
<span class="nc" id="L65">            ResponseWrapper responseWrapper = new ResponseWrapper((HttpServletResponse) this.pageContext.getResponse());</span>
<span class="nc" id="L66">            String output = this.buildWidgetOutput(page, responseWrapper);</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">            if (responseWrapper.isRedirected()) {</span>
<span class="nc" id="L68">                String redirect = responseWrapper.getRedirectPath();</span>
<span class="nc" id="L69">                reqCtx.addExtraParam(SystemConstants.EXTRAPAR_EXTERNAL_REDIRECT, redirect);</span>
<span class="nc" id="L70">                result = SKIP_PAGE;</span>
<span class="nc" id="L71">            } else {</span>
<span class="nc" id="L72">                this.pageContext.getOut().print(output);</span>
            }
<span class="nc" id="L74">        } catch (Throwable t) {</span>
<span class="nc" id="L75">            _logger.error(&quot;Error in widget preprocessing&quot;, t);</span>
<span class="nc" id="L76">            String msg = &quot;Error in widget preprocessing&quot;;</span>
<span class="nc" id="L77">            throw new JspException(msg, t);</span>
<span class="nc" id="L78">        }</span>
<span class="nc" id="L79">        return result;</span>
    }

    protected String buildWidgetOutput(IPage page, ResponseWrapper responseWrapper) throws JspException {
<span class="nc" id="L83">        String output = null;</span>
<span class="nc" id="L84">        ServletRequest req = this.pageContext.getRequest();</span>
<span class="nc" id="L85">        RequestContext reqCtx = (RequestContext) req.getAttribute(RequestContext.REQCTX);</span>
        try {
<span class="nc" id="L87">            Widget widget = (Widget) reqCtx.getExtraParam(SystemConstants.EXTRAPAR_CURRENT_WIDGET);</span>
<span class="nc" id="L88">            this.includeWidget(reqCtx, responseWrapper, widget);</span>
<span class="nc" id="L89">            Cookie[] cookies = responseWrapper.getCookiesToAdd();</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">            if (null != cookies) {</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">                for (int i = 0; i &lt; cookies.length; i++) {</span>
<span class="nc" id="L92">                    Cookie cookie = cookies[i];</span>
<span class="nc" id="L93">                    cookie.setHttpOnly(true);</span>
<span class="nc" id="L94">                    reqCtx.getResponse().addCookie(cookie);</span>
                }
            }
<span class="nc" id="L97">            output = responseWrapper.toString();</span>
<span class="nc" id="L98">            responseWrapper.getWriter().close();</span>
<span class="nc" id="L99">        } catch (Throwable t) {</span>
<span class="nc" id="L100">            String msg = &quot;Error building widget output&quot;;</span>
<span class="nc" id="L101">            throw new JspException(msg, t);</span>
<span class="nc" id="L102">        }</span>
<span class="nc" id="L103">        return output;</span>
    }

    protected void includeWidget(RequestContext reqCtx, ResponseWrapper responseWrapper, Widget widget)
            throws ServletException, IOException {
<span class="nc" id="L108">        HttpServletRequest request = reqCtx.getRequest();</span>
        try {
<span class="nc" id="L110">            String actionPath = this.extractIntroActionPath(reqCtx, widget);</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">            if (!this.isStaticAction()) {</span>
<span class="nc" id="L112">                String requestActionPath = request.getParameter(REQUEST_PARAM_ACTIONPATH);</span>
<span class="nc" id="L113">                String currentFrameActionPath = request.getParameter(REQUEST_PARAM_FRAMEDEST);</span>
<span class="nc" id="L114">                Integer currentFrame = (Integer) reqCtx.getExtraParam(SystemConstants.EXTRAPAR_CURRENT_FRAME);</span>
<span class="nc bnc" id="L115" title="All 6 branches missed.">                if (requestActionPath != null &amp;&amp; currentFrameActionPath != null &amp;&amp; currentFrame.toString().equals(currentFrameActionPath)) {</span>
<span class="nc bnc" id="L116" title="All 4 branches missed.">                    if (this.isAllowedRequestPath(requestActionPath) &amp;&amp; !this.isRecursivePath(requestActionPath, request)) {</span>
<span class="nc" id="L117">                        actionPath = requestActionPath;</span>
                    }
                }
            }
<span class="nc" id="L121">            reqCtx.addExtraParam(EXTRAPAR_STATIC_ACTION, this.isStaticAction());</span>
<span class="nc" id="L122">            RequestDispatcher requestDispatcher = request.getRequestDispatcher(actionPath);</span>
<span class="nc" id="L123">            requestDispatcher.include(request, responseWrapper);</span>
<span class="nc" id="L124">        } catch (Throwable t) {</span>
<span class="nc" id="L125">            _logger.error(&quot;Error including widget&quot;, t);</span>
<span class="nc" id="L126">            RequestDispatcher requestDispatcher = request.getRequestDispatcher(&quot;/WEB-INF/aps/jsp/system/internalServlet_error.jsp&quot;);</span>
<span class="nc" id="L127">            requestDispatcher.include(request, responseWrapper);</span>
<span class="nc" id="L128">        }</span>
<span class="nc" id="L129">    }</span>

    protected boolean isAllowedRequestPath(String requestActionPath) {
<span class="nc" id="L132">        String rapLowerCase = requestActionPath.toLowerCase();</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">        return !rapLowerCase.contains(&quot;web-inf&quot;)</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">                &amp;&amp; !rapLowerCase.contains(&quot;meta-inf&quot;)</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">                &amp;&amp; !rapLowerCase.contains(&quot;../&quot;)</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">                &amp;&amp; !rapLowerCase.contains(&quot;%2e%2e%2f&quot;)</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">                &amp;&amp; !rapLowerCase.endsWith(&quot;.txt&quot;)</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">                &amp;&amp; !rapLowerCase.contains(&quot;&lt;&quot;)</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">                &amp;&amp; !rapLowerCase.endsWith(&quot;%3c&quot;)</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">                &amp;&amp; !rapLowerCase.endsWith(&quot;%00&quot;)</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">                &amp;&amp; !rapLowerCase.endsWith(&quot;'&quot;)</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">                &amp;&amp; !rapLowerCase.endsWith(&quot;\&quot;&quot;);</span>
    }

    protected boolean isRecursivePath(String requestActionPath, HttpServletRequest request) {
<span class="nc" id="L146">        String contextPath = request.getContextPath();</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (!requestActionPath.contains(contextPath)) {</span>
<span class="nc" id="L148">            return false;</span>
        }
<span class="nc" id="L150">        String prefix = contextPath + &quot;/pages/&quot;;</span>
<span class="nc bnc" id="L151" title="All 6 branches missed.">        return (requestActionPath.contains(&quot;.wp&quot;) || requestActionPath.contains(&quot;.page&quot;) || requestActionPath.contains(prefix));</span>
    }

    /**
     * Extract the init Action Path. Return the tag attribute (if set), else the widget parameter.
     *
     * @param reqCtx The request context.
     * @param widget The current widget.
     * @return The init Action Path
     */
    protected String extractIntroActionPath(RequestContext reqCtx, Widget widget) {
<span class="nc" id="L162">        String actionPath = this.getActionPath();</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (null == this.getActionPath()) {</span>
<span class="nc" id="L164">            ApsProperties config = widget.getConfig();</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">            if (widget.getType().isLogic()) {</span>
<span class="nc" id="L166">                config = widget.getType().getConfig();</span>
            }
<span class="nc bnc" id="L168" title="All 2 branches missed.">            if (null != config) {</span>
<span class="nc" id="L169">                actionPath = config.getProperty(CONFIG_PARAM_ACTIONPATH);</span>
            }
        }
<span class="nc bnc" id="L172" title="All 4 branches missed.">        if (null == actionPath || actionPath.trim().length() == 0) {</span>
<span class="nc" id="L173">            IPage page = (IPage) reqCtx.getExtraParam(SystemConstants.EXTRAPAR_CURRENT_PAGE);</span>
<span class="nc" id="L174">            throw new RuntimeException(&quot;Null init action path : page &quot; + page.getCode());</span>
        }
<span class="nc" id="L176">        return actionPath;</span>
    }

    @Override
    public void release() {
<span class="nc" id="L181">        super.release();</span>
<span class="nc" id="L182">        this.setActionPath(null);</span>
<span class="nc" id="L183">        this.setStaticAction(false);</span>
<span class="nc" id="L184">    }</span>

    public String getActionPath() {
<span class="nc" id="L187">        return _actionPath;</span>
    }

    public void setActionPath(String actionPath) {
<span class="nc" id="L191">        this._actionPath = actionPath;</span>
<span class="nc" id="L192">    }</span>

    public boolean isStaticAction() {
<span class="nc" id="L195">        return _staticAction;</span>
    }

    public void setStaticAction(boolean staticAction) {
<span class="nc" id="L199">        this._staticAction = staticAction;</span>
<span class="nc" id="L200">    }</span>

    /**
     * Internal class that wrappers the response, extending the javax.servlet.http.HttpServletResponseWrapper class to define a proprietary
     * output channel. It is used to retrieve the content response after having made an 'include' in the RequestDispatcher
     */
    public class ResponseWrapper extends HttpServletResponseWrapper {

        private String _redirectPath;
        private CharArrayWriter _output;
        private Cookie[] _cookiesToAdd;

<span class="nc" id="L212">        public ResponseWrapper(HttpServletResponse response) {</span>
<span class="nc" id="L213">            super(response);</span>
<span class="nc" id="L214">            _output = new CharArrayWriter();</span>
<span class="nc" id="L215">        }</span>

        @Override
        public PrintWriter getWriter() {
<span class="nc" id="L219">            return new PrintWriter(_output);</span>
        }

        @Override
        public void sendRedirect(String path) throws IOException {
<span class="nc" id="L224">            this._redirectPath = path;</span>
<span class="nc" id="L225">        }</span>

        @Override
        public void addCookie(Cookie cookie) {
<span class="nc" id="L229">            super.addCookie(cookie);</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">            int len = (null == this._cookiesToAdd) ? 0 : this._cookiesToAdd.length;</span>
<span class="nc" id="L231">            Cookie[] newCookiesToAdd = new Cookie[len + 1];</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">            if (null != this._cookiesToAdd) {</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L234">                    newCookiesToAdd[i] = this._cookiesToAdd[i];</span>
                }
            }
<span class="nc" id="L237">            newCookiesToAdd[len] = cookie;</span>
<span class="nc" id="L238">            this._cookiesToAdd = newCookiesToAdd;</span>
<span class="nc" id="L239">        }</span>

        protected Cookie[] getCookiesToAdd() {
<span class="nc" id="L242">            return _cookiesToAdd;</span>
        }

        public boolean isRedirected() {
<span class="nc bnc" id="L246" title="All 2 branches missed.">            return (_redirectPath != null);</span>
        }

        public String getRedirectPath() {
<span class="nc" id="L250">            return _redirectPath;</span>
        }

        @Override
        public String toString() {
<span class="nc" id="L255">            return _output.toString();</span>
        }

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>