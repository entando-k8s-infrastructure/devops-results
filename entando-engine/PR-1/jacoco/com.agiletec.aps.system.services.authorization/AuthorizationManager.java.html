<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthorizationManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Entando Core: Engine</a> &gt; <a href="index.source.html" class="el_package">com.agiletec.aps.system.services.authorization</a> &gt; <span class="el_source">AuthorizationManager.java</span></div><h1>AuthorizationManager.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2015-Present Entando Inc. (http://www.entando.com) All rights reserved.
 *
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 */

package com.agiletec.aps.system.services.authorization;

import com.agiletec.aps.system.common.AbstractService;
import com.agiletec.aps.system.common.entity.model.IApsEntity;
import com.agiletec.aps.system.exception.ApsSystemException;
import com.agiletec.aps.system.services.group.Group;
import com.agiletec.aps.system.services.group.GroupUtilizer;
import com.agiletec.aps.system.services.group.IGroupManager;
import com.agiletec.aps.system.services.page.IPage;
import com.agiletec.aps.system.services.role.IRoleManager;
import com.agiletec.aps.system.services.role.Permission;
import com.agiletec.aps.system.services.role.Role;
import com.agiletec.aps.system.services.user.UserDetails;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;
import org.apache.commons.lang.StringUtils;
import org.aspectj.lang.annotation.AfterReturning;
import org.aspectj.lang.annotation.Aspect;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Servizio di autorizzazione. Il servizio espone tutti i metodi necessari per la verifica verifica delle autorizzazioni utente, qualsiasi
 * sia la sua provenienza e definizione.
 *
 * @author E.Santoboni
 */
@Aspect
<span class="fc" id="L48">public class AuthorizationManager extends AbstractService implements IAuthorizationManager, GroupUtilizer {</span>

<span class="fc" id="L50">    private static final Logger _logger = LoggerFactory.getLogger(AuthorizationManager.class);</span>
    private IAuthorizationDAO _authorizationDAO;
    private IRoleManager _roleManager;
    private IGroupManager _groupManager;

    @Override
    public void init() throws Exception {
<span class="fc" id="L57">        _logger.debug(&quot;{} ready&quot;, this.getClass().getName());</span>
<span class="fc" id="L58">    }</span>

    @Override
    @Deprecated
    public boolean isAuth(UserDetails user, IApsAuthority auth) {
<span class="nc" id="L63">        return this.checkAuth(user, auth);</span>
    }

    @Override
    public boolean isAuthOnGroupAndPermission(UserDetails user, String groupName, String permissionName, boolean chechAdmin) {
<span class="pc bpc" id="L68" title="3 of 6 branches missed.">        if (null == user || null == groupName || null == permissionName) {</span>
<span class="nc" id="L69">            return false;</span>
        }
<span class="fc" id="L71">        List&lt;Role&gt; roles = new ArrayList&lt;Role&gt;();</span>
<span class="fc" id="L72">        List&lt;Role&gt; rolesWithPermission = this.getRoleManager().getRolesWithPermission(permissionName);</span>
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">        if (null != rolesWithPermission) {</span>
<span class="fc" id="L74">            roles.addAll(rolesWithPermission);</span>
        }
<span class="fc bfc" id="L76" title="All 2 branches covered.">        if (chechAdmin) {</span>
<span class="fc" id="L77">            List&lt;Role&gt; rolesWithSupPermission = this.getRoleManager().getRolesWithPermission(Permission.SUPERUSER);</span>
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">            if (null != rolesWithSupPermission) {</span>
<span class="fc" id="L79">                roles.addAll(rolesWithSupPermission);</span>
            }
        }
<span class="fc bfc" id="L82" title="All 2 branches covered.">        for (int i = 0; i &lt; roles.size(); i++) {</span>
<span class="fc" id="L83">            Role role = roles.get(i);</span>
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">            if (null != role) {</span>
<span class="fc" id="L85">                boolean check = this.isAuthOnGroupAndRole(user, groupName, role.getName(), chechAdmin);</span>
<span class="fc bfc" id="L86" title="All 2 branches covered.">                if (check) {</span>
<span class="fc" id="L87">                    return true;</span>
                }
            }

        }
<span class="fc" id="L92">        return false;</span>
    }

    @Override
    public boolean isAuthOnGroupAndRole(UserDetails user, String groupName, String roleName, boolean chechAdmin) {
<span class="pc bpc" id="L97" title="2 of 6 branches missed.">        if (null == user || (null == groupName &amp;&amp; null == roleName)) {</span>
<span class="nc" id="L98">            return false;</span>
        }
<span class="fc" id="L100">        List&lt;Authorization&gt; userAuths = user.getAuthorizations();</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">        for (int i = 0; i &lt; userAuths.size(); i++) {</span>
<span class="fc" id="L102">            Authorization userAuth = userAuths.get(i);</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">            if (null == userAuth) {</span>
<span class="nc" id="L104">                continue;</span>
            }
<span class="fc" id="L106">            Group group = userAuth.getGroup();</span>
<span class="pc bpc" id="L107" title="5 of 8 branches missed.">            if ((null == group &amp;&amp; null != groupName) || (null != group &amp;&amp; null == groupName)) {</span>
<span class="nc" id="L108">                continue;</span>
<span class="pc bpc" id="L109" title="2 of 4 branches missed.">            } else if (null != group &amp;&amp; null != groupName) {</span>
<span class="fc bfc" id="L110" title="All 4 branches covered.">                if (!chechAdmin &amp;&amp; !groupName.equals(group.getName())) {</span>
<span class="fc" id="L111">                    continue;</span>
<span class="fc bfc" id="L112" title="All 4 branches covered.">                } else if (chechAdmin &amp;&amp; !Group.ADMINS_GROUP_NAME.equals(group.getName())) {</span>
<span class="fc" id="L113">                    continue;</span>
                }
            }
<span class="fc" id="L116">            Role role = userAuth.getRole();</span>
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">            if (null == roleName) {</span>
<span class="nc" id="L118">                return true;</span>
            } else {
<span class="fc" id="L120">                boolean isSuper = role.hasPermission(Permission.SUPERUSER);</span>
<span class="pc bpc" id="L121" title="5 of 6 branches missed.">                if (role.getName().equals(roleName) || (chechAdmin &amp;&amp; isSuper)) {</span>
<span class="fc" id="L122">                    return true;</span>
                }
            }
        }
<span class="fc" id="L126">        return false;</span>
    }

    @Override
    public List&lt;IApsAuthority&gt; getRelatedAuthorities(UserDetails user, IApsAuthority auth) {
<span class="pc bpc" id="L131" title="2 of 4 branches missed.">        if (null == user || null == auth) {</span>
<span class="nc" id="L132">            return null;</span>
        }
<span class="fc" id="L134">        String requiredAuthName = auth.getAuthority();</span>
<span class="fc" id="L135">        boolean isRole = (auth instanceof Role);</span>
<span class="fc" id="L136">        return (List&lt;IApsAuthority&gt;) this.getRelatedAuthorities(user, requiredAuthName, isRole);</span>
    }

    private List getRelatedAuthorities(UserDetails user, String requiredAuthName, boolean isRole) {
<span class="pc bpc" id="L140" title="2 of 10 branches missed.">        if (null == user || null == requiredAuthName || (isRole &amp;&amp; null == this.getRoleManager().getRole(requiredAuthName)) || (!isRole</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">                &amp;&amp; null == this.getGroupManager().getGroup(requiredAuthName))) {</span>
<span class="fc" id="L142">            return null;</span>
        }

<span class="fc" id="L145">        List&lt;String&gt; adminRoleNames = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L146" title="All 2 branches covered.">        if (isRole) {</span>
<span class="fc" id="L147">            List&lt;Role&gt; adminRoles = this.getRolesWithPermission(user, Permission.SUPERUSER);</span>
<span class="pc bpc" id="L148" title="1 of 4 branches missed.">            if (null != adminRoles &amp;&amp; !adminRoles.isEmpty()) {</span>
<span class="fc bfc" id="L149" title="All 2 branches covered.">                for (int i = 0; i &lt; adminRoles.size(); i++) {</span>
<span class="fc" id="L150">                    Role role = adminRoles.get(i);</span>
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">                    if (null != role) {</span>
<span class="fc" id="L152">                        adminRoleNames.add(role.getName());</span>
                    }
                }
            }
        }
<span class="fc" id="L157">        List authorities = new ArrayList&lt;IApsAuthority&gt;();</span>
<span class="fc" id="L158">        List&lt;Authorization&gt; userAuths = user.getAuthorizations();</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">        for (int i = 0; i &lt; userAuths.size(); i++) {</span>
<span class="fc" id="L160">            Authorization userAuth = userAuths.get(i);</span>
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">            if (null == userAuth) {</span>
<span class="nc" id="L162">                continue;</span>
            }
<span class="pc bpc" id="L164" title="1 of 6 branches missed.">            if (!isRole &amp;&amp; null != userAuth.getGroup() &amp;&amp; (userAuth.getGroup().getName().equals(Group.ADMINS_GROUP_NAME) || requiredAuthName</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">                    .equals(userAuth.getGroup().getAuthority()))) {</span>
<span class="fc" id="L166">                authorities.add(userAuth.getRole());</span>
            }
<span class="pc bpc" id="L168" title="1 of 6 branches missed.">            if (isRole &amp;&amp; null != userAuth.getRole() &amp;&amp; (adminRoleNames.contains(userAuth.getRole().getName()) || requiredAuthName</span>
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">                    .equals(userAuth.getRole().getAuthority()))) {</span>
<span class="fc bfc" id="L170" title="All 2 branches covered.">                if (userAuth.getGroup().getName().equals(Group.ADMINS_GROUP_NAME)) {</span>
<span class="fc" id="L171">                    return this.getGroupManager().getGroups();</span>
                } else {
<span class="fc" id="L173">                    authorities.add(userAuth.getGroup());</span>
                }
            }
        }
<span class="fc" id="L177">        return authorities;</span>
    }

    @Override
    public boolean isAuth(UserDetails user, Group group) {
<span class="fc" id="L182">        return this.isAuthOnGroup(user, group.getName());</span>
    }

    @Override
    public List&lt;IApsAuthority&gt; getAuthoritiesByGroup(UserDetails user, Group group) {
<span class="nc" id="L187">        return this.getRelatedAuthorities(user, group);</span>
    }

    @Override
    public List&lt;Role&gt; getRolesByGroup(UserDetails user, Group group) {
<span class="nc" id="L192">        return this.getRelatedAuthorities(user, group.getName(), false);</span>
    }

    @Override
    public boolean isAuth(UserDetails user, IApsEntity entity) {
<span class="pc bpc" id="L197" title="2 of 4 branches missed.">        if (null == entity || null == user) {</span>
<span class="nc" id="L198">            return false;</span>
        }
<span class="fc" id="L200">        String mainGroupName = entity.getMainGroup();</span>
<span class="pc bpc" id="L201" title="1 of 4 branches missed.">        if (mainGroupName.equals(Group.FREE_GROUP_NAME) || this.checkAuth(user, mainGroupName, false) || this</span>
<span class="fc bfc" id="L202" title="All 2 branches covered.">                .checkAuth(user, Group.ADMINS_GROUP_NAME, false)) {</span>
<span class="fc" id="L203">            return true;</span>
        }
<span class="fc" id="L205">        Set&lt;String&gt; groups = entity.getGroups();</span>
<span class="fc" id="L206">        return isAuth(user, groups);</span>
    }

    @Override
    public boolean isAuth(UserDetails user, Set&lt;String&gt; groups) {
<span class="pc bpc" id="L211" title="1 of 2 branches missed.">        if (null == user) {</span>
<span class="nc" id="L212">            return false;</span>
        }
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">        if (this.checkAuth(user, Group.ADMINS_GROUP_NAME, false)) {</span>
<span class="nc" id="L215">            return true;</span>
        }
<span class="pc bpc" id="L217" title="1 of 4 branches missed.">        if (null == groups || groups.isEmpty()) {</span>
<span class="fc" id="L218">            return false;</span>
        }
<span class="fc" id="L220">        Iterator&lt;String&gt; iter = groups.iterator();</span>
<span class="fc bfc" id="L221" title="All 2 branches covered.">        while (iter.hasNext()) {</span>
<span class="fc" id="L222">            String groupName = iter.next();</span>
<span class="fc bfc" id="L223" title="All 4 branches covered.">            if (groupName.equals(Group.FREE_GROUP_NAME) || this.checkAuth(user, groupName, false)) {</span>
<span class="fc" id="L224">                return true;</span>
            }
<span class="fc" id="L226">        }</span>
<span class="fc" id="L227">        return false;</span>
    }

    @Override
    public boolean isAuth(UserDetails user, Permission permission) {
<span class="fc" id="L232">        return this.isAuthOnPermission(user, permission.getName());</span>
    }

    @Override
    public List&lt;IApsAuthority&gt; getAuthoritiesByPermission(UserDetails user, Permission permission) {
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (null == permission) {</span>
<span class="nc" id="L238">            return null;</span>
        }
<span class="nc" id="L240">        return this.getAuthoritiesByPermissionName(user, permission.getName());</span>
    }

    @Override
    public List&lt;Group&gt; getGroupsByPermission(UserDetails user, Permission permission) {
<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (null == permission) {</span>
<span class="nc" id="L246">            return null;</span>
        }
<span class="nc" id="L248">        return this.getGroupsByPermission(user, permission.getName());</span>
    }

    @Override
    public List&lt;Group&gt; getGroupsByPermission(UserDetails user, String permissionName) {
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">        if (null == user) {</span>
<span class="nc" id="L254">            return null;</span>
        }
<span class="fc" id="L256">        List&lt;Group&gt; groups = new ArrayList&lt;Group&gt;();</span>
<span class="fc" id="L257">        List&lt;IApsAuthority&gt; auths = this.getAuthoritiesByPermissionName(user, permissionName);</span>
<span class="fc bfc" id="L258" title="All 2 branches covered.">        for (int i = 0; i &lt; auths.size(); i++) {</span>
<span class="fc" id="L259">            IApsAuthority auth = auths.get(i);</span>
<span class="pc bpc" id="L260" title="2 of 4 branches missed.">            if (null != auth &amp;&amp; auth instanceof Group) {</span>
<span class="fc" id="L261">                String groupName = auth.getAuthority();</span>
<span class="fc bfc" id="L262" title="All 2 branches covered.">                if (Group.ADMINS_GROUP_NAME.equals(groupName)) {</span>
<span class="fc" id="L263">                    return this.getGroupManager().getGroups();</span>
                } else {
<span class="fc bfc" id="L265" title="All 2 branches covered.">                    if (!groups.contains(auth)) {</span>
<span class="fc" id="L266">                        groups.add((Group) auth);</span>
                    }
                }
            }
        }
<span class="fc" id="L271">        return groups;</span>
    }

    private List getAuthoritiesByPermissionName(UserDetails user, String permissionName) {
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">        if (null == user) {</span>
<span class="nc" id="L276">            return null;</span>
        }
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">        if (null == permissionName) {</span>
<span class="nc" id="L279">            return null;</span>
        }
<span class="fc" id="L281">        List auths = new ArrayList();</span>
<span class="fc" id="L282">        this.addAuthoritiesByPermissionName(user, permissionName, auths);</span>
<span class="fc" id="L283">        this.addAuthoritiesByPermissionName(user, Permission.SUPERUSER, auths);</span>
<span class="fc" id="L284">        return auths;</span>
    }

    private void addAuthoritiesByPermissionName(UserDetails user, String permissionName, List auths) {
<span class="fc" id="L288">        List&lt;Role&gt; roles = this.getRolesWithPermission(user, permissionName);</span>
<span class="fc bfc" id="L289" title="All 2 branches covered.">        for (int i = 0; i &lt; roles.size(); i++) {</span>
<span class="fc" id="L290">            Role role = roles.get(i);</span>
<span class="fc" id="L291">            List groupAuths = this.getRelatedAuthorities(user, role);</span>
<span class="pc bpc" id="L292" title="1 of 2 branches missed.">            if (null != groupAuths) {</span>
<span class="fc" id="L293">                auths.addAll(groupAuths);</span>
            }
        }
<span class="fc" id="L296">    }</span>

    @Override
    public boolean isAuth(UserDetails user, IPage page) {
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">        if (null == user) {</span>
<span class="nc" id="L301">            return false;</span>
        }
<span class="fc bfc" id="L303" title="All 2 branches covered.">        if (this.isAuthOnGroup(user, Group.ADMINS_GROUP_NAME)) {</span>
<span class="fc" id="L304">            return true;</span>
        }
<span class="fc" id="L306">        String pageGroup = page.getGroup();</span>
<span class="fc bfc" id="L307" title="All 2 branches covered.">        if (Group.FREE_GROUP_NAME.equals(pageGroup)) {</span>
<span class="fc" id="L308">            return true;</span>
        }
<span class="fc" id="L310">        boolean isAuthorized = this.isAuthOnGroup(user, pageGroup);</span>
<span class="fc bfc" id="L311" title="All 2 branches covered.">        if (isAuthorized) {</span>
<span class="fc" id="L312">            return true;</span>
        }
<span class="fc" id="L314">        Collection&lt;String&gt; extraGroups = page.getExtraGroups();</span>
<span class="pc bpc" id="L315" title="3 of 4 branches missed.">        if (null != extraGroups &amp;&amp; !extraGroups.isEmpty()) {</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">            if (extraGroups.contains(Group.FREE_GROUP_NAME)) {</span>
<span class="nc" id="L317">                return true;</span>
            }
<span class="nc" id="L319">            Iterator&lt;String&gt; iter = extraGroups.iterator();</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">            while (iter.hasNext()) {</span>
<span class="nc" id="L321">                String extraGroupName = iter.next();</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">                if (this.isAuthOnGroup(user, extraGroupName)) {</span>
<span class="nc" id="L323">                    return true;</span>
                }
<span class="nc" id="L325">            }</span>
        }
<span class="fc" id="L327">        return false;</span>
    }

    @Override
    public boolean isAuthOnGroup(UserDetails user, String groupName) {
<span class="fc bfc" id="L332" title="All 4 branches covered.">        return ((this.checkAuth(user, groupName, false) || this.checkAuth(user, Group.ADMINS_GROUP_NAME, false)));</span>
    }

    @Override
    public List&lt;IApsAuthority&gt; getAuthoritiesByGroup(UserDetails user, String groupName) {
<span class="fc" id="L337">        return this.getRelatedAuthorities(user, groupName, false);</span>
    }

    @Override
    public List&lt;Role&gt; getRolesByGroup(UserDetails user, String groupName) {
<span class="nc" id="L342">        return this.getRelatedAuthorities(user, groupName, false);</span>
    }

    @Override
    public boolean isAuthOnRole(UserDetails user, String roleName) {
<span class="nc bnc" id="L347" title="All 4 branches missed.">        return ((this.isAuthOnPermission(user, Permission.SUPERUSER) || this.checkAuth(user, roleName, true)));</span>
    }

    @Override
    public List&lt;IApsAuthority&gt; getAuthoritiesByRole(UserDetails user, String roleName) {
<span class="fc" id="L352">        return this.getRelatedAuthorities(user, roleName, true);</span>
    }

    @Override
    public List&lt;Group&gt; getGroupsByRole(UserDetails user, String roleName) {
<span class="nc" id="L357">        return this.getRelatedAuthorities(user, roleName, true);</span>
    }

    @Override
    public boolean isAuthOnPermission(UserDetails user, String permissionName) {
<span class="fc" id="L362">        boolean check = this.isAuthOnSinglePermission(user, permissionName);</span>
<span class="fc bfc" id="L363" title="All 2 branches covered.">        if (check) {</span>
<span class="fc" id="L364">            return true;</span>
        }
<span class="fc" id="L366">        return this.isAuthOnSinglePermission(user, Permission.SUPERUSER);</span>
    }

    private boolean isAuthOnSinglePermission(UserDetails user, String permissionName) {
<span class="pc bpc" id="L370" title="1 of 2 branches missed.">        if (null == user) {</span>
<span class="nc" id="L371">            return false;</span>
        }
<span class="fc" id="L373">        List&lt;Role&gt; rolesWithPermission = this.getRolesWithPermission(user, permissionName);</span>
<span class="pc bfc" id="L374" title="All 2 branches covered.">        for (int i = 0; i &lt; rolesWithPermission.size(); i++) {</span>
<span class="fc" id="L375">            Role role = rolesWithPermission.get(i);</span>
<span class="fc" id="L376">            boolean check = this.checkAuth(user, role.getAuthority(), true);</span>
<span class="pc bpc" id="L377" title="1 of 2 branches missed.">            if (check) {</span>
<span class="fc" id="L378">                return true;</span>
            }
        }
<span class="fc" id="L381">        return false;</span>
    }

    private List&lt;Role&gt; getRolesWithPermission(UserDetails user, String permissionName) {
<span class="pc bpc" id="L385" title="1 of 2 branches missed.">        if (null == user) {</span>
<span class="nc" id="L386">            return null;</span>
        }
<span class="fc" id="L388">        List&lt;Role&gt; roles = new ArrayList&lt;Role&gt;();</span>
<span class="fc" id="L389">        List&lt;Authorization&gt; auths = user.getAuthorizations();</span>
<span class="fc bfc" id="L390" title="All 2 branches covered.">        for (int i = 0; i &lt; auths.size(); i++) {</span>
<span class="fc" id="L391">            Authorization auth = auths.get(i);</span>
<span class="pc bpc" id="L392" title="1 of 2 branches missed.">            if (null == auth) {</span>
<span class="nc" id="L393">                continue;</span>
            }
<span class="fc bfc" id="L395" title="All 4 branches covered.">            if (null != auth.getRole() &amp;&amp; auth.getRole().hasPermission(permissionName)) {</span>
<span class="fc" id="L396">                roles.add(auth.getRole());</span>
            }
        }
<span class="fc" id="L399">        return roles;</span>
    }

    @Override
    @Deprecated
    public List&lt;Group&gt; getGroupsOfUser(UserDetails user) {
<span class="nc" id="L405">        return this.getUserGroups(user);</span>
    }

    @Override
    public List&lt;Group&gt; getUserGroups(UserDetails user) {
<span class="pc bpc" id="L410" title="1 of 2 branches missed.">        if (null == user) {</span>
<span class="nc" id="L411">            return null;</span>
        }
<span class="fc" id="L413">        List&lt;Group&gt; groups = new ArrayList&lt;Group&gt;();</span>
<span class="fc" id="L414">        List&lt;Authorization&gt; auths = user.getAuthorizations();</span>
<span class="fc bfc" id="L415" title="All 2 branches covered.">        for (int i = 0; i &lt; auths.size(); i++) {</span>
<span class="fc" id="L416">            Authorization auth = auths.get(i);</span>
<span class="pc bpc" id="L417" title="2 of 4 branches missed.">            if (null != auth &amp;&amp; null != auth.getGroup()) {</span>
<span class="fc" id="L418">                String groupName = auth.getGroup().getName();</span>
<span class="fc bfc" id="L419" title="All 2 branches covered.">                if (Group.ADMINS_GROUP_NAME.equals(groupName)) {</span>
<span class="fc" id="L420">                    return this.getGroupManager().getGroups();</span>
                } else {
<span class="fc" id="L422">                    groups.add(auth.getGroup());</span>
                }
            }
        }
<span class="fc" id="L426">        return groups;</span>
    }

    @Override
    public List&lt;Role&gt; getUserRoles(UserDetails user) {
<span class="nc bnc" id="L431" title="All 2 branches missed.">        if (null == user) {</span>
<span class="nc" id="L432">            return null;</span>
        }
<span class="nc" id="L434">        List&lt;Role&gt; roles = new ArrayList&lt;Role&gt;();</span>
<span class="nc" id="L435">        List&lt;Authorization&gt; auths = user.getAuthorizations();</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">        for (int i = 0; i &lt; auths.size(); i++) {</span>
<span class="nc" id="L437">            Authorization auth = auths.get(i);</span>
<span class="nc bnc" id="L438" title="All 4 branches missed.">            if (null != auth &amp;&amp; null != auth.getRole()) {</span>
<span class="nc" id="L439">                roles.add(auth.getRole());</span>
            }
        }
<span class="nc" id="L442">        return roles;</span>
    }

    @Deprecated
    private boolean checkAuth(UserDetails user, IApsAuthority requiredAuth) {
<span class="nc bnc" id="L447" title="All 4 branches missed.">        if (null == requiredAuth || null == user) {</span>
<span class="nc" id="L448">            return false;</span>
        }
<span class="nc" id="L450">        boolean isRole = (requiredAuth instanceof Role);</span>
<span class="nc" id="L451">        String requiredAuthName = requiredAuth.getAuthority();</span>
<span class="nc" id="L452">        return this.checkAuth(user, requiredAuthName, isRole);</span>
    }

    private boolean checkAuth(UserDetails user, String requiredAuthName, boolean isRole) {
<span class="pc bpc" id="L456" title="2 of 4 branches missed.">        if (null == requiredAuthName || null == user) {</span>
<span class="nc" id="L457">            return false;</span>
        }
<span class="fc" id="L459">        List&lt;Authorization&gt; auths = user.getAuthorizations();</span>
<span class="fc bfc" id="L460" title="All 2 branches covered.">        for (int i = 0; i &lt; auths.size(); i++) {</span>
<span class="fc" id="L461">            Authorization auth = auths.get(i);</span>
<span class="pc bpc" id="L462" title="1 of 2 branches missed.">            if (null == auth) {</span>
<span class="nc" id="L463">                continue;</span>
            }
<span class="pc bpc" id="L465" title="2 of 6 branches missed.">            if (isRole &amp;&amp; null != auth.getRole() &amp;&amp; requiredAuthName.equals(auth.getRole().getAuthority())) {</span>
<span class="fc" id="L466">                return true;</span>
            }
<span class="pc bpc" id="L468" title="2 of 6 branches missed.">            if (!isRole &amp;&amp; null != auth.getGroup() &amp;&amp; requiredAuthName.equals(auth.getGroup().getAuthority())) {</span>
<span class="fc" id="L469">                return true;</span>
            }
        }
<span class="fc" id="L472">        return false;</span>
    }

    @Override
    public List&lt;Authorization&gt; getUserAuthorizations(String username) throws ApsSystemException {
<span class="fc" id="L477">        List&lt;Authorization&gt; authorizations = null;</span>
        try {
<span class="fc" id="L479">            Map&lt;String, Group&gt; groups = (Map&lt;String, Group&gt;) this.getAuthorityMap(this.getGroupManager().getGroups());</span>
<span class="fc" id="L480">            Map&lt;String, Role&gt; roles = (Map&lt;String, Role&gt;) this.getAuthorityMap(this.getRoleManager().getRoles());</span>
<span class="fc" id="L481">            authorizations = this.getAuthorizationDAO().getUserAuthorizations(username, groups, roles);</span>
<span class="nc" id="L482">        } catch (Throwable t) {</span>
<span class="nc" id="L483">            _logger.error(&quot;Error extracting user authorizations for user '{}'&quot;, username, t);</span>
<span class="nc" id="L484">            throw new ApsSystemException(&quot;Error extracting user authorizations for user &quot; + username, t);</span>
<span class="fc" id="L485">        }</span>
<span class="fc" id="L486">        return authorizations;</span>
    }

    private Map getAuthorityMap(List list) {
<span class="fc" id="L490">        Map&lt;String, IApsAuthority&gt; map = new HashMap&lt;String, IApsAuthority&gt;();</span>
<span class="fc bfc" id="L491" title="All 2 branches covered.">        for (int i = 0; i &lt; list.size(); i++) {</span>
<span class="fc" id="L492">            IApsAuthority authority = (IApsAuthority) list.get(i);</span>
<span class="fc" id="L493">            map.put(authority.getAuthority(), authority);</span>
        }
<span class="fc" id="L495">        return map;</span>
    }

    @Override
    public void addUserAuthorization(String username, String groupName, String roleName) throws ApsSystemException {
        try {
<span class="fc bfc" id="L501" title="All 2 branches covered.">            Group group = (null != groupName) ? this.getGroupManager().getGroup(groupName) : null;</span>
<span class="fc bfc" id="L502" title="All 4 branches covered.">            if (null != groupName &amp;&amp; null == group) {</span>
<span class="fc" id="L503">                _logger.warn(&quot;invalid authorization -  invalid referenced group name&quot;);</span>
<span class="fc" id="L504">                return;</span>
            }
<span class="fc bfc" id="L506" title="All 2 branches covered.">            Role role = (null != roleName) ? this.getRoleManager().getRole(roleName) : null;</span>
<span class="fc bfc" id="L507" title="All 4 branches covered.">            if (null != roleName &amp;&amp; null == role) {</span>
<span class="fc" id="L508">                _logger.warn(&quot;invalid authorization -  invalid referenced role name&quot;);</span>
<span class="fc" id="L509">                return;</span>
            }
<span class="fc" id="L511">            Authorization authorization = new Authorization(group, role);</span>
<span class="fc" id="L512">            this.addUserAuthorization(username, authorization);</span>
<span class="nc" id="L513">        } catch (Throwable t) {</span>
<span class="nc" id="L514">            _logger.error(&quot;Error adding user authorization for user '{}'&quot;, username, t);</span>
<span class="nc" id="L515">            throw new ApsSystemException(&quot;Error adding user authorization for user &quot; + username, t);</span>
<span class="fc" id="L516">        }</span>
<span class="fc" id="L517">    }</span>

    @Override
    public void addUserAuthorization(String username, Authorization authorization) throws ApsSystemException {
<span class="pc bpc" id="L521" title="2 of 4 branches missed.">        if (null == username || null == authorization) {</span>
<span class="nc" id="L522">            return;</span>
        }
        try {
<span class="pc bpc" id="L525" title="1 of 2 branches missed.">            if (this.checkAuthorization(authorization)) {</span>
<span class="fc" id="L526">                this.getAuthorizationDAO().addUserAuthorization(username, authorization);</span>
            }
<span class="nc" id="L528">        } catch (Throwable t) {</span>
<span class="nc" id="L529">            _logger.error(&quot;Error adding user authorization for user '{}'&quot;, username, t);</span>
<span class="nc" id="L530">            throw new ApsSystemException(&quot;Error adding user authorization for user &quot; + username, t);</span>
<span class="fc" id="L531">        }</span>
<span class="fc" id="L532">    }</span>

    @Override
    public void addUserAuthorizations(String username, List&lt;Authorization&gt; authorizations) throws ApsSystemException {
<span class="pc bpc" id="L536" title="1 of 2 branches missed.">        if (null == username) {</span>
<span class="nc" id="L537">            return;</span>
        }
        try {
<span class="fc" id="L540">            List&lt;Authorization&gt; toAdd = this.checkAuthorizations(authorizations);</span>
<span class="pc bpc" id="L541" title="1 of 2 branches missed.">            if (null == toAdd) {</span>
<span class="nc" id="L542">                return;</span>
            }
<span class="fc" id="L544">            this.getAuthorizationDAO().addUserAuthorizations(username, toAdd);</span>
<span class="nc" id="L545">        } catch (Throwable t) {</span>
<span class="nc" id="L546">            _logger.error(&quot;Error adding user authorizations for user '{}'&quot;, username, t);</span>
<span class="nc" id="L547">            throw new ApsSystemException(&quot;Error adding user authorizations for user &quot; + username, t);</span>
<span class="fc" id="L548">        }</span>
<span class="fc" id="L549">    }</span>

    @Override
    public void updateUserAuthorizations(String username, List&lt;Authorization&gt; authorizations) throws ApsSystemException {
<span class="nc bnc" id="L553" title="All 2 branches missed.">        if (null == username) {</span>
<span class="nc" id="L554">            return;</span>
        }
        try {
<span class="nc" id="L557">            List&lt;Authorization&gt; toSet = this.checkAuthorizations(authorizations);</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">            if (null == toSet) {</span>
<span class="nc" id="L559">                return;</span>
            }
<span class="nc" id="L561">            this.getAuthorizationDAO().updateUserAuthorizations(username, toSet);</span>
<span class="nc" id="L562">        } catch (Throwable t) {</span>
<span class="nc" id="L563">            _logger.error(&quot;Error updating user authorizations for user '{}'&quot;, username, t);</span>
<span class="nc" id="L564">            throw new ApsSystemException(&quot;Error updating user authorizations for user &quot; + username, t);</span>
<span class="nc" id="L565">        }</span>
<span class="nc" id="L566">    }</span>

    private List&lt;Authorization&gt; checkAuthorizations(List&lt;Authorization&gt; authorizations) throws Throwable {
<span class="pc bpc" id="L569" title="1 of 2 branches missed.">        if (null == authorizations) {</span>
<span class="nc" id="L570">            return null;</span>
        }
<span class="fc" id="L572">        List&lt;Authorization&gt; checked = new ArrayList&lt;Authorization&gt;();</span>
<span class="fc bfc" id="L573" title="All 2 branches covered.">        for (int i = 0; i &lt; authorizations.size(); i++) {</span>
<span class="fc" id="L574">            Authorization authorization = authorizations.get(i);</span>
<span class="fc bfc" id="L575" title="All 2 branches covered.">            if (this.checkAuthorization(authorization)) {</span>
<span class="fc" id="L576">                checked.add(authorization);</span>
            }
        }
<span class="fc" id="L579">        return checked;</span>
    }

    private boolean checkAuthorization(Authorization authorization) throws Throwable {
<span class="pc bpc" id="L583" title="1 of 2 branches missed.">        if (null == authorization) {</span>
<span class="nc" id="L584">            _logger.warn(&quot;invalid authorization -  null object&quot;);</span>
<span class="nc" id="L585">            return false;</span>
        }
<span class="fc bfc" id="L587" title="All 2 branches covered.">        String groupName = (null != authorization.getGroup()) ? authorization.getGroup().getName() : null;</span>
<span class="fc bfc" id="L588" title="All 2 branches covered.">        String roleName = (null != authorization.getRole()) ? authorization.getRole().getName() : null;</span>
<span class="pc bpc" id="L589" title="1 of 4 branches missed.">        if (null == roleName &amp;&amp; null == groupName) {</span>
<span class="nc" id="L590">            _logger.warn(&quot;invalid authorization -  null group and role&quot;);</span>
<span class="nc" id="L591">            return false;</span>
        }
<span class="fc bfc" id="L593" title="All 4 branches covered.">        if (null != groupName &amp;&amp; null == this.getGroupManager().getGroup(groupName)) {</span>
<span class="fc" id="L594">            _logger.warn(&quot;invalid authorization -  invalid referenced group&quot;);</span>
<span class="fc" id="L595">            return false;</span>
        }
<span class="pc bpc" id="L597" title="1 of 4 branches missed.">        if (null != roleName &amp;&amp; null == this.getRoleManager().getRole(roleName)) {</span>
<span class="nc" id="L598">            _logger.warn(&quot;invalid authorization -  invalid referenced role&quot;);</span>
<span class="nc" id="L599">            return false;</span>
        }
<span class="fc" id="L601">        return true;</span>
    }

    @Override
    public void deleteUserAuthorization(String username, String groupname, String rolename) throws ApsSystemException {
        try {
<span class="fc" id="L607">            this.getAuthorizationDAO().deleteUserAuthorization(username, groupname, rolename);</span>
<span class="nc" id="L608">        } catch (Throwable t) {</span>
<span class="nc" id="L609">            _logger.error(&quot;Error deleting user authorization for user '{}'&quot;, username, t);</span>
<span class="nc" id="L610">            throw new ApsSystemException(&quot;Error deleting user authorization for user &quot; + username, t);</span>
<span class="fc" id="L611">        }</span>
<span class="fc" id="L612">    }</span>

    @Override
    public void deleteUserAuthorizations(String username) throws ApsSystemException {
        try {
<span class="fc" id="L617">            this.getAuthorizationDAO().deleteUserAuthorizations(username);</span>
<span class="nc" id="L618">        } catch (Throwable t) {</span>
<span class="nc" id="L619">            _logger.error(&quot;Error deleting user authorizations for user '{}'&quot;, username, t);</span>
<span class="nc" id="L620">            throw new ApsSystemException(&quot;Error deleting user authorizations for user &quot; + username, t);</span>
<span class="fc" id="L621">        }</span>
<span class="fc" id="L622">    }</span>

    @AfterReturning(pointcut = &quot;execution(* com.agiletec.aps.system.services.user.IUserManager.removeUser(..)) &amp;&amp; args(key)&quot;)
    public void deleteUser(Object key) {
<span class="fc" id="L626">        String username = null;</span>
<span class="fc bfc" id="L627" title="All 2 branches covered.">        if (key instanceof String) {</span>
<span class="fc" id="L628">            username = key.toString();</span>
<span class="pc bpc" id="L629" title="1 of 2 branches missed.">        } else if (key instanceof UserDetails) {</span>
<span class="fc" id="L630">            UserDetails userDetails = (UserDetails) key;</span>
<span class="fc" id="L631">            username = userDetails.getUsername();</span>
        }
<span class="pc bpc" id="L633" title="1 of 2 branches missed.">        if (username != null) {</span>
            try {
<span class="fc" id="L635">                this.deleteUserAuthorizations(username);</span>
<span class="nc" id="L636">            } catch (Throwable t) {</span>
<span class="nc" id="L637">                _logger.error(&quot;Error deleting user authorizations. user: {}&quot;, username, t);</span>
<span class="fc" id="L638">            }</span>
        }
<span class="fc" id="L640">    }</span>

    @Override
    public List&lt;String&gt; getUsersByRole(IApsAuthority authority, boolean includeAdmin) throws ApsSystemException {
<span class="pc bpc" id="L644" title="1 of 6 branches missed.">        if (null == authority || !(authority instanceof Role) || null == this.getRoleManager().getRole(authority.getAuthority())) {</span>
<span class="fc" id="L645">            return null;</span>
        }
<span class="fc" id="L647">        return this.getUsersByAuthorities(null, authority.getAuthority(), includeAdmin);</span>
    }

    @Override
    public List&lt;String&gt; getUsersByRole(String roleName, boolean includeAdmin) throws ApsSystemException {
<span class="fc" id="L652">        Role role = this.getRoleManager().getRole(roleName);</span>
<span class="pc bpc" id="L653" title="1 of 2 branches missed.">        if (null == role) {</span>
<span class="nc" id="L654">            return null;</span>
        }
<span class="fc" id="L656">        return this.getUsersByAuthorities(null, roleName, includeAdmin);</span>
    }

    @Override
    public List&lt;String&gt; getUsersByGroup(IApsAuthority authority, boolean includeAdmin) throws ApsSystemException {
<span class="pc bpc" id="L661" title="1 of 6 branches missed.">        if (null == authority || !(authority instanceof Group) || null == this.getGroupManager().getGroup(authority.getAuthority())) {</span>
<span class="fc" id="L662">            return null;</span>
        }
<span class="fc" id="L664">        return this.getUsersByAuthorities(authority.getAuthority(), null, includeAdmin);</span>
    }

    @Override
    public List&lt;String&gt; getUsersByGroup(String groupName, boolean includeAdmin) throws ApsSystemException {
<span class="fc" id="L669">        Group group = this.getGroupManager().getGroup(groupName);</span>
<span class="pc bpc" id="L670" title="1 of 2 branches missed.">        if (null == group) {</span>
<span class="nc" id="L671">            return null;</span>
        }
<span class="fc" id="L673">        return this.getUsersByAuthorities(groupName, null, includeAdmin);</span>
    }

    @Override
    public List&lt;String&gt; getUsersByAuthorities(String groupName, String roleName, boolean includeAdmin) throws ApsSystemException {
<span class="fc" id="L678">        List&lt;String&gt; usernames = null;</span>
        try {
<span class="fc" id="L680">            List&lt;String&gt; groupNames = null;</span>
<span class="fc bfc" id="L681" title="All 2 branches covered.">            if (!StringUtils.isEmpty(groupName)) {</span>
<span class="fc" id="L682">                groupNames = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L683">                groupNames.add(groupName);</span>
<span class="pc bpc" id="L684" title="1 of 4 branches missed.">                if (includeAdmin &amp;&amp; !groupName.equals(Group.ADMINS_GROUP_NAME)) {</span>
<span class="fc" id="L685">                    groupNames.add(Group.ADMINS_GROUP_NAME);</span>
                }
            }
<span class="fc" id="L688">            List&lt;String&gt; roleNames = null;</span>
<span class="fc bfc" id="L689" title="All 2 branches covered.">            if (!StringUtils.isEmpty(roleName)) {</span>
<span class="fc" id="L690">                roleNames = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L691">                roleNames.add(roleName);</span>
<span class="fc bfc" id="L692" title="All 2 branches covered.">                if (includeAdmin) {</span>
<span class="fc" id="L693">                    List&lt;Role&gt; adminRoles = this.getRoleManager().getRolesWithPermission(Permission.SUPERUSER);</span>
<span class="pc bpc" id="L694" title="1 of 2 branches missed.">                    if (null != adminRoles) {</span>
<span class="fc bfc" id="L695" title="All 2 branches covered.">                        for (int i = 0; i &lt; adminRoles.size(); i++) {</span>
<span class="fc" id="L696">                            Role role = adminRoles.get(i);</span>
<span class="pc bpc" id="L697" title="2 of 4 branches missed.">                            if (null != role &amp;&amp; !roleNames.contains(role.getName())) {</span>
<span class="fc" id="L698">                                roleNames.add(role.getName());</span>
                            }
                        }
                    }
                }
            }
<span class="fc" id="L704">            usernames = this.getAuthorizationDAO().getUsersByAuthorities(groupNames, roleNames);</span>
<span class="nc" id="L705">        } catch (Throwable t) {</span>
<span class="nc" id="L706">            _logger.error(&quot;Error extracting usernames by authorities - group '{}' : role {}&quot;, groupName, roleName, t);</span>
<span class="nc" id="L707">            throw new ApsSystemException(&quot;Error extracting usernames by authorities&quot;, t);</span>
<span class="fc" id="L708">        }</span>
<span class="fc" id="L709">        return usernames;</span>
    }

    @Override
    public List&lt;String&gt; getUsersByAuthority(IApsAuthority authority, boolean includeAdmin) throws ApsSystemException {
<span class="fc bfc" id="L714" title="All 2 branches covered.">        if (authority instanceof Group) {</span>
<span class="fc" id="L715">            return this.getUsersByGroup(authority, includeAdmin);</span>
        } else {
<span class="fc" id="L717">            return this.getUsersByRole(authority, includeAdmin);</span>
        }
    }

    @Override
    public List&lt;String&gt; getGroupUtilizers(String groupName) throws ApsSystemException {
<span class="fc" id="L723">        return this.getUsersByGroup(groupName, false);</span>
    }

    protected IAuthorizationDAO getAuthorizationDAO() {
<span class="fc" id="L727">        return _authorizationDAO;</span>
    }

    public void setAuthorizationDAO(IAuthorizationDAO authorizationDAO) {
<span class="fc" id="L731">        this._authorizationDAO = authorizationDAO;</span>
<span class="fc" id="L732">    }</span>

    protected IRoleManager getRoleManager() {
<span class="fc" id="L735">        return _roleManager;</span>
    }

    public void setRoleManager(IRoleManager roleManager) {
<span class="fc" id="L739">        this._roleManager = roleManager;</span>
<span class="fc" id="L740">    }</span>

    protected IGroupManager getGroupManager() {
<span class="fc" id="L743">        return _groupManager;</span>
    }

    public void setGroupManager(IGroupManager groupManager) {
<span class="fc" id="L747">        this._groupManager = groupManager;</span>
<span class="fc" id="L748">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>