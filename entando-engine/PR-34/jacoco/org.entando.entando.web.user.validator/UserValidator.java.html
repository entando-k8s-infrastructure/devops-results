<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserValidator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Entando Core: Engine</a> &gt; <a href="index.source.html" class="el_package">org.entando.entando.web.user.validator</a> &gt; <span class="el_source">UserValidator.java</span></div><h1>UserValidator.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2018-Present Entando Inc. (http://www.entando.com) All rights reserved.
 *
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 */
package org.entando.entando.web.user.validator;

import org.entando.entando.ent.exception.EntException;
import com.agiletec.aps.system.services.group.IGroupManager;
import com.agiletec.aps.system.services.role.IRoleManager;
import com.agiletec.aps.system.services.user.IUserManager;
import com.agiletec.aps.system.services.user.UserDetails;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import org.apache.commons.lang3.StringUtils;
import org.entando.entando.aps.system.exception.ResourceNotFoundException;
import org.entando.entando.aps.system.exception.RestServerError;
import org.entando.entando.web.common.RestErrorCodes;
import org.entando.entando.web.common.exceptions.ResourcePermissionsException;
import org.entando.entando.web.common.exceptions.ValidationConflictException;
import org.entando.entando.web.common.validator.AbstractPaginationValidator;
import org.entando.entando.web.user.model.UserAuthoritiesRequest;
import org.entando.entando.web.user.model.UserPasswordRequest;
import org.entando.entando.web.user.model.UserRequest;
import org.entando.entando.ent.util.XEntLogging.EntLogFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Component;
import org.springframework.validation.BindingResult;
import org.springframework.validation.Errors;
import org.springframework.validation.MapBindingResult;

@Component
<span class="nc" id="L47">public class UserValidator extends AbstractPaginationValidator {</span>

<span class="nc" id="L49">    private final org.slf4j.Logger logger = EntLogFactory.getSantiziedLogger(getClass());</span>

<span class="nc" id="L51">    private Pattern pattern = Pattern.compile(&quot;([a-zA-Z0-9_\\.])+&quot;);</span>

    public static final String ERRCODE_USER_ALREADY_EXISTS = &quot;1&quot;;

    public static final String ERRCODE_USER_NOT_FOUND = &quot;1&quot;;

    public static final String ERRCODE_USERNAME_FORMAT_INVALID = &quot;2&quot;;

    public static final String ERRCODE_PASSWORD_FORMAT_INVALID = &quot;3&quot;;

    public static final String ERRCODE_USERNAME_MISMATCH = &quot;2&quot;;
    public static final String ERRCODE_OLD_PASSWORD_FORMAT = &quot;4&quot;;
    public static final String ERRCODE_NEW_PASSWORD_EQUALS = &quot;5&quot;;

    public static final String ERRCODE_AUTHORITIES_INVALID_REQ = &quot;2&quot;;

    public static final String ERRCODE_SELF_UPDATE = &quot;6&quot;;

    public static final String ERRCODE_DELETE_ADMIN = &quot;7&quot;;

    public static final String ERRCODE_SELF_DELETE = &quot;8&quot;;

    @Autowired
    @Qualifier(&quot;compatiblePasswordEncoder&quot;)
    private PasswordEncoder passwordEncoder;

    @Autowired
    IUserManager userManager;

    @Autowired
    IGroupManager groupManager;

    @Autowired
    IRoleManager roleManager;

    public IUserManager getUserManager() {
<span class="nc" id="L87">        return userManager;</span>
    }

    public void setUserManager(IUserManager userManager) {
<span class="nc" id="L91">        this.userManager = userManager;</span>
<span class="nc" id="L92">    }</span>

    public IGroupManager getGroupManager() {
<span class="nc" id="L95">        return groupManager;</span>
    }

    public void setGroupManager(IGroupManager groupManager) {
<span class="nc" id="L99">        this.groupManager = groupManager;</span>
<span class="nc" id="L100">    }</span>

    public IRoleManager getRoleManager() {
<span class="nc" id="L103">        return roleManager;</span>
    }

    public void setRoleManager(IRoleManager roleManager) {
<span class="nc" id="L107">        this.roleManager = roleManager;</span>
<span class="nc" id="L108">    }</span>

    public PasswordEncoder getPasswordEncoder() {
<span class="nc" id="L111">        return passwordEncoder;</span>
    }

    public void setPasswordEncoder(PasswordEncoder passwordEncoder) {
<span class="nc" id="L115">        this.passwordEncoder = passwordEncoder;</span>
<span class="nc" id="L116">    }</span>

    @Override
    public boolean supports(Class&lt;?&gt; paramClass) {
<span class="nc bnc" id="L120" title="All 4 branches missed.">        return UserAuthoritiesRequest.class.equals(paramClass) || UserRequest.class.equals(paramClass);</span>
    }

    @Override
    public void validate(Object target, Errors errors) {
<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (target instanceof UserAuthoritiesRequest) {</span>
<span class="nc" id="L126">            UserAuthoritiesRequest request = (UserAuthoritiesRequest) target;</span>
<span class="nc" id="L127">            validateGroupsAndRoles(request, errors);</span>
        }
<span class="nc" id="L129">    }</span>

    public void validateUserPost(UserRequest request, BindingResult bindingResult) {
<span class="nc" id="L132">        String username = request.getUsername();</span>
<span class="nc" id="L133">        UserDetails user = this.extractUser(username);</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (null != user) {</span>
<span class="nc" id="L135">            bindingResult.reject(UserValidator.ERRCODE_USER_ALREADY_EXISTS, new String[]{username}, &quot;user.exists&quot;);</span>
<span class="nc" id="L136">            throw new ValidationConflictException(bindingResult);</span>
        }
<span class="nc" id="L138">        Matcher matcherUsername = pattern.matcher(username);</span>
<span class="nc" id="L139">        int usLength = username.length();</span>
<span class="nc bnc" id="L140" title="All 6 branches missed.">        if (usLength &lt; 4 || usLength &gt; 80 || !matcherUsername.matches()) {</span>
<span class="nc" id="L141">            bindingResult.reject(UserValidator.ERRCODE_USERNAME_FORMAT_INVALID, new String[]{username}, &quot;user.username.format.invalid&quot;);</span>
        }
<span class="nc" id="L143">        this.checkNewPassword(username, request.getPassword(), bindingResult);</span>
<span class="nc" id="L144">    }</span>

    public static boolean isAdminUser(String username) {
<span class="nc" id="L147">        return StringUtils.equalsIgnoreCase(&quot;admin&quot;, username);</span>
    }

    public static boolean isUserDeletingHimself(String username, String currentUser) {
<span class="nc" id="L151">        return StringUtils.equalsIgnoreCase(currentUser, username);</span>
    }

    public static BindingResult createDeleteAdminError() {
<span class="nc" id="L155">        Map&lt;String, String&gt; map = new HashMap&lt;&gt;();</span>
<span class="nc" id="L156">        map.put(&quot;username&quot;, &quot;admin&quot;);</span>
<span class="nc" id="L157">        BindingResult bindingResult = new MapBindingResult(map, &quot;username&quot;);</span>
<span class="nc" id="L158">        bindingResult.reject(UserValidator.ERRCODE_DELETE_ADMIN, new String[]{}, &quot;user.admin.cant.delete&quot;);</span>
<span class="nc" id="L159">        return bindingResult;</span>
    }
    public static BindingResult createSelfDeleteUserError(BindingResult bindingResult) {
<span class="nc" id="L162">        bindingResult.reject(UserValidator.ERRCODE_SELF_DELETE, new String[]{}, &quot;user.self.delete.error&quot;);</span>
<span class="nc" id="L163">        return bindingResult;</span>
    }

    public void validateGroupsAndRoles(UserAuthoritiesRequest request, Errors errors) {
<span class="nc" id="L167">        List&lt;String&gt; invalidAuths = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L168">        request.forEach(authority -&gt; {</span>
<span class="nc bnc" id="L169" title="All 4 branches missed.">            if (authority.getGroup() != null &amp;&amp; this.getGroupManager().getGroup(authority.getGroup()) == null) {</span>
<span class="nc" id="L170">                invalidAuths.add(authority.getGroup());</span>
            }
<span class="nc bnc" id="L172" title="All 4 branches missed.">            if (authority.getRole() != null &amp;&amp; this.getRoleManager().getRole(authority.getRole()) == null) {</span>
<span class="nc" id="L173">                invalidAuths.add(authority.getRole());</span>
            }
<span class="nc" id="L175">        });</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (!invalidAuths.isEmpty()) {</span>
<span class="nc" id="L177">            errors.reject(ERRCODE_AUTHORITIES_INVALID_REQ, invalidAuths.toArray(), &quot;user.authorities.invalid.req&quot;);</span>
        }
<span class="nc" id="L179">    }</span>

    public void validateUpdateSelf(String username, String currentUser, BindingResult bindingResult) {
<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (username.equals(currentUser)) {</span>
<span class="nc" id="L183">            bindingResult.reject(ERRCODE_SELF_UPDATE, new String[]{username}, &quot;user.authorities.self.update&quot;);</span>
<span class="nc" id="L184">            throw new ResourcePermissionsException(bindingResult);</span>
        }
<span class="nc" id="L186">    }</span>

    public void validatePutBody(String username, UserRequest userRequest, BindingResult bindingResult) {
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (!StringUtils.equals(username, userRequest.getUsername())) {</span>
<span class="nc" id="L190">            bindingResult.rejectValue(&quot;username&quot;, ERRCODE_USERNAME_MISMATCH, new String[]{username, userRequest.getUsername()}, &quot;user.username.mismatch&quot;);</span>
<span class="nc" id="L191">            throw new ValidationConflictException(bindingResult);</span>
        } else {
<span class="nc" id="L193">            UserDetails user = this.extractUser(username);</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">            if (null == user) {</span>
<span class="nc" id="L195">                throw new ResourceNotFoundException(ERRCODE_USER_NOT_FOUND, &quot;username&quot;, username);</span>
            }
<span class="nc bnc" id="L197" title="All 2 branches missed.">            if (null != userRequest.getPassword()) {</span>
<span class="nc" id="L198">                this.checkNewPassword(username, userRequest.getPassword(), bindingResult);</span>
            }
        }
<span class="nc" id="L201">    }</span>

    public void validateChangePasswords(String username, UserPasswordRequest passwordRequest, BindingResult bindingResult) {
<span class="nc" id="L204">        UserDetails user = this.extractUser(username);</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (!StringUtils.equals(username, passwordRequest.getUsername())) {</span>
<span class="nc" id="L206">            bindingResult.rejectValue(&quot;username&quot;, ERRCODE_USERNAME_MISMATCH, new String[]{username, passwordRequest.getUsername()}, &quot;user.username.mismatch&quot;);</span>
<span class="nc" id="L207">            throw new ValidationConflictException(bindingResult);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">        } else if (null == user) {</span>
<span class="nc" id="L209">            throw new ResourceNotFoundException(ERRCODE_USER_NOT_FOUND, &quot;username&quot;, username);</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">        } else if (StringUtils.equals(passwordRequest.getNewPassword(), passwordRequest.getOldPassword())) {</span>
<span class="nc" id="L211">            bindingResult.rejectValue(&quot;newPassword&quot;, ERRCODE_NEW_PASSWORD_EQUALS, new String[]{}, &quot;user.passwords.same&quot;);</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">        } else if (!this.verifyPassword(passwordRequest.getUsername(), passwordRequest.getOldPassword())) {</span>
<span class="nc" id="L213">            bindingResult.rejectValue(&quot;oldPassword&quot;, ERRCODE_OLD_PASSWORD_FORMAT, new String[]{}, &quot;user.password.old.invalid&quot;);</span>
        } else {
<span class="nc" id="L215">            this.checkNewPassword(username, passwordRequest.getNewPassword(), bindingResult);</span>
        }
<span class="nc" id="L217">    }</span>

    private void checkNewPassword(String username, String password, BindingResult bindingResult) {
<span class="nc bnc" id="L220" title="All 2 branches missed.">        if (null == password) {</span>
<span class="nc" id="L221">            bindingResult.reject(RestErrorCodes.NOT_NULL, new String[]{username}, &quot;user.password.NotBlank&quot;);</span>
<span class="nc" id="L222">            return;</span>
        }
<span class="nc" id="L224">        int pwLength = password.length();</span>
<span class="nc" id="L225">        Matcher matcherPassword = pattern.matcher(password);</span>
<span class="nc bnc" id="L226" title="All 6 branches missed.">        if (pwLength &lt; 8 || pwLength &gt; 20 || !matcherPassword.matches()) {</span>
<span class="nc" id="L227">            bindingResult.reject(UserValidator.ERRCODE_PASSWORD_FORMAT_INVALID, new String[]{username}, &quot;user.password.format.invalid&quot;);</span>
        }
<span class="nc" id="L229">    }</span>

    private boolean verifyPassword(String username, String password) {
        try {
<span class="nc" id="L233">            UserDetails user = this.getUserManager().getUser(username, password);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">            if (user != null) {</span>
<span class="nc" id="L235">                return true;</span>
            }
<span class="nc" id="L237">        } catch (EntException e) {</span>
<span class="nc" id="L238">            logger.error(&quot;Invalid password for username {}&quot;, username, e);</span>
<span class="nc" id="L239">        }</span>
<span class="nc" id="L240">        return false;</span>
    }

    private UserDetails extractUser(String username) {
<span class="nc" id="L244">        UserDetails user = null;</span>
        try {
<span class="nc" id="L246">            user = this.getUserManager().getUser(username);</span>
<span class="nc" id="L247">        } catch (EntException e) {</span>
<span class="nc" id="L248">            logger.error(&quot;Error loading user {}&quot;, username, e);</span>
<span class="nc" id="L249">            throw new RestServerError(&quot;Error loading user&quot;, e);</span>
<span class="nc" id="L250">        }</span>
<span class="nc" id="L251">        return user;</span>
    }

    @Override
    protected String getDefaultSortProperty() {
<span class="nc" id="L256">        return &quot;username&quot;;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>