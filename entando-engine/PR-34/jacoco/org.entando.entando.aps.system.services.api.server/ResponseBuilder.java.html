<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ResponseBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Entando Core: Engine</a> &gt; <a href="index.source.html" class="el_package">org.entando.entando.aps.system.services.api.server</a> &gt; <span class="el_source">ResponseBuilder.java</span></div><h1>ResponseBuilder.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2015-Present Entando Inc. (http://www.entando.com) All rights reserved.
 *
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 */
package org.entando.entando.aps.system.services.api.server;

import java.io.InputStream;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.ArrayList;
import java.util.List;
import java.util.Properties;

import javax.servlet.ServletContext;
import javax.ws.rs.core.Response;

import org.entando.entando.aps.system.services.api.IApiCatalogManager;
import org.entando.entando.aps.system.services.api.IApiErrorCodes;
import org.entando.entando.aps.system.services.api.model.AbstractApiResponse;
import org.entando.entando.aps.system.services.api.model.ApiError;
import org.entando.entando.aps.system.services.api.model.ApiException;
import org.entando.entando.aps.system.services.api.model.ApiMethod;
import org.entando.entando.aps.system.services.api.model.ApiMethodParameter;
import org.entando.entando.aps.system.services.api.model.ApiMethodResult;
import org.entando.entando.aps.system.services.api.model.StringApiResponse;
import org.entando.entando.ent.util.EntLogging.EntLogger;
import org.entando.entando.ent.util.EntLogging.EntLogFactory;
import org.entando.entando.ent.util.EntSanitization;
import org.springframework.beans.BeansException;
import org.springframework.beans.factory.BeanFactory;
import org.springframework.beans.factory.BeanFactoryAware;
import org.springframework.core.io.Resource;
import org.springframework.web.context.ServletContextAware;

import com.agiletec.aps.system.common.renderer.IVelocityRenderer;
import org.entando.entando.ent.exception.EntException;
import com.agiletec.aps.util.ApsWebApplicationUtils;
import com.agiletec.aps.util.FileTextReader;

/**
 * @author E.Santoboni
 */
<span class="nc" id="L52">public class ResponseBuilder implements IResponseBuilder, BeanFactoryAware, ServletContextAware {</span>
   
<span class="nc" id="L54">	private static final EntLogger _logger = EntLogFactory.getSantiziedLogger(ApiRestStatusServer.class);</span>
	
	@Override
    @Deprecated
    public Object createResponse(String resourceName, Properties parameters) throws EntException {
<span class="nc" id="L59">        Object apiResponse = null;</span>
        try {
<span class="nc" id="L61">            ApiMethod method = this.extractApiMethod(ApiMethod.HttpMethod.GET, null, resourceName);</span>
<span class="nc" id="L62">            apiResponse = this.createResponse(method, parameters);</span>
<span class="nc" id="L63">        } catch (ApiException e) {</span>
<span class="nc" id="L64">        	_logger.error(&quot;Error creating response for method GET, resource '{}'&quot;, resourceName, e);</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">            if (apiResponse == null) {</span>
<span class="nc" id="L66">                apiResponse = new StringApiResponse();</span>
            }
<span class="nc" id="L68">            ((AbstractApiResponse) apiResponse).addErrors(e.getErrors());</span>
<span class="nc" id="L69">        }</span>
<span class="nc" id="L70">        return apiResponse;</span>
    }
    
	@Override
    public Object createResponse(ApiMethod method, Properties parameters) throws EntException {
<span class="nc" id="L75">        return createResponse(method, null, parameters);</span>
    }
    
	@Override
    public Object createResponse(ApiMethod method, Object bodyObject, Properties parameters) throws EntException {
<span class="nc" id="L80">        AbstractApiResponse response = null;</span>
        try {
<span class="nc" id="L82">            this.checkParameter(method, parameters);</span>
<span class="nc" id="L83">            Object bean = this.extractBean(method);</span>
<span class="nc" id="L84">            Object masterResult = null;</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">            if (method.getHttpMethod().equals(ApiMethod.HttpMethod.GET)) {</span>
<span class="nc" id="L86">                masterResult = this.invokeGetMethod(method, bean, null, parameters, true);</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">                if (null == masterResult) {</span>
<span class="nc" id="L88">					ApiError error = new ApiError(IApiErrorCodes.API_INVALID_RESPONSE, &quot;Invalid or null Response&quot;, Response.Status.SERVICE_UNAVAILABLE);</span>
<span class="nc" id="L89">                    throw new ApiException(error);</span>
                }
            } else {
<span class="nc" id="L92">                masterResult = this.invokePutPostDeleteMethod(method, bean, parameters, bodyObject);</span>
            }
<span class="nc bnc" id="L94" title="All 2 branches missed.">            if (null == method.getResponseClassName()) {</span>
<span class="nc" id="L95">                return masterResult;</span>
            }
<span class="nc" id="L97">            response = this.buildApiResponseObject(method);</span>
<span class="nc bnc" id="L98" title="All 4 branches missed.">            if (null == response &amp;&amp; (masterResult instanceof String)) {</span>
<span class="nc" id="L99">                return masterResult;</span>
            }
<span class="nc" id="L101">            String htmlResult = this.extractHtmlResult(masterResult, response, method, parameters, bean);</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">            if (masterResult instanceof ApiMethodResult) {</span>
<span class="nc" id="L103">                response.addErrors(((ApiMethodResult) masterResult).getErrors());</span>
<span class="nc" id="L104">                response.setResult(((ApiMethodResult) masterResult).getResult(), htmlResult);</span>
            } else {
<span class="nc" id="L106">                response.setResult(masterResult, htmlResult);</span>
            }
<span class="nc" id="L108">        } catch (ApiException e) {</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">            if (response == null) {</span>
<span class="nc" id="L110">                response = new StringApiResponse();</span>
            }
<span class="nc" id="L112">            response.addErrors(e.getErrors());</span>
<span class="nc" id="L113">            response.setResult(FAILURE, null);</span>
<span class="nc" id="L114">        } catch (Throwable t) {</span>
<span class="nc" id="L115">        	_logger.error(&quot;Error creating response - {}&quot;, this.buildApiSignature(method), t);</span>
<span class="nc" id="L116">			String message = &quot;Error creating response - &quot; + this.buildApiSignature(method);</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">            if (response == null) {</span>
<span class="nc" id="L118">                response = new StringApiResponse();</span>
            }
<span class="nc" id="L120">            ApiError error = new ApiError(IApiErrorCodes.API_METHOD_ERROR, message, Response.Status.INTERNAL_SERVER_ERROR);</span>
<span class="nc" id="L121">            response.addError(error);</span>
<span class="nc" id="L122">            response.setResult(FAILURE, null);</span>
<span class="nc" id="L123">        }</span>
<span class="nc" id="L124">        return response;</span>
    }

    private String extractHtmlResult(Object masterResult,
            AbstractApiResponse apiResponse, ApiMethod apiMethod, Properties parameters, Object bean) {
<span class="nc" id="L129">        String htmlResult = null;</span>
        try {
<span class="nc" id="L131">            htmlResult = (String) this.invokeGetMethod(apiMethod, bean, &quot;ToHtml&quot;, parameters, false);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">            if (null != htmlResult) {</span>
<span class="nc" id="L133">                return htmlResult;</span>
            }
<span class="nc" id="L135">            String template = this.extractTemplate(apiMethod);</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">            if (null == template) {</span>
<span class="nc" id="L137">                return null;</span>
            }
<span class="nc" id="L139">            htmlResult = this.getVelocityRenderer().render(masterResult, template);</span>
<span class="nc" id="L140">        } catch (ApiException t) {</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">            if (null != t.getErrors()) {</span>
<span class="nc" id="L142">                apiResponse.addErrors(t.getErrors());</span>
            } else {
<span class="nc" id="L144">            	_logger.error(&quot;Error creating html response - {}&quot;, this.buildApiSignature(apiMethod), t);</span>
			}
<span class="nc" id="L146">        } catch (Throwable t) {</span>
<span class="nc" id="L147">        	_logger.error(&quot;Error creating html response - {}&quot;, this.buildApiSignature(apiMethod), t);</span>
<span class="nc" id="L148">        }</span>
<span class="nc" id="L149">        return htmlResult;</span>
    }

    protected String extractTemplate(ApiMethod apiMethod) throws Exception {
<span class="nc" id="L153">        String template = null;</span>
<span class="nc" id="L154">        InputStream is = null;</span>
        try {
<span class="nc" id="L156">            StringBuilder path = new StringBuilder(&quot;classpath*:/api/&quot;);</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">            if (null != apiMethod.getPluginCode()) {</span>
<span class="nc" id="L158">                path.append(&quot;plugins/&quot;).append(apiMethod.getPluginCode()).append(&quot;/&quot;);</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">            } else if (!apiMethod.getSource().equalsIgnoreCase(&quot;core&quot;)) {</span>
<span class="nc" id="L160">                path.append(apiMethod.getSource()).append(&quot;/&quot;);</span>
            }
<span class="nc" id="L162">            path.append(&quot;aps/get/&quot;);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">			if (null != apiMethod.getNamespace()) {</span>
<span class="nc" id="L164">				path.append(apiMethod.getNamespace()).append(&quot;/&quot;);</span>
			}
<span class="nc" id="L166">			path.append(apiMethod.getResourceName()).append(&quot;/description-item.vm&quot;);</span>
<span class="nc" id="L167">            Resource[] resources = ApsWebApplicationUtils.getResources(path.toString(), this.getServletContext());</span>
<span class="nc bnc" id="L168" title="All 4 branches missed.">            if (null != resources &amp;&amp; resources.length == 1) {</span>
<span class="nc" id="L169">                Resource resource = resources[0];</span>
<span class="nc" id="L170">                is = resource.getInputStream();</span>
            }
<span class="nc bnc" id="L172" title="All 2 branches missed.">            if (null == is) {</span>
<span class="nc" id="L173">                _logger.debug(&quot;Null Input Stream - template file path {}&quot;, path.toString());</span>
<span class="nc" id="L174">                return null;</span>
            }
<span class="nc" id="L176">            template = FileTextReader.getText(is);</span>
<span class="nc" id="L177">        } catch (Throwable t) {</span>
<span class="nc" id="L178">            _logger.error(&quot;Error extracting template - {}&quot;, this.buildApiSignature(apiMethod), t);</span>
        } finally {
<span class="nc bnc" id="L180" title="All 2 branches missed.">            if (null != is) {</span>
<span class="nc" id="L181">                is.close();</span>
            }
        }
<span class="nc" id="L184">        return template;</span>
    }

    private void checkParameter(ApiMethod apiMethod, Properties parameters) throws ApiException, Throwable {
        try {
<span class="nc" id="L189">            List&lt;ApiMethodParameter&gt; apiParameters = apiMethod.getParameters();</span>
<span class="nc bnc" id="L190" title="All 4 branches missed.">            if (null == apiParameters || apiParameters.isEmpty()) {</span>
<span class="nc" id="L191">                return;</span>
            }
<span class="nc" id="L193">            List&lt;ApiError&gt; errors = new ArrayList&lt;ApiError&gt;();</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">            for (int i = 0; i &lt; apiParameters.size(); i++) {</span>
<span class="nc" id="L195">                ApiMethodParameter apiParam = apiParameters.get(i);</span>
<span class="nc" id="L196">                String paramName = apiParam.getKey();</span>
<span class="nc" id="L197">                Object value = parameters.get(paramName);</span>
<span class="nc bnc" id="L198" title="All 6 branches missed.">                if (apiParam.isRequired() &amp;&amp; (null == value || value.toString().trim().length() == 0)) {</span>
<span class="nc" id="L199">                    errors.add(new ApiError(IApiErrorCodes.API_PARAMETER_REQUIRED, &quot;Parameter '&quot; + paramName + &quot;' is required&quot;, Response.Status.BAD_REQUEST));</span>
                }
            }
<span class="nc bnc" id="L202" title="All 2 branches missed.">            if (!errors.isEmpty()) {</span>
<span class="nc" id="L203">                throw new ApiException(errors);</span>
            }
<span class="nc" id="L205">        } catch (ApiException t) {</span>
<span class="nc" id="L206">            throw t;</span>
<span class="nc" id="L207">        } catch (Throwable t) {</span>
<span class="nc" id="L208">        	_logger.error(&quot;Error checking api parameters&quot;, t);</span>
<span class="nc" id="L209">            throw new EntException(&quot;Internal Error&quot;, t);</span>
<span class="nc" id="L210">        }</span>
<span class="nc" id="L211">    }</span>

    private AbstractApiResponse buildApiResponseObject(ApiMethod apiMethod) throws ApiException {
<span class="nc" id="L214">        AbstractApiResponse apiResponse = null;</span>
        try {
<span class="nc" id="L216">            Class responseClass = Class.forName(apiMethod.getResponseClassName());</span>
<span class="nc" id="L217">            apiResponse = (AbstractApiResponse) responseClass.newInstance();</span>
<span class="nc" id="L218">        } catch (Exception e) {</span>
<span class="nc" id="L219">        	_logger.error(&quot;Error creating instance of response '{}'&quot;, apiMethod.getResponseClassName(), e);</span>
<span class="nc" id="L220">        }</span>
<span class="nc" id="L221">        return apiResponse;</span>
    }
    
    @Override
    @Deprecated
	public Object invoke(String resourceName, Properties parameters) throws ApiException, EntException {
<span class="nc" id="L227">        Object result = null;</span>
        try {
<span class="nc" id="L229">            ApiMethod api = this.extractApiMethod(ApiMethod.HttpMethod.GET, null, resourceName);</span>
<span class="nc" id="L230">            this.checkParameter(api, parameters);</span>
<span class="nc" id="L231">            Object bean = this.extractBean(api);</span>
<span class="nc" id="L232">            result = this.invokeGetMethod(api, bean, &quot;&quot;, parameters, true);</span>
<span class="nc" id="L233">        } catch (ApiException ae) {</span>
<span class="nc" id="L234">        	_logger.error(&quot;Error invoking method GET for resource '{}'&quot;, resourceName, ae);</span>
<span class="nc" id="L235">            throw ae;</span>
<span class="nc" id="L236">        } catch (Throwable t) {</span>
<span class="nc" id="L237">        	_logger.error(&quot;Error invoking method GET for resource '{}'&quot;, resourceName, t);</span>
<span class="nc" id="L238">            throw new EntException(&quot;Error invoking method GET for resource '&quot; + resourceName + &quot;'&quot;, t);</span>
<span class="nc" id="L239">        }</span>
<span class="nc" id="L240">        return result;</span>
    }
    
	@Override
    public ApiMethod extractApiMethod(ApiMethod.HttpMethod httpMethod, String namespace, String resourceName) throws ApiException {
<span class="nc" id="L245">        ApiMethod api = null;</span>
<span class="nc" id="L246">        String signature = this.buildApiSignature(httpMethod, namespace, resourceName);</span>
		try {
<span class="nc" id="L248">            api = this.getApiCatalogManager().getMethod(httpMethod, namespace, resourceName);</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">            if (null == api) {</span>
<span class="nc" id="L250">				ApiError error = new ApiError(IApiErrorCodes.API_INVALID, signature + &quot; does not exists&quot;, Response.Status.NOT_FOUND);</span>
<span class="nc" id="L251">                throw new ApiException(error);</span>
            }
<span class="nc bnc" id="L253" title="All 2 branches missed.">            if (!api.isActive()) {</span>
<span class="nc" id="L254">				ApiError error = new ApiError(IApiErrorCodes.API_INVALID, signature + &quot; does not exists&quot;, Response.Status.NOT_FOUND);</span>
<span class="nc" id="L255">				throw new ApiException(error);</span>
            }
<span class="nc" id="L257">        } catch (ApiException ae) {</span>
<span class="nc" id="L258">        	_logger.error(&quot;Error extracting api method {}&quot;,</span>
<span class="nc" id="L259">                    this.buildApiSignature(httpMethod, namespace, resourceName), ae);</span>
<span class="nc" id="L260">            throw ae;</span>
<span class="nc" id="L261">        } catch (Throwable t) {</span>
<span class="nc" id="L262">        	_logger.error(&quot;Error extracting api method {}&quot;,</span>
<span class="nc" id="L263">                    EntSanitization.sanitize(this.buildApiSignature(httpMethod, namespace, resourceName)), t);</span>
<span class="nc" id="L264">            throw new ApiException(IApiErrorCodes.SERVER_ERROR, signature + &quot; is not supported&quot;, Response.Status.INTERNAL_SERVER_ERROR);</span>
<span class="nc" id="L265">        }</span>
<span class="nc" id="L266">        return api;</span>
    }
    
    private String buildApiSignature(ApiMethod apiMethod) {
<span class="nc" id="L270">        return this.buildApiSignature(apiMethod.getHttpMethod(), apiMethod.getNamespace(), apiMethod.getResourceName());</span>
    }
    
    private String buildApiSignature(ApiMethod.HttpMethod httpMethod, String namespace, String resourceName) {
<span class="nc" id="L274">        StringBuilder buffer = new StringBuilder();</span>
<span class="nc" id="L275">        buffer.append(&quot;Method '&quot;).append(httpMethod.toString()).append(&quot;' Resource '&quot;).append(resourceName).append(&quot;'&quot;);</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">		if (null != namespace) {</span>
<span class="nc" id="L277">			buffer.append(&quot; Namespace '&quot;).append(namespace).append(&quot;'&quot;);</span>
		}
<span class="nc" id="L279">        return buffer.toString();</span>
    }
    
    protected Object extractBean(ApiMethod api) throws EntException, ApiException {
<span class="nc" id="L283">        Object bean = this.getBeanFactory().getBean(api.getSpringBean());</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (null == bean) {</span>
<span class="nc" id="L285">            _logger.error(&quot;Null bean '{}' for api {}&quot;, api.getSpringBean(), this.buildApiSignature(api));</span>
<span class="nc" id="L286">            throw new ApiException(IApiErrorCodes.SERVER_ERROR, this.buildApiSignature(api) + &quot; is not supported&quot;, Response.Status.INTERNAL_SERVER_ERROR);</span>
        }
<span class="nc" id="L288">        return bean;</span>
    }
    
    @Deprecated
    protected Object invokeMethod(ApiMethod api, Object bean,
            String methodSuffix, Properties parameters, boolean throwException) throws ApiException, Throwable {
<span class="nc" id="L294">        return this.invokeGetMethod(api, bean, methodSuffix, parameters, throwException);</span>
    }
    
    protected Object invokeGetMethod(ApiMethod apiMethod, Object bean,
            String methodSuffix, Properties parameters, boolean throwException) throws ApiException, Throwable {
<span class="nc" id="L299">        String methodName = null;</span>
<span class="nc" id="L300">        Object result = null;</span>
        try {
<span class="nc" id="L302">            Class[] parameterTypes = new Class[]{Properties.class};</span>
<span class="nc" id="L303">            Class beanClass = bean.getClass();</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">            methodName = (null != methodSuffix) ? apiMethod.getSpringBeanMethod() + methodSuffix.trim() : apiMethod.getSpringBeanMethod();</span>
<span class="nc" id="L305">            Method method = beanClass.getDeclaredMethod(methodName, parameterTypes);</span>
<span class="nc" id="L306">            result = method.invoke(bean, parameters);</span>
<span class="nc" id="L307">        } catch (NoSuchMethodException e) {</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">            if (throwException) {</span>
<span class="nc" id="L309">            	_logger.error(&quot;No such method '{}' of class '{}'&quot;, methodName, bean.getClass(), e);</span>
<span class="nc" id="L310">                throw new ApiException(IApiErrorCodes.API_METHOD_ERROR, &quot;Method not supported - &quot; + this.buildApiSignature(apiMethod), Response.Status.INTERNAL_SERVER_ERROR);</span>
            }
<span class="nc" id="L312">        } catch (InvocationTargetException e) {</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">            if (e.getTargetException() instanceof ApiException) {</span>
<span class="nc" id="L314">                throw (ApiException) e.getTargetException();</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">            } else if (throwException) {</span>
<span class="nc" id="L316">            	_logger.error(&quot;Error invoking method '{}' of class '{}'&quot;, methodName, bean.getClass());</span>
<span class="nc" id="L317">                throw new ApiException(IApiErrorCodes.API_METHOD_ERROR, &quot;Error invoking Method - &quot; + this.buildApiSignature(apiMethod), Response.Status.INTERNAL_SERVER_ERROR);</span>
            }
<span class="nc" id="L319">        } catch (Throwable t) {</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">            if (throwException) {</span>
<span class="nc" id="L321">            	_logger.error(&quot;Error invoking method - {} {} of class '{}'&quot;, this.buildApiSignature(apiMethod) , methodName, bean.getClass(), t);</span>
<span class="nc" id="L322">                throw t;</span>
            }
<span class="nc" id="L324">        }</span>
<span class="nc" id="L325">        return result;</span>
    }
    
    protected Object invokePutPostDeleteMethod(ApiMethod apiMethod, Object bean,
            Properties parameters, Object bodyObject) throws ApiException, Throwable {
<span class="nc" id="L330">        Object result = null;</span>
        try {
<span class="nc bnc" id="L332" title="All 2 branches missed.">            if (apiMethod.getHttpMethod().equals(ApiMethod.HttpMethod.DELETE)) {</span>
<span class="nc" id="L333">                result = this.invokeDeleteMethod(apiMethod, bean, parameters);</span>
            } else {
<span class="nc" id="L335">                result = this.invokePutPostMethod(apiMethod, bean, parameters, bodyObject);</span>
            }
<span class="nc bnc" id="L337" title="All 2 branches missed.">            if (null != result) return result;</span>
<span class="nc" id="L338">            StringApiResponse response = new StringApiResponse();</span>
<span class="nc" id="L339">            response.setResult(SUCCESS, null);</span>
<span class="nc" id="L340">            result = response;</span>
<span class="nc" id="L341">        } catch (NoSuchMethodException e) {</span>
<span class="nc" id="L342">        	_logger.error(&quot;No such method '{}' of class '{}'&quot;,apiMethod.getSpringBeanMethod(), bean.getClass(), e);</span>
<span class="nc" id="L343">            throw new ApiException(IApiErrorCodes.API_METHOD_ERROR, &quot;Method not supported - &quot; + this.buildApiSignature(apiMethod), Response.Status.INTERNAL_SERVER_ERROR);</span>
<span class="nc" id="L344">        } catch (InvocationTargetException e) {</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">            if (e.getTargetException() instanceof ApiException) {</span>
<span class="nc" id="L346">                throw (ApiException) e.getTargetException();</span>
            } else {
<span class="nc" id="L348">            	_logger.error(&quot;Error invoking method '{}' of class '{}'&quot;,apiMethod.getSpringBeanMethod(), bean.getClass());</span>
<span class="nc" id="L349">                throw new ApiException(IApiErrorCodes.API_METHOD_ERROR, &quot;Error invoking Method - &quot; + this.buildApiSignature(apiMethod), Response.Status.INTERNAL_SERVER_ERROR);</span>
            }
<span class="nc" id="L351">        } catch (Throwable t) {</span>
<span class="nc" id="L352">        	_logger.error(&quot;Error invoking method '{}' of class '{}'&quot;,apiMethod.getSpringBeanMethod(), bean.getClass(), t);</span>
<span class="nc" id="L353">            throw t;</span>
<span class="nc" id="L354">        }</span>
<span class="nc" id="L355">        return result;</span>
    }
    
    private Object invokePutPostMethod(ApiMethod api, Object bean, 
            Properties parameters, Object bodyObject) throws NoSuchMethodException, InvocationTargetException, Throwable {
<span class="nc" id="L360">        Object result = null;</span>
<span class="nc" id="L361">        Class beanClass = bean.getClass();</span>
<span class="nc" id="L362">        String methodName = api.getSpringBeanMethod();</span>
        try {
<span class="nc" id="L364">            Class[] parameterTypes = new Class[]{bodyObject.getClass(), Properties.class};</span>
<span class="nc" id="L365">            Method method = beanClass.getDeclaredMethod(methodName, parameterTypes);</span>
<span class="nc" id="L366">            result = method.invoke(bean, bodyObject, parameters);</span>
<span class="nc" id="L367">        } catch (NoSuchMethodException e) {</span>
            //the first exception of type &quot;NoSuchMethodException&quot; will not catched... the second yes
<span class="nc" id="L369">            Class[] parameterTypes = new Class[]{bodyObject.getClass()};</span>
<span class="nc" id="L370">            Method method = beanClass.getDeclaredMethod(methodName, parameterTypes);</span>
<span class="nc" id="L371">            result = method.invoke(bean, bodyObject);</span>
<span class="nc" id="L372">        } catch (InvocationTargetException e) {</span>
<span class="nc" id="L373">            throw e;</span>
<span class="nc" id="L374">        } catch (Throwable t) {</span>
<span class="nc" id="L375">            throw t;</span>
<span class="nc" id="L376">        }</span>
<span class="nc" id="L377">        return result;</span>
    }
    
    private Object invokeDeleteMethod(ApiMethod api, Object bean, 
            Properties parameters) throws NoSuchMethodException, InvocationTargetException, Throwable {
<span class="nc" id="L382">        Class[] parameterTypes = new Class[]{Properties.class};</span>
<span class="nc" id="L383">        Class beanClass = bean.getClass();</span>
<span class="nc" id="L384">        String methodName = api.getSpringBeanMethod();</span>
<span class="nc" id="L385">        Method method = beanClass.getDeclaredMethod(methodName, parameterTypes);</span>
<span class="nc" id="L386">        return method.invoke(bean, parameters);</span>
    }
    
    protected IApiCatalogManager getApiCatalogManager() {
<span class="nc" id="L390">        return _apiCatalogManager;</span>
    }
    public void setApiCatalogManager(IApiCatalogManager apiCatalogManager) {
<span class="nc" id="L393">        this._apiCatalogManager = apiCatalogManager;</span>
<span class="nc" id="L394">    }</span>

    protected IVelocityRenderer getVelocityRenderer() {
<span class="nc" id="L397">        return _velocityRenderer;</span>
    }
    public void setVelocityRenderer(IVelocityRenderer velocityRenderer) {
<span class="nc" id="L400">        this._velocityRenderer = velocityRenderer;</span>
<span class="nc" id="L401">    }</span>

    protected BeanFactory getBeanFactory() {
<span class="nc" id="L404">        return this._beanFactory;</span>
    }
	@Override
    public void setBeanFactory(BeanFactory beanFactory) throws BeansException {
<span class="nc" id="L408">        this._beanFactory = beanFactory;</span>
<span class="nc" id="L409">    }</span>

    protected ServletContext getServletContext() {
<span class="nc" id="L412">        return this._servletContext;</span>
    }
	@Override
    public void setServletContext(ServletContext servletContext) {
<span class="nc" id="L416">        this._servletContext = servletContext;</span>
<span class="nc" id="L417">    }</span>
    
    private IApiCatalogManager _apiCatalogManager;
    private IVelocityRenderer _velocityRenderer;
    private BeanFactory _beanFactory;
    private ServletContext _servletContext;
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>