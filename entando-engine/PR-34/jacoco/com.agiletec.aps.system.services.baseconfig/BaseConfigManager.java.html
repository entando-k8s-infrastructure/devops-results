<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BaseConfigManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Entando Core: Engine</a> &gt; <a href="index.source.html" class="el_package">com.agiletec.aps.system.services.baseconfig</a> &gt; <span class="el_source">BaseConfigManager.java</span></div><h1>BaseConfigManager.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2015-Present Entando Inc. (http://www.entando.com) All rights reserved.
 *
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 */
package com.agiletec.aps.system.services.baseconfig;

import java.io.IOException;
import java.io.InputStream;
import java.util.Map;
import java.util.Properties;

import javax.servlet.ServletContext;

import com.agiletec.aps.system.SystemConstants;
import com.agiletec.aps.system.common.AbstractService;
import org.entando.entando.ent.exception.EntException;
import com.agiletec.aps.system.services.baseconfig.cache.IConfigManagerCacheWrapper;
import de.mkammerer.argon2.Argon2Factory;
import java.util.HashMap;
import org.apache.commons.lang3.StringUtils;
import org.entando.entando.ent.util.EntLogging.EntLogger;
import org.entando.entando.ent.util.EntLogging.EntLogFactory;
import org.springframework.web.context.ServletContextAware;

/**
 * Servizio di configurazione. Carica da db e rende disponibile la
 * configurazione. La configurazione è costituita da voci (items), individuate
 * da un nome, e da parametri, anch'essi individuati da un nome. I parametri
 * sono stringhe semplici, le voci possono essere testi XML complessi. In
 * particolare, una delle voci contiene la configurazione dei parametri in forma
 * di testo XML. L'insieme dei parametri comprende anche le proprietà di
 * inizializzazione, passate alla factory del contesto di sistema; i valori di
 * queste possono essere sovrascritti dai valori di eventuali parametri omonimi.
 *
 * @author M.Diana - E.Santoboni
 */
<span class="nc" id="L46">public class BaseConfigManager extends AbstractService implements ConfigInterface, ServletContextAware {</span>

<span class="nc" id="L48">    private static final EntLogger logger = EntLogFactory.getSanitizedLogger(BaseConfigManager.class);</span>

    private Map&lt;String, String&gt; systemParams;

<span class="nc" id="L52">    private String securityConfigPath = null;</span>

    private IConfigManagerCacheWrapper cacheWrapper;

<span class="nc" id="L56">    private boolean legacyPasswordsUpdated = false;</span>

    private IConfigItemDAO configDao;

    private ServletContext servletContext;

    @Override
    public void init() throws Exception {
<span class="nc" id="L64">        String version = this.getSystemParams().get(SystemConstants.INIT_PROP_CONFIG_VERSION);</span>
<span class="nc" id="L65">        this.getCacheWrapper().initCache(this.getConfigDAO(), version);</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">        legacyPasswordsUpdated = (this.getParam(LEGACY_PASSWORDS_UPDATED) != null</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">                &amp;&amp; this.getParam(LEGACY_PASSWORDS_UPDATED).equalsIgnoreCase(&quot;true&quot;));</span>
<span class="nc" id="L68">        Properties props = this.extractSecurityConfiguration();</span>
<span class="nc" id="L69">        this.checkSecurityConfiguration(props);</span>
<span class="nc" id="L70">        logger.debug(&quot;{} ready. Initialized&quot;, this.getClass().getName());</span>
<span class="nc" id="L71">    }</span>

    /**
     * Restituisce il valore di una voce della tabella di sistema. Il valore può
     * essere un XML complesso.
     *
     * @param name Il nome della voce di configurazione.
     * @return Il valore della voce di configurazione.
     */
    @Override
    public String getConfigItem(String name) {
<span class="nc" id="L82">        return this.getCacheWrapper().getConfigItem(name);</span>
    }

    /**
     * Aggiorna un'item di configurazione nella mappa della configurazione degli
     * item e nel db.
     *
     * @param itemName Il nome dell'item da aggiornare.
     * @param config La nuova configurazione.
     * @throws EntException
     */
    @Override
    public void updateConfigItem(String itemName, String config) throws EntException {
<span class="nc" id="L95">        String version = this.getSystemParams().get(SystemConstants.INIT_PROP_CONFIG_VERSION);</span>
        try {
<span class="nc" id="L97">            this.getConfigDAO().updateConfigItem(itemName, config, version);</span>
<span class="nc" id="L98">            this.refresh();</span>
<span class="nc" id="L99">        } catch (Throwable t) {</span>
<span class="nc" id="L100">            logger.error(&quot;Error while updating item {}&quot;, itemName, t);</span>
<span class="nc" id="L101">            throw new EntException(&quot;Error while updating item&quot;, t);</span>
<span class="nc" id="L102">        }</span>
<span class="nc" id="L103">    }</span>

    /**
     * Restituisce il valore di un parametro di configurazione. I parametri sono
     * desunti dalla voce &quot;params&quot; della tabella di sistema.
     *
     * @param name Il nome del parametro di configurazione.
     * @return Il valore del parametro di configurazione.
     */
    @Override
    public String getParam(String name) {
<span class="nc" id="L114">        String param = this.getSystemParams().get(name);</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (null != param) {</span>
<span class="nc" id="L116">            return param;</span>
        } else {
<span class="nc" id="L118">            return this.getCacheWrapper().getParam(name);</span>
        }
    }

    protected Properties extractSecurityConfiguration() throws IOException {
<span class="nc" id="L123">        Properties props = new Properties();</span>
<span class="nc" id="L124">        try (InputStream is = this.getServletContext().getResourceAsStream(this.getSecurityConfigPath())) {</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">            if (null == is) {</span>
<span class="nc" id="L126">                throw new RuntimeException(&quot;Null security configuration inside &quot; + this.getSecurityConfigPath());</span>
            }
<span class="nc" id="L128">            props.load(is);</span>
        }
<span class="nc" id="L130">        return props;</span>
    }

    protected void checkSecurityConfiguration(Properties mainProps) {
<span class="nc" id="L134">        String algoType = null;</span>
        try {
<span class="nc" id="L136">            algoType = Argon2Factory.Argon2Types.valueOf(mainProps.getProperty(ALGO_TYPE_PARAM_NAME)).name();</span>
<span class="nc" id="L137">        } catch (Exception e) {</span>
<span class="nc" id="L138">            String defaultAlgoType = Argon2Factory.Argon2Types.ARGON2i.name();</span>
<span class="nc" id="L139">            logger.error(&quot;Invalid value for Argon2 hashType '{}'; the default value is '{}'&quot;, algoType, defaultAlgoType, e);</span>
<span class="nc" id="L140">            throw new RuntimeException(&quot;Invalid value for Argon2 hashType '&quot; + algoType + &quot;'; the default value is '&quot; + defaultAlgoType + &quot;'&quot;, e);</span>
<span class="nc" id="L141">        }</span>
<span class="nc" id="L142">        System.getProperties().setProperty(ALGO_TYPE_PARAM_NAME, algoType);</span>

<span class="nc" id="L144">        Integer hashLength = Integer.valueOf(mainProps.getProperty(ALGO_HASH_LENGTH_PARAM_NAME));</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">        if (hashLength &lt; 4) {</span>
<span class="nc" id="L146">            throw new RuntimeException(&quot;Hash length must be greater than 4 - value '&quot; + hashLength + &quot;'&quot;);</span>
        }
<span class="nc" id="L148">        System.getProperties().setProperty(ALGO_HASH_LENGTH_PARAM_NAME, String.valueOf(hashLength));</span>

<span class="nc" id="L150">        Integer saltLength = Integer.valueOf(mainProps.getProperty(ALGO_SALT_LENGTH_PARAM_NAME));</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (saltLength &lt; 8) {</span>
<span class="nc" id="L152">            throw new RuntimeException(&quot;Salt length must be greater than 8 - value '&quot; + saltLength + &quot;'&quot;);</span>
        }
<span class="nc" id="L154">        System.getProperties().setProperty(ALGO_SALT_LENGTH_PARAM_NAME, String.valueOf(saltLength));</span>

<span class="nc" id="L156">        Integer iterations = Integer.valueOf(mainProps.getProperty(ALGO_ITERATIONS_PARAM_NAME));</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">        if (iterations &lt; 1) {</span>
<span class="nc" id="L158">            throw new RuntimeException(&quot;Iterations number must be greater than 1 - value '&quot; + iterations + &quot;'&quot;);</span>
        }
<span class="nc" id="L160">        System.getProperties().setProperty(ALGO_ITERATIONS_PARAM_NAME, String.valueOf(iterations));</span>

<span class="nc" id="L162">        Integer parallelism = Integer.valueOf(mainProps.getProperty(ALGO_PARALLELISM_PARAM_NAME));</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (parallelism &lt; 1) {</span>
<span class="nc" id="L164">            throw new RuntimeException(&quot;Parallelism number must be greater than 1 - value '&quot; + parallelism + &quot;'&quot;);</span>
        }
<span class="nc" id="L166">        System.getProperties().setProperty(ALGO_PARALLELISM_PARAM_NAME, String.valueOf(parallelism));</span>

<span class="nc" id="L168">        Integer memory = Integer.valueOf(mainProps.getProperty(ALGO_MEMORY_PARAM_NAME));</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">        if (memory &lt; (8 * parallelism)) {</span>
<span class="nc" id="L170">            throw new RuntimeException(&quot;Memory size must be greater than 8xparallelism - value '&quot; + memory + &quot;'&quot;);</span>
        }
<span class="nc" id="L172">        System.getProperties().setProperty(ALGO_MEMORY_PARAM_NAME, String.valueOf(memory));</span>

<span class="nc" id="L174">        String defaultEncryptionKey = mainProps.getProperty(ALGO_DEFAULT_KEY);</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(defaultEncryptionKey)) {</span>
<span class="nc" id="L176">            System.getProperties().setProperty(ALGO_DEFAULT_KEY, defaultEncryptionKey);</span>
        }
<span class="nc" id="L178">    }</span>

    @Override
    public void updateParam(String name, String value) throws EntException {
<span class="nc bnc" id="L182" title="All 4 branches missed.">        if (StringUtils.isEmpty(name) || StringUtils.isEmpty(value)) {</span>
<span class="nc" id="L183">            return;</span>
        }
<span class="nc" id="L185">        Map&lt;String, String&gt; params = new HashMap&lt;&gt;();</span>
<span class="nc" id="L186">        params.put(name, value);</span>
<span class="nc" id="L187">        this.updateParams(params);</span>
<span class="nc" id="L188">    }</span>

    @Override
    public void updateParams(Map&lt;String, String&gt; params) throws EntException {
<span class="nc bnc" id="L192" title="All 2 branches missed.">        if (null == params) {</span>
<span class="nc" id="L193">            return;</span>
        }
        try {
<span class="nc" id="L196">            String xmlParams = this.getConfigItem(SystemConstants.CONFIG_ITEM_PARAMS);</span>
<span class="nc" id="L197">            String newXmlParams = SystemParamsUtils.getNewXmlParams(xmlParams, params, false);</span>
<span class="nc" id="L198">            this.updateConfigItem(SystemConstants.CONFIG_ITEM_PARAMS, newXmlParams);</span>
<span class="nc" id="L199">        } catch (Exception e) {</span>
<span class="nc" id="L200">            logger.error(&quot;Error while updating parameters {}&quot;, params, e);</span>
<span class="nc" id="L201">            throw new EntException(&quot;Error while updating parameters&quot;, e);</span>
<span class="nc" id="L202">        }</span>
<span class="nc" id="L203">    }</span>

    /**
     * Restituisce il dao in uso al manager.
     *
     * @return Il dao in uso al manager.
     */
    protected IConfigItemDAO getConfigDAO() {
<span class="nc" id="L211">        return configDao;</span>
    }

    /**
     * Setta il dao in uso al manager.
     *
     * @param configDao Il dao in uso al manager.
     */
    public void setConfigDAO(IConfigItemDAO configDao) {
<span class="nc" id="L220">        this.configDao = configDao;</span>
<span class="nc" id="L221">    }</span>

    protected Map&lt;String, String&gt; getSystemParams() {
<span class="nc" id="L224">        return this.systemParams;</span>
    }

    public void setSystemParams(Map&lt;String, String&gt; systemParams) {
<span class="nc" id="L228">        this.systemParams = systemParams;</span>
<span class="nc" id="L229">    }</span>

    protected String getSecurityConfigPath() {
<span class="nc" id="L232">        return securityConfigPath;</span>
    }

    public void setSecurityConfigPath(String securityConfigPath) {
<span class="nc" id="L236">        this.securityConfigPath = securityConfigPath;</span>
<span class="nc" id="L237">    }</span>

    protected IConfigManagerCacheWrapper getCacheWrapper() {
<span class="nc" id="L240">        return cacheWrapper;</span>
    }

    public void setCacheWrapper(IConfigManagerCacheWrapper cacheWrapper) {
<span class="nc" id="L244">        this.cacheWrapper = cacheWrapper;</span>
<span class="nc" id="L245">    }</span>

    @Override
    public boolean areLegacyPasswordsUpdated() {
<span class="nc" id="L249">        return legacyPasswordsUpdated;</span>
    }

    public void setLegacyPasswordsUpdated(boolean updated) {
<span class="nc" id="L253">        this.legacyPasswordsUpdated = updated;</span>
<span class="nc" id="L254">    }</span>

    protected ServletContext getServletContext() {
<span class="nc" id="L257">        return servletContext;</span>
    }

    @Override
    public void setServletContext(ServletContext servletContext) {
<span class="nc" id="L262">        this.servletContext = servletContext;</span>
<span class="nc" id="L263">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>