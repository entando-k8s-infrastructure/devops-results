<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DatabaseDumper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Entando Core: Engine</a> &gt; <a href="index.source.html" class="el_package">org.entando.entando.aps.system.init</a> &gt; <span class="el_source">DatabaseDumper.java</span></div><h1>DatabaseDumper.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2015-Present Entando S.r.l. (http://www.entando.com) All rights reserved.
 *
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 */

package org.entando.entando.aps.system.init;

import com.agiletec.aps.system.exception.ApsSystemException;
import com.agiletec.aps.util.DateConverter;
import java.io.BufferedWriter;
import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileWriter;
import java.io.IOException;
import java.io.InputStream;
import java.nio.charset.StandardCharsets;
import java.util.Date;
import java.util.List;
import java.util.Map;
import javax.sql.DataSource;
import org.entando.entando.aps.system.init.model.Component;
import org.entando.entando.aps.system.init.model.DataSourceDumpReport;
import org.entando.entando.aps.system.init.model.SystemInstallationReport;
import org.entando.entando.aps.system.init.model.TableDumpReport;
import org.entando.entando.aps.system.init.util.TableDataUtils;
import org.entando.entando.aps.system.init.util.TableFactory;
import org.entando.entando.aps.system.services.storage.IStorageManager;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeansException;

/**
 * @author E.Santoboni
 */
<span class="nc" id="L45">public class DatabaseDumper extends AbstractDatabaseUtils {</span>

<span class="nc" id="L47">    private static final Logger _logger = LoggerFactory.getLogger(DatabaseDumper.class);</span>

    protected void createBackup(AbstractInitializerManager.Environment environment, SystemInstallationReport installationReport)
            throws ApsSystemException {
        try {
<span class="nc" id="L52">            DataSourceDumpReport report = new DataSourceDumpReport(installationReport);</span>
<span class="nc" id="L53">            long start = System.currentTimeMillis();</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">            String backupSubFolder = (AbstractInitializerManager.Environment.develop.equals(environment))</span>
<span class="nc" id="L55">                    ? environment.toString() : DateConverter.getFormattedDate(new Date(), &quot;yyyyMMddHHmmss&quot;);</span>
<span class="nc" id="L56">            report.setSubFolderName(backupSubFolder);</span>
<span class="nc" id="L57">            List&lt;Component&gt; components = this.getComponents();</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">            for (int i = 0; i &lt; components.size(); i++) {</span>
<span class="nc" id="L59">                Component componentConfiguration = components.get(i);</span>
<span class="nc" id="L60">                this.createBackup(componentConfiguration.getTableMapping(), report, backupSubFolder);</span>
            }
<span class="nc" id="L62">            this.createBackup(this.getEntandoTableMapping(), report, backupSubFolder);</span>
<span class="nc" id="L63">            long time = System.currentTimeMillis() - start;</span>
<span class="nc" id="L64">            report.setRequiredTime(time);</span>
<span class="nc" id="L65">            report.setDate(new Date());</span>
<span class="nc" id="L66">            StringBuilder reportFolder = new StringBuilder(this.getLocalBackupsFolder());</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">            if (null != backupSubFolder) {</span>
<span class="nc" id="L68">                reportFolder.append(backupSubFolder).append(File.separator);</span>
            }
<span class="nc" id="L70">            this.save(DatabaseManager.DUMP_REPORT_FILE_NAME,</span>
<span class="nc" id="L71">                    reportFolder.toString(), report.toXml());</span>
<span class="nc" id="L72">        } catch (Throwable t) {</span>
<span class="nc" id="L73">            _logger.error(&quot;error in &quot;, t);</span>
<span class="nc" id="L74">            throw new ApsSystemException(&quot;Error while creating backup&quot;, t);</span>
<span class="nc" id="L75">        }</span>
<span class="nc" id="L76">    }</span>

    private void createBackup(Map&lt;String, List&lt;String&gt;&gt; tableMapping, DataSourceDumpReport report, String backupSubFolder)
            throws ApsSystemException {
<span class="nc" id="L80">        ClassLoader cl = ComponentManager.getComponentInstallerClassLoader();</span>
<span class="nc bnc" id="L81" title="All 4 branches missed.">        if (null == tableMapping || tableMapping.isEmpty()) {</span>
<span class="nc" id="L82">            return;</span>
        }
        try {
<span class="nc" id="L85">            String[] dataSourceNames = this.extractBeanNames(DataSource.class);</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            for (int j = 0; j &lt; dataSourceNames.length; j++) {</span>
<span class="nc" id="L87">                String dataSourceName = dataSourceNames[j];</span>
<span class="nc" id="L88">                List&lt;String&gt; tableClassNames = tableMapping.get(dataSourceName);</span>
<span class="nc bnc" id="L89" title="All 4 branches missed.">                if (null == tableClassNames || tableClassNames.isEmpty()) {</span>
<span class="nc" id="L90">                    continue;</span>
                }
<span class="nc" id="L92">                DataSource dataSource = (DataSource) this.getBeanFactory().getBean(dataSourceName);</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">                for (int k = 0; k &lt; tableClassNames.size(); k++) {</span>
<span class="nc" id="L94">                    String tableClassName = tableClassNames.get(k);</span>
<span class="nc" id="L95">                    Class tableClass = null;</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">                    if (cl != null) {</span>
<span class="nc" id="L97">                        tableClass = Class.forName(tableClassName, true, cl);</span>
                    } else {
<span class="nc" id="L99">                        tableClass = Class.forName(tableClassName);</span>
                    }
<span class="nc" id="L101">                    String tableName = TableFactory.getTableName(tableClass);</span>
<span class="nc" id="L102">                    this.dumpTableData(tableName, dataSourceName, dataSource, report, backupSubFolder);</span>
                }
            }
<span class="nc" id="L105">        } catch (BeansException | ClassNotFoundException | ApsSystemException t) {</span>
<span class="nc" id="L106">            _logger.error(&quot;Error while creating backup&quot;, t);</span>
<span class="nc" id="L107">            throw new ApsSystemException(&quot;Error while creating backup&quot;, t);</span>
<span class="nc" id="L108">        }</span>
<span class="nc" id="L109">    }</span>

    protected void dumpTableData(String tableName, String dataSourceName,
            DataSource dataSource, DataSourceDumpReport report, String backupSubFolder) throws ApsSystemException {
<span class="nc" id="L113">        String filename = tableName + &quot;.sql&quot;;</span>
<span class="nc" id="L114">        File tempFile = null;</span>
<span class="nc" id="L115">        FileWriter fileWriter = null;</span>
<span class="nc" id="L116">        BufferedWriter bufferWriter = null;</span>
        try {
<span class="nc" id="L118">            tempFile = this.createEmptyTempFile(filename);</span>
<span class="nc" id="L119">            fileWriter = new FileWriter(tempFile.getAbsolutePath());</span>
<span class="nc" id="L120">            bufferWriter = new BufferedWriter(fileWriter);</span>
<span class="nc" id="L121">            TableDumpReport tableDumpReport = TableDataUtils.dumpTable(bufferWriter, dataSource, tableName);</span>
<span class="nc" id="L122">            report.addTableReport(dataSourceName, tableDumpReport);</span>
<span class="nc" id="L123">        } catch (IOException t) {</span>
<span class="nc" id="L124">            _logger.error(&quot;Error dumping table '{}' - datasource '{}'&quot;, tableName, dataSourceName, t);</span>
<span class="nc" id="L125">            throw new ApsSystemException(&quot;Error dumping table '&quot; + tableName + &quot;' - datasource '&quot; + dataSourceName + &quot;'&quot;, t);</span>
        } finally {
            try {
<span class="nc bnc" id="L128" title="All 2 branches missed.">                if (null != bufferWriter) {</span>
<span class="nc" id="L129">                    bufferWriter.close();</span>
                }
<span class="nc bnc" id="L131" title="All 2 branches missed.">                if (null != fileWriter) {</span>
<span class="nc" id="L132">                    fileWriter.close();</span>
                }
<span class="nc" id="L134">            } catch (IOException t2) {</span>
<span class="nc" id="L135">                _logger.error(&quot;Error closing FileWriter and BufferedWriter of file '{}'&quot;, filename, t2);</span>
<span class="nc" id="L136">                throw new ApsSystemException(&quot;Error closing FileWriter and BufferedWriter&quot;, t2);</span>
<span class="nc" id="L137">            }</span>
        }
<span class="nc" id="L139">        this.finalizeDumpFile(filename, dataSourceName, backupSubFolder, tempFile);</span>
<span class="nc" id="L140">    }</span>

    private void finalizeDumpFile(String filename, String dataSourceName, String backupSubFolder, File tempFile) throws ApsSystemException {
<span class="nc" id="L143">        InputStream is = null;</span>
        try {
<span class="nc" id="L145">            StringBuilder dirName = new StringBuilder(this.getLocalBackupsFolder());</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">            if (null != backupSubFolder) {</span>
<span class="nc" id="L147">                dirName.append(backupSubFolder).append(File.separator);</span>
            }
<span class="nc" id="L149">            dirName.append(dataSourceName).append(File.separator);</span>
<span class="nc" id="L150">            is = new FileInputStream(new File(tempFile.getAbsolutePath()));</span>
<span class="nc" id="L151">            this.save(filename, dirName.toString(), is);</span>
<span class="nc" id="L152">        } catch (ApsSystemException | IOException t) {</span>
<span class="nc" id="L153">            _logger.error(&quot;Error saving dump file '{}'&quot;, tempFile.getName(), t);</span>
<span class="nc" id="L154">            throw new ApsSystemException(&quot;Error saving dump file '&quot; + tempFile.getName() + &quot;'&quot;, t);</span>
        } finally {
            try {
<span class="nc bnc" id="L157" title="All 2 branches missed.">                if (null != is) {</span>
<span class="nc" id="L158">                    is.close();</span>
                }
<span class="nc" id="L160">            } catch (IOException t2) {</span>
<span class="nc" id="L161">                _logger.error(&quot;Error closing FileInputstream of temp file '{}'&quot;, filename, t2);</span>
<span class="nc" id="L162">            }</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">            if (null != tempFile) {</span>
<span class="nc" id="L164">                boolean deleted = tempFile.delete();</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">                if (!deleted) {</span>
<span class="nc" id="L166">                    _logger.warn(&quot;Failed to delete temp file {} &quot;, tempFile.getAbsolutePath());</span>
                }
            }
        }
<span class="nc" id="L170">    }</span>

    protected File createEmptyTempFile(String filename) throws ApsSystemException {
        try {
<span class="nc" id="L174">            String tempDir = System.getProperty(&quot;java.io.tmpdir&quot;);</span>
<span class="nc" id="L175">            String filePath = tempDir + File.separator + filename;</span>
<span class="nc" id="L176">            File file = new File(filePath);</span>
<span class="nc" id="L177">            boolean created = file.createNewFile();</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">            if (!created) {</span>
<span class="nc" id="L179">                _logger.warn(&quot;Failed to create a temp file {} &quot;, created);</span>
            }
<span class="nc" id="L181">            return file;</span>
<span class="nc" id="L182">        } catch (Throwable t) {</span>
<span class="nc" id="L183">            _logger.error(&quot;Error saving new temp file '{}'&quot;, filename, t);</span>
<span class="nc" id="L184">            throw new ApsSystemException(&quot;Error saving new temp file '&quot; + filename + &quot;'&quot;, t);</span>
        }
    }

    protected void save(String filename, String folder, String content) throws ApsSystemException {
<span class="nc" id="L189">        ByteArrayInputStream bais = new ByteArrayInputStream(content.getBytes(StandardCharsets.UTF_8));</span>
<span class="nc" id="L190">        this.save(filename, folder, bais);</span>
<span class="nc" id="L191">    }</span>

    protected void save(String filename, String folder, InputStream is) throws ApsSystemException {
        try {
<span class="nc" id="L195">            IStorageManager storageManager = this.getStorageManager();</span>
<span class="nc" id="L196">            String path = folder + filename;</span>
<span class="nc" id="L197">            storageManager.saveFile(path, true, is);</span>
<span class="nc" id="L198">        } catch (Throwable t) {</span>
<span class="nc" id="L199">            _logger.error(&quot;Error saving backup '{}'&quot;, filename, t);</span>
<span class="nc" id="L200">            throw new ApsSystemException(&quot;Error saving backup '&quot; + filename + &quot;'&quot;, t);</span>
<span class="nc" id="L201">        }</span>
<span class="nc" id="L202">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>