<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PageDAO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Entando Core: Engine</a> &gt; <a href="index.source.html" class="el_package">com.agiletec.aps.system.services.page</a> &gt; <span class="el_source">PageDAO.java</span></div><h1>PageDAO.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2015-Present Entando Inc. (http://www.entando.com) All rights reserved.
 *
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 */

package com.agiletec.aps.system.services.page;

import com.agiletec.aps.system.common.AbstractDAO;
import com.agiletec.aps.system.exception.ApsSystemException;
import com.agiletec.aps.system.services.pagemodel.IPageModelManager;
import com.agiletec.aps.system.services.pagemodel.PageModel;
import com.agiletec.aps.util.ApsProperties;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Timestamp;
import java.sql.Types;
import java.util.ArrayList;
import java.util.Date;
import java.util.Iterator;
import java.util.List;
import org.entando.entando.aps.system.init.model.portdb.PageMetadataDraft;
import org.entando.entando.aps.system.init.model.portdb.PageMetadataOnline;
import org.entando.entando.aps.system.init.model.portdb.WidgetConfig;
import org.entando.entando.aps.system.init.model.portdb.WidgetConfigDraft;
import org.entando.entando.aps.system.services.widgettype.IWidgetTypeManager;
import org.entando.entando.aps.system.services.widgettype.WidgetType;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Data Access Object for the 'page' objects
 *
 * @author M.Diana - E.Santoboni - E.Mezzano
 */
<span class="nc" id="L47">public class PageDAO extends AbstractDAO implements IPageDAO {</span>

<span class="nc" id="L49">    private static final Logger _logger = LoggerFactory.getLogger(PageDAO.class);</span>
    // attenzione: l'ordinamento deve rispettare prima l'ordine delle pagine
    // figlie nelle pagine madri, e poi l'ordine dei widget nella pagina.
    private static final String ALL_PAGES = &quot;SELECT p.parentcode, p.pos, p.code, &quot;
            + &quot;onl.groupcode, onl.titles, onl.modelcode, onl.showinmenu, onl.extraconfig, onl.updatedat, &quot;
            + &quot;drf.groupcode, drf.titles, drf.modelcode, drf.showinmenu, drf.extraconfig, drf.updatedat FROM pages p LEFT JOIN &quot;
            + PageMetadataOnline.TABLE_NAME + &quot; onl ON p.code = onl.code LEFT JOIN &quot; + PageMetadataDraft.TABLE_NAME
            + &quot; drf ON p.code = drf.code ORDER BY p.parentcode, p.pos, p.code &quot;;
    private static final String ALL_WIDGETS_START = &quot;SELECT w.pagecode, w.framepos, w.widgetcode, w.config &quot; + &quot;FROM pages p JOIN &quot;;
    private static final String ALL_WIDGETS_END = &quot; w ON p.code = w.pagecode &quot; + &quot;ORDER BY p.parentcode, p.pos, p.code, w.framepos &quot;;
    private static final String ALL_WIDGETS_ONLINE = ALL_WIDGETS_START + WidgetConfig.TABLE_NAME + ALL_WIDGETS_END;
    private static final String ALL_WIDGETS_DRAFT = ALL_WIDGETS_START + WidgetConfigDraft.TABLE_NAME + ALL_WIDGETS_END;
    private static final String ADD_PAGE = &quot;INSERT INTO pages(code, parentcode, pos) VALUES ( ? , ? , ? )&quot;;
    private static final String DELETE_PAGE = &quot;DELETE FROM pages WHERE code = ? &quot;;
    private static final String DELETE_WIDGETS_FOR_PAGE_ONLINE = &quot;DELETE FROM &quot; + WidgetConfig.TABLE_NAME + &quot; WHERE pagecode = ? &quot;;
    private static final String DELETE_WIDGETS_FOR_PAGE_DRAFT = &quot;DELETE FROM &quot; + WidgetConfigDraft.TABLE_NAME + &quot; WHERE pagecode = ? &quot;;
    private static final String DELETE_WIDGET_FOR_PAGE_DRAFT = DELETE_WIDGETS_FOR_PAGE_DRAFT + &quot; AND framepos = ? &quot;;
    private static final String MOVE_UP = &quot;UPDATE pages SET pos = (pos - 1) WHERE code = ? &quot;;
    private static final String MOVE_DOWN = &quot;UPDATE pages SET pos = (pos + 1) WHERE code = ? &quot;;
    private static final String UPDATE_PAGE = &quot;UPDATE pages SET parentcode = ? WHERE code = ? &quot;;
    private static final String SHIFT_PAGE = &quot;UPDATE pages SET pos = (pos - 1) WHERE parentcode = ? AND pos &gt; ? &quot;;
    private static final String ADD_WIDGET_FOR_PAGE = &quot;INSERT INTO &quot; + WidgetConfig.TABLE_NAME
            + &quot; (pagecode, framepos, widgetcode, config) VALUES ( ? , ? , ? , ? )&quot;;
    private static final String ADD_WIDGET_FOR_PAGE_DRAFT = &quot;INSERT INTO &quot; + WidgetConfigDraft.TABLE_NAME
            + &quot; (pagecode, framepos, widgetcode, config) VALUES ( ? , ? , ? , ? )&quot;;
    private static final String MOVE_WIDGET = &quot;UPDATE &quot; + WidgetConfigDraft.TABLE_NAME
            + &quot; SET framepos = ? WHERE pagecode = ? and framepos = ? &quot;;
    private static final String UPDATE_PAGE_TREE_POSITION = &quot;UPDATE pages SET parentcode = ? , pos =?  WHERE code = ? &quot;;
    private static final String PAGE_METADATA_WHERE_CODE = &quot; WHERE code = ?&quot;;
    private static final String ADD_PAGE_METADATA_END = &quot; (code, groupcode, titles, modelcode, showinmenu, extraconfig, updatedat) VALUES&quot;
            + &quot; (?, ?, ?, ?, ?, ?, ?) &quot;;
    private static final String UPDATE_PAGE_METADATA_END =
            &quot;SET groupcode = ? , titles = ?, modelcode = ?, showinmenu = ?, extraconfig = ?, updatedat = ? &quot;
                    + PAGE_METADATA_WHERE_CODE;
    private static final String ADD_PAGE_METADATA_START = &quot;INSERT INTO &quot;;
    private static final String UPDATE_PAGE_METADATA_START = &quot;UPDATE &quot;;
    private static final String DELETE_ONLINE_PAGE_METADATA = &quot;DELETE FROM &quot; + PageMetadataOnline.TABLE_NAME + PAGE_METADATA_WHERE_CODE;
    private static final String DELETE_DRAFT_PAGE_METADATA = &quot;DELETE FROM &quot; + PageMetadataDraft.TABLE_NAME + PAGE_METADATA_WHERE_CODE;
    private static final String SET_ONLINE_METADATA = &quot;INSERT INTO &quot; + PageMetadataOnline.TABLE_NAME
            + &quot; (code, groupcode, titles, modelcode, showinmenu, extraconfig, updatedat) SELECT code, groupcode, titles, modelcode, &quot;
            + &quot;showinmenu, extraconfig, updatedat FROM &quot;
            + PageMetadataDraft.TABLE_NAME + &quot; WHERE code = ?&quot;;
    private static final String SET_ONLINE_WIDGETS = &quot;INSERT INTO &quot; + WidgetConfig.TABLE_NAME
            + &quot; (pagecode, framepos, widgetcode, config) SELECT pagecode, framepos, widgetcode, config FROM &quot; + WidgetConfigDraft.TABLE_NAME
            + &quot; WHERE pagecode = ?&quot;;
    private static final String LOAD_LAST_UPDATED_PAGES = &quot;SELECT code FROM pages_metadata_draft ORDER BY updatedat DESC&quot;;
    private static final String GET_LAST_CHILDREN_POSITION = &quot;SELECT pos FROM pages WHERE parentcode = ? ORDER BY pos DESC&quot;;
    private IPageModelManager _pageModelManager;
    private IWidgetTypeManager _widgetTypeManager;

    @Override
    public List&lt;PageRecord&gt; loadPageRecords() {
<span class="nc" id="L101">        Connection conn = null;</span>
<span class="nc" id="L102">        List&lt;PageRecord&gt; pages = null;</span>
        try {
<span class="nc" id="L104">            conn = this.getConnection();</span>
<span class="nc" id="L105">            pages = this.createPageRecordList(conn);</span>
<span class="nc" id="L106">            this.readPageWidgets(pages, true, conn);</span>
<span class="nc" id="L107">            this.readPageWidgets(pages, false, conn);</span>
<span class="nc" id="L108">        } catch (Throwable t) {</span>
<span class="nc" id="L109">            _logger.error(&quot;Error loading pages&quot;, t);</span>
<span class="nc" id="L110">            throw new RuntimeException(&quot;Error loading pages&quot;, t);</span>
        } finally {
<span class="nc" id="L112">            closeConnection(conn);</span>
        }
<span class="nc" id="L114">        return pages;</span>
    }

    private List&lt;PageRecord&gt; createPageRecordList(Connection conn) {
<span class="nc" id="L118">        List&lt;PageRecord&gt; pages = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L119">        Statement stat = null;</span>
<span class="nc" id="L120">        ResultSet res = null;</span>
        try {
<span class="nc" id="L122">            stat = conn.createStatement();</span>
<span class="nc" id="L123">            res = stat.executeQuery(ALL_PAGES);</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">            while (res.next()) {</span>
<span class="nc" id="L125">                String code = res.getString(3);</span>
<span class="nc" id="L126">                PageRecord page = this.createPageRecord(code, res);</span>
<span class="nc" id="L127">                pages.add(page);</span>
<span class="nc" id="L128">                int numFramesOnline = this.getWidgetArrayLength(page.getMetadataOnline());</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">                if (numFramesOnline &gt;= 0) {</span>
<span class="nc" id="L130">                    page.setWidgetsOnline(new Widget[numFramesOnline]);</span>
                }
<span class="nc" id="L132">                int numFramesDraft = this.getWidgetArrayLength(page.getMetadataDraft());</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">                if (numFramesDraft &gt;= 0) {</span>
<span class="nc" id="L134">                    page.setWidgetsDraft(new Widget[numFramesDraft]);</span>
                }
<span class="nc" id="L136">            }</span>
<span class="nc" id="L137">        } catch (Throwable t) {</span>
<span class="nc" id="L138">            _logger.error(&quot;Error loading page records&quot;, t);</span>
<span class="nc" id="L139">            throw new RuntimeException(&quot;Error loading page records&quot;, t);</span>
        } finally {
<span class="nc" id="L141">            closeDaoResources(res, stat);</span>
        }
<span class="nc" id="L143">        return pages;</span>
    }

    private void readPageWidgets(List&lt;PageRecord&gt; pages, boolean online, Connection conn) {
<span class="nc" id="L147">        Statement stat = null;</span>
<span class="nc" id="L148">        ResultSet res = null;</span>
        try {
<span class="nc" id="L150">            stat = conn.createStatement();</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">            res = stat.executeQuery(online ? ALL_WIDGETS_ONLINE : ALL_WIDGETS_DRAFT);</span>
<span class="nc" id="L152">            PageRecord currentPage = null;</span>
<span class="nc" id="L153">            int currentWidgetNum = 0;</span>
<span class="nc" id="L154">            Widget[] currentWidgets = null;</span>
<span class="nc" id="L155">            Iterator&lt;PageRecord&gt; pagesIter = pages.iterator();</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">            while (res.next()) {</span>
<span class="nc" id="L157">                String code = res.getString(1);</span>
<span class="nc bnc" id="L158" title="All 4 branches missed.">                while (currentPage == null || !currentPage.getCode().equals(code)) {</span>
<span class="nc" id="L159">                    currentPage = pagesIter.next();</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">                    currentWidgetNum = this.getWidgetArrayLength(online ? currentPage.getMetadataOnline() : currentPage.getMetadataDraft());</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">                    currentWidgets = online ? currentPage.getWidgetsOnline() : currentPage.getWidgetsDraft();</span>
                }
<span class="nc" id="L163">                this.readWidget(currentPage, currentWidgetNum, currentWidgets, 2, res);</span>
<span class="nc" id="L164">            }</span>
<span class="nc" id="L165">        } catch (Throwable t) {</span>
<span class="nc" id="L166">            _logger.error(&quot;Error loading page widgets - online/draft: {}&quot;, online, t);</span>
<span class="nc" id="L167">            throw new RuntimeException(&quot;Error loading page widgets - online/draft: &quot; + online, t);</span>
        } finally {
<span class="nc" id="L169">            closeDaoResources(res, stat);</span>
        }
<span class="nc" id="L171">    }</span>

    protected int getWidgetArrayLength(PageMetadata metadata) {
<span class="nc" id="L174">        int numFrames = -1;</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">        if (metadata != null) {</span>
<span class="nc" id="L176">            PageModel model = metadata.getModel();</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">            if (model != null) {</span>
<span class="nc" id="L178">                numFrames = model.getFrames().length;</span>
            }
        }
<span class="nc" id="L181">        return numFrames;</span>
    }

    protected void readWidget(PageRecord page, int numOfFrames, Widget[] widgets,
            int startIndex, ResultSet res) throws ApsSystemException, SQLException {
<span class="nc" id="L186">        Object posObj = res.getObject(startIndex);</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">        if (posObj != null) {</span>
<span class="nc" id="L188">            int pos = res.getInt(startIndex);</span>
<span class="nc bnc" id="L189" title="All 4 branches missed.">            if (pos &gt;= 0 &amp;&amp; pos &lt; numOfFrames) {</span>
<span class="nc" id="L190">                Widget widget = this.createWidget(page, pos, res, startIndex + 1);</span>
<span class="nc" id="L191">                widgets[pos] = widget;</span>
<span class="nc" id="L192">            } else {</span>
<span class="nc" id="L193">                _logger.warn(&quot;The position read from the database exceeds the number of frames defined in the model of the page {}&quot;, page</span>
<span class="nc" id="L194">                        .getCode());</span>
            }
        }
<span class="nc" id="L197">    }</span>

    protected PageRecord createPageRecord(String code, ResultSet res) throws Throwable {
<span class="nc" id="L200">        PageRecord page = new PageRecord();</span>
<span class="nc" id="L201">        page.setCode(code);</span>
<span class="nc" id="L202">        page.setParentCode(res.getString(1));</span>
<span class="nc" id="L203">        page.setPosition(res.getInt(2));</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">        if (res.getString(4) != null) {</span>
<span class="nc" id="L205">            page.setMetadataOnline(this.createPageMetadata(code, res, 4));</span>
        }
<span class="nc bnc" id="L207" title="All 2 branches missed.">        if (res.getString(10) != null) {</span>
<span class="nc" id="L208">            page.setMetadataDraft(this.createPageMetadata(code, res, 10));</span>
        }
<span class="nc" id="L210">        return page;</span>
    }

    protected Widget createWidget(PageRecord page, int pos, ResultSet res, int startIndex) throws ApsSystemException, SQLException {
<span class="nc" id="L214">        String typeCode = res.getString(startIndex++);</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">        if (null == typeCode) {</span>
<span class="nc" id="L216">            return null;</span>
        }
<span class="nc" id="L218">        Widget widget = new Widget();</span>
<span class="nc" id="L219">        WidgetType type = this.getWidgetTypeManager().getWidgetType(typeCode);</span>
<span class="nc" id="L220">        widget.setType(type);</span>
<span class="nc" id="L221">        ApsProperties config = new ApsProperties();</span>
<span class="nc" id="L222">        String configText = res.getString(startIndex++);</span>
<span class="nc bnc" id="L223" title="All 4 branches missed.">        if (null != configText &amp;&amp; configText.trim().length() &gt; 0) {</span>
            try {
<span class="nc" id="L225">                config.loadFromXml(configText);</span>
<span class="nc" id="L226">            } catch (Throwable t) {</span>
<span class="nc" id="L227">                _logger.error(&quot;IO error detected while parsing the configuration of the widget in position '{}' of the page '{}'&quot;, pos, page</span>
<span class="nc" id="L228">                        .getCode(), t);</span>
<span class="nc" id="L229">                String msg = &quot;IO error detected while parsing the configuration of the widget in position &quot; + pos + &quot; of the page '&quot; + page</span>
<span class="nc" id="L230">                        .getCode() + &quot;'&quot;;</span>
<span class="nc" id="L231">                throw new ApsSystemException(msg, t);</span>
<span class="nc" id="L232">            }</span>
        } else {
<span class="nc" id="L234">            config = type.getConfig();</span>
        }
<span class="nc" id="L236">        widget.setConfig(config);</span>
<span class="nc" id="L237">        return widget;</span>
    }

    /**
     * Insert a new page.
     *
     * @param page The new page to insert.
     */
    @Override
    public void addPage(IPage page) {
<span class="nc" id="L247">        Connection conn = null;</span>
        try {
<span class="nc" id="L249">            conn = this.getConnection();</span>
<span class="nc" id="L250">            conn.setAutoCommit(false);</span>
<span class="nc" id="L251">            String pageCode = page.getCode();</span>
<span class="nc" id="L252">            this.addPageRecord(page, conn);</span>
<span class="nc" id="L253">            PageMetadata draftMetadata = page.getMetadata();</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">            if (draftMetadata == null) {</span>
<span class="nc" id="L255">                draftMetadata = new PageMetadata();</span>
            }
<span class="nc" id="L257">            draftMetadata.setUpdatedAt(new Date());</span>
<span class="nc" id="L258">            this.addDraftPageMetadata(pageCode, draftMetadata, conn);</span>
<span class="nc" id="L259">            this.addWidgetForPage(page, WidgetConfigDest.DRAFT, conn);</span>
<span class="nc" id="L260">            conn.commit();</span>
<span class="nc" id="L261">        } catch (Throwable t) {</span>
<span class="nc" id="L262">            this.executeRollback(conn);</span>
<span class="nc" id="L263">            _logger.error(&quot;Error while adding a new page&quot;, t);</span>
<span class="nc" id="L264">            throw new RuntimeException(&quot;Error while adding a new page&quot;, t);</span>
        } finally {
<span class="nc" id="L266">            closeConnection(conn);</span>
        }
<span class="nc" id="L268">    }</span>

    protected void addPageRecord(IPage page, Connection conn) throws ApsSystemException {
<span class="nc" id="L271">        String parentCode = page.getParentCode();</span>
        // a new page is always inserted in the last position,
        // to avoid changes of the position of the &quot;sister&quot; pages.
<span class="nc" id="L274">        int position = this.getLastPosition(parentCode, conn) + 1;</span>
<span class="nc" id="L275">        PreparedStatement stat = null;</span>
        try {
<span class="nc" id="L277">            stat = conn.prepareStatement(ADD_PAGE);</span>
<span class="nc" id="L278">            stat.setString(1, page.getCode());</span>
<span class="nc" id="L279">            stat.setString(2, parentCode);</span>
<span class="nc" id="L280">            stat.setInt(3, position);</span>
<span class="nc" id="L281">            stat.executeUpdate();</span>
<span class="nc" id="L282">        } catch (Throwable t) {</span>
<span class="nc" id="L283">            _logger.error(&quot;Error adding a new page record&quot;, t);</span>
<span class="nc" id="L284">            throw new RuntimeException(&quot;Error adding a new page record&quot;, t);</span>
        } finally {
<span class="nc" id="L286">            closeDaoResources(null, stat);</span>
        }
<span class="nc bnc" id="L288" title="All 2 branches missed.">        if (page instanceof Page) {</span>
<span class="nc" id="L289">            page.setPosition(position);</span>
        }
<span class="nc" id="L291">    }</span>

    /**
     * Delete the page identified by the given code.
     *
     * @param page The page to delete.
     */
    @Override
    public void deletePage(IPage page) {
<span class="nc" id="L300">        Connection conn = null;</span>
        try {
<span class="nc" id="L302">            conn = this.getConnection();</span>
<span class="nc" id="L303">            conn.setAutoCommit(false);</span>
<span class="nc" id="L304">            String pageCode = page.getCode();</span>
<span class="nc" id="L305">            this.deleteOnlineWidgets(pageCode, conn);</span>
<span class="nc" id="L306">            this.deleteDraftWidgets(pageCode, conn);</span>
<span class="nc" id="L307">            this.deleteOnlinePageMetadata(pageCode, conn);</span>
<span class="nc" id="L308">            this.deleteDraftPageMetadata(pageCode, conn);</span>
<span class="nc" id="L309">            this.deletePageRecord(pageCode, conn);</span>
<span class="nc" id="L310">            this.shiftPages(page.getParentCode(), page.getPosition(), conn);</span>
<span class="nc" id="L311">            conn.commit();</span>
<span class="nc" id="L312">        } catch (Throwable t) {</span>
<span class="nc" id="L313">            this.executeRollback(conn);</span>
<span class="nc" id="L314">            _logger.error(&quot;Error deleting page&quot;, t);</span>
<span class="nc" id="L315">            throw new RuntimeException(&quot;Error deleting page&quot;, t);</span>
        } finally {
<span class="nc" id="L317">            closeConnection(conn);</span>
        }
<span class="nc" id="L319">    }</span>

    protected void deletePageRecord(String pageCode, Connection conn) throws ApsSystemException {
<span class="nc" id="L322">        PreparedStatement stat = null;</span>
        try {
<span class="nc" id="L324">            stat = conn.prepareStatement(DELETE_PAGE);</span>
<span class="nc" id="L325">            stat.setString(1, pageCode);</span>
<span class="nc" id="L326">            stat.executeUpdate();</span>
<span class="nc" id="L327">        } catch (Throwable t) {</span>
<span class="nc" id="L328">            _logger.error(&quot;Error deleting a page record&quot;, t);</span>
<span class="nc" id="L329">            throw new RuntimeException(&quot;Error deleting a page record&quot;, t);</span>
        } finally {
<span class="nc" id="L331">            closeDaoResources(null, stat);</span>
        }
<span class="nc" id="L333">    }</span>

    /**
     * Delete the widget associated to a page.
     *
     * @param pageCode The code of the page containing the widget to delete.
     * @param conn The database connection
     * @throws ApsSystemException In case of database error
     */
    protected void deleteOnlineWidgets(String pageCode, Connection conn) throws ApsSystemException {
<span class="nc" id="L343">        PreparedStatement stat = null;</span>
        try {
<span class="nc" id="L345">            stat = conn.prepareStatement(DELETE_WIDGETS_FOR_PAGE_ONLINE);</span>
<span class="nc" id="L346">            stat.setString(1, pageCode);</span>
<span class="nc" id="L347">            stat.executeUpdate();</span>
<span class="nc" id="L348">        } catch (Throwable t) {</span>
<span class="nc" id="L349">            _logger.error(&quot;Error while deleting widgets for page '{}'&quot;, pageCode, t);</span>
<span class="nc" id="L350">            throw new RuntimeException(&quot;Error while deleting widgets&quot;, t);</span>
        } finally {
<span class="nc" id="L352">            closeDaoResources(null, stat);</span>
        }
<span class="nc" id="L354">    }</span>

    /**
     * Delete the widget associated to the draft version of a page.
     *
     * @param pageCode The code of the page containing the widget to delete.
     * @param conn The database connection
     * @throws ApsSystemException In case of database error
     */
    protected void deleteDraftWidgets(String pageCode, Connection conn) throws ApsSystemException {
<span class="nc" id="L364">        PreparedStatement stat = null;</span>
        try {
<span class="nc" id="L366">            stat = conn.prepareStatement(DELETE_WIDGETS_FOR_PAGE_DRAFT);</span>
<span class="nc" id="L367">            stat.setString(1, pageCode);</span>
<span class="nc" id="L368">            stat.executeUpdate();</span>
<span class="nc" id="L369">        } catch (Throwable t) {</span>
<span class="nc" id="L370">            _logger.error(&quot;Error while deleting  draft widgets for page '{}'&quot;, pageCode, t);</span>
<span class="nc" id="L371">            throw new RuntimeException(&quot;Error while deleting draft widgets&quot;, t);</span>
        } finally {
<span class="nc" id="L373">            closeDaoResources(null, stat);</span>
        }
<span class="nc" id="L375">    }</span>

    /**
     * Decrement by one the position of a group of pages to compact the positions after a deletion
     *
     * @param parentCode the code of the parent of the pages to compact.
     * @param position The empty position which needs to be compacted.
     * @param conn The connection to the database
     * @throws ApsSystemException In case of database error
     */
    protected void shiftPages(String parentCode, int position, Connection conn) throws ApsSystemException {
<span class="nc" id="L386">        PreparedStatement stat = null;</span>
        try {
<span class="nc" id="L388">            stat = conn.prepareStatement(SHIFT_PAGE);</span>
<span class="nc" id="L389">            stat.setString(1, parentCode);</span>
<span class="nc" id="L390">            stat.setInt(2, position);</span>
<span class="nc" id="L391">            stat.executeUpdate();</span>
<span class="nc" id="L392">        } catch (Throwable t) {</span>
<span class="nc" id="L393">            _logger.error(&quot;Error moving page position&quot;, t);</span>
<span class="nc" id="L394">            throw new RuntimeException(&quot;Error moving page position&quot;, t);</span>
        } finally {
<span class="nc" id="L396">            closeDaoResources(null, stat);</span>
        }
<span class="nc" id="L398">    }</span>

    /**
     * Updates the position for the page movement
     *
     * @param pageDown The page to move downwards
     * @param pageUp The page to move upwards
     */
    @Override
    public void updatePosition(String pageDown, String pageUp) {
<span class="nc" id="L408">        Connection conn = null;</span>
        try {
<span class="nc" id="L410">            conn = this.getConnection();</span>
<span class="nc" id="L411">            conn.setAutoCommit(false);</span>
<span class="nc" id="L412">            this.updatePosition(pageDown, MOVE_DOWN, conn);</span>
<span class="nc" id="L413">            this.updatePosition(pageUp, MOVE_UP, conn);</span>
<span class="nc" id="L414">            this.updatePageMetadataOnlineLastUpdate(pageDown, new Date(), conn);</span>
<span class="nc" id="L415">            this.updatePageMetadataOnlineLastUpdate(pageUp, new Date(), conn);</span>
<span class="nc" id="L416">            this.updatePageMetadataDraftLastUpdate(pageDown, new Date(), conn);</span>
<span class="nc" id="L417">            this.updatePageMetadataDraftLastUpdate(pageUp, new Date(), conn);</span>
<span class="nc" id="L418">            conn.commit();</span>
<span class="nc" id="L419">        } catch (Throwable t) {</span>
<span class="nc" id="L420">            this.executeRollback(conn);</span>
<span class="nc" id="L421">            _logger.error(&quot;Error detected while updating positions&quot;, t);</span>
<span class="nc" id="L422">            throw new RuntimeException(&quot;Error detected while updating positions&quot;, t);</span>
        } finally {
<span class="nc" id="L424">            closeConnection(conn);</span>
        }
<span class="nc" id="L426">    }</span>

    private void updatePosition(String pageCode, String query, Connection conn) {
<span class="nc" id="L429">        PreparedStatement stat = null;</span>
        try {
<span class="nc" id="L431">            stat = conn.prepareStatement(query);</span>
<span class="nc" id="L432">            stat.setString(1, pageCode);</span>
<span class="nc" id="L433">            stat.executeUpdate();</span>
<span class="nc" id="L434">        } catch (Throwable t) {</span>
<span class="nc" id="L435">            _logger.error(&quot;Error detected while updating position for page {}&quot;, pageCode, t);</span>
<span class="nc" id="L436">            throw new RuntimeException(&quot;Error detected while updating position for page &quot; + pageCode, t);</span>
        } finally {
<span class="nc" id="L438">            closeDaoResources(null, stat);</span>
        }
<span class="nc" id="L440">    }</span>

    @Override
    public void updateWidgetPosition(String pageCode, Integer frameToMove, Integer destFrame) {
<span class="nc" id="L444">        Connection conn = null;</span>
<span class="nc" id="L445">        int tempFramePosition = -9999;</span>
        try {
<span class="nc" id="L447">            conn = this.getConnection();</span>
<span class="nc" id="L448">            conn.setAutoCommit(false);</span>
<span class="nc" id="L449">            this.updateWidgetPosition(pageCode, frameToMove, tempFramePosition, conn);</span>
<span class="nc" id="L450">            this.updateWidgetPosition(pageCode, destFrame, frameToMove, conn);</span>
<span class="nc" id="L451">            this.updateWidgetPosition(pageCode, tempFramePosition, destFrame, conn);</span>
<span class="nc" id="L452">            this.updatePageMetadataDraftLastUpdate(pageCode, new Date(), conn);</span>
<span class="nc" id="L453">            conn.commit();</span>
<span class="nc" id="L454">        } catch (Throwable t) {</span>
<span class="nc" id="L455">            this.executeRollback(conn);</span>
<span class="nc" id="L456">            _logger.error(&quot;Error while updating WidgetPosition. page: {} from position: {} to position {}&quot;, pageCode, frameToMove,</span>
                    destFrame, t);
<span class="nc" id="L458">            throw new RuntimeException(&quot;Error while updating widget position&quot;, t);</span>
        } finally {
<span class="nc" id="L460">            closeConnection(conn);</span>
        }
<span class="nc" id="L462">    }</span>

    private void updateWidgetPosition(String pageCode, int frameToMove, int destFrame, Connection conn) {
<span class="nc" id="L465">        PreparedStatement stat = null;</span>
        try {
<span class="nc" id="L467">            stat = conn.prepareStatement(MOVE_WIDGET);</span>
<span class="nc" id="L468">            stat.setInt(1, destFrame);</span>
<span class="nc" id="L469">            stat.setString(2, pageCode);</span>
<span class="nc" id="L470">            stat.setInt(3, frameToMove);</span>
<span class="nc" id="L471">            stat.executeUpdate();</span>
<span class="nc" id="L472">        } catch (Throwable t) {</span>
<span class="nc" id="L473">            _logger.error(&quot;Error while updating WidgetPosition. page: {} from position: {} to position {}&quot;, pageCode, frameToMove,</span>
<span class="nc" id="L474">                    destFrame, t);</span>
<span class="nc" id="L475">            throw new RuntimeException(&quot;Error while updating widget position&quot;, t);</span>
        } finally {
<span class="nc" id="L477">            closeDaoResources(null, stat);</span>
        }
<span class="nc" id="L479">    }</span>

    /**
     * Updates a page record in the database.
     *
     * @param page The page to update
     */
    @Override
    public void updatePage(IPage page) {
<span class="nc" id="L488">        Connection conn = null;</span>
        try {
<span class="nc" id="L490">            conn = this.getConnection();</span>
<span class="nc" id="L491">            conn.setAutoCommit(false);</span>
<span class="nc" id="L492">            String pageCode = page.getCode();</span>
<span class="nc" id="L493">            this.deleteDraftWidgets(pageCode, conn);</span>
<span class="nc" id="L494">            this.deleteDraftPageMetadata(pageCode, conn);</span>
<span class="nc" id="L495">            this.updatePageRecord(page, conn);</span>
<span class="nc" id="L496">            PageMetadata metadata = page.getMetadata();</span>
<span class="nc" id="L497">            metadata.setUpdatedAt(new Date());</span>
<span class="nc" id="L498">            this.addDraftPageMetadata(pageCode, page.getMetadata(), conn);</span>
<span class="nc" id="L499">            this.addWidgetForPage(page, WidgetConfigDest.DRAFT, conn);</span>
<span class="nc" id="L500">            conn.commit();</span>
<span class="nc" id="L501">        } catch (Throwable t) {</span>
<span class="nc" id="L502">            this.executeRollback(conn);</span>
<span class="nc" id="L503">            _logger.error(&quot;Error while updating the page&quot;, t);</span>
<span class="nc" id="L504">            throw new RuntimeException(&quot;Error while updating the page&quot;, t);</span>
        } finally {
<span class="nc" id="L506">            closeConnection(conn);</span>
        }
<span class="nc" id="L508">    }</span>

    protected void updatePageRecord(IPage page, Connection conn) throws ApsSystemException {
<span class="nc" id="L511">        PreparedStatement stat = null;</span>
        try {
<span class="nc" id="L513">            stat = conn.prepareStatement(UPDATE_PAGE);</span>
<span class="nc" id="L514">            stat.setString(1, page.getParentCode());</span>
<span class="nc" id="L515">            stat.setString(2, page.getCode());</span>
<span class="nc" id="L516">            stat.executeUpdate();</span>
<span class="nc" id="L517">        } catch (Throwable t) {</span>
<span class="nc" id="L518">            _logger.error(&quot;Error while updating the page record&quot;, t);</span>
<span class="nc" id="L519">            throw new RuntimeException(&quot;Error while updating the page record&quot;, t);</span>
        } finally {
<span class="nc" id="L521">            closeDaoResources(null, stat);</span>
        }
<span class="nc" id="L523">    }</span>

    @Override
    public void setPageOnline(String pageCode) {
<span class="nc" id="L527">        Connection conn = null;</span>
        try {
<span class="nc" id="L529">            conn = this.getConnection();</span>
<span class="nc" id="L530">            conn.setAutoCommit(false);</span>
<span class="nc" id="L531">            this.deleteOnlineWidgets(pageCode, conn);</span>
<span class="nc" id="L532">            this.deleteOnlinePageMetadata(pageCode, conn);</span>
<span class="nc" id="L533">            this.executeQueryWithoutResultset(conn, SET_ONLINE_METADATA, pageCode);</span>
<span class="nc" id="L534">            this.executeQueryWithoutResultset(conn, SET_ONLINE_WIDGETS, pageCode);</span>
<span class="nc" id="L535">            Date now = new Date();</span>
<span class="nc" id="L536">            this.updatePageMetadataDraftLastUpdate(pageCode, now, conn);</span>
<span class="nc" id="L537">            this.updatePageMetadataOnlineLastUpdate(pageCode, now, conn);</span>
<span class="nc" id="L538">            conn.commit();</span>
<span class="nc" id="L539">        } catch (Throwable t) {</span>
<span class="nc" id="L540">            this.executeRollback(conn);</span>
<span class="nc" id="L541">            _logger.error(&quot;Error while setting page '{}' as online&quot;, pageCode, t);</span>
<span class="nc" id="L542">            throw new RuntimeException(&quot;Error while setting page &quot; + pageCode + &quot; as online&quot;, t);</span>
        } finally {
<span class="nc" id="L544">            closeConnection(conn);</span>
        }
<span class="nc" id="L546">    }</span>

    @Override
    public void setPageOffline(String pageCode) {
<span class="nc" id="L550">        Connection conn = null;</span>
        try {
<span class="nc" id="L552">            conn = this.getConnection();</span>
<span class="nc" id="L553">            conn.setAutoCommit(false);</span>
<span class="nc" id="L554">            this.deleteOnlineWidgets(pageCode, conn);</span>
<span class="nc" id="L555">            this.deleteOnlinePageMetadata(pageCode, conn);</span>
<span class="nc" id="L556">            this.updatePageMetadataDraftLastUpdate(pageCode, new Date(), conn);</span>
<span class="nc" id="L557">            conn.commit();</span>
<span class="nc" id="L558">        } catch (Throwable t) {</span>
<span class="nc" id="L559">            this.executeRollback(conn);</span>
<span class="nc" id="L560">            _logger.error(&quot;Error while setting page '{}' as online&quot;, pageCode, t);</span>
<span class="nc" id="L561">            throw new RuntimeException(&quot;Error while setting page &quot; + pageCode + &quot; as online&quot;, t);</span>
        } finally {
<span class="nc" id="L563">            closeConnection(conn);</span>
        }
<span class="nc" id="L565">    }</span>

    protected void addOnlinePageMetadata(String pageCode, PageMetadata pageMetadata, Connection conn) throws ApsSystemException {
<span class="nc" id="L568">        this.savePageMetadata(pageCode, pageMetadata, true, PageMetadataOnline.TABLE_NAME, conn);</span>
<span class="nc" id="L569">    }</span>

    protected void addDraftPageMetadata(String pageCode, PageMetadata pageMetadata, Connection conn) throws ApsSystemException {
<span class="nc" id="L572">        this.savePageMetadata(pageCode, pageMetadata, true, PageMetadataDraft.TABLE_NAME, conn);</span>
<span class="nc" id="L573">    }</span>

    protected void deleteOnlinePageMetadata(String pageCode, Connection conn) throws ApsSystemException {
<span class="nc" id="L576">        this.executeQueryWithoutResultset(conn, DELETE_ONLINE_PAGE_METADATA, pageCode);</span>
<span class="nc" id="L577">    }</span>

    protected void deleteDraftPageMetadata(String pageCode, Connection conn) throws ApsSystemException {
<span class="nc" id="L580">        this.executeQueryWithoutResultset(conn, DELETE_DRAFT_PAGE_METADATA, pageCode);</span>
<span class="nc" id="L581">    }</span>

    protected void savePageMetadata(String pageCode, PageMetadata pageMetadata, boolean isAdd, String tableName, Connection conn)
            throws ApsSystemException {
<span class="nc bnc" id="L585" title="All 2 branches missed.">        if (pageMetadata != null) {</span>
<span class="nc" id="L586">            PreparedStatement stat = null;</span>
            try {
<span class="nc bnc" id="L588" title="All 2 branches missed.">                StringBuilder query = new StringBuilder(isAdd ? ADD_PAGE_METADATA_START : UPDATE_PAGE_METADATA_START);</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">                query.append(tableName).append(isAdd ? ADD_PAGE_METADATA_END : UPDATE_PAGE_METADATA_END);</span>
<span class="nc" id="L590">                stat = conn.prepareStatement(query.toString());</span>
<span class="nc" id="L591">                int index = 1;</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">                if (isAdd) {</span>
<span class="nc" id="L593">                    stat.setString(index++, pageCode);</span>
                }
<span class="nc" id="L595">                stat.setString(index++, pageMetadata.getGroup());</span>
<span class="nc" id="L596">                stat.setString(index++, pageMetadata.getTitles().toXml());</span>
<span class="nc" id="L597">                stat.setString(index++, pageMetadata.getModel().getCode());</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">                if (pageMetadata.isShowable()) {</span>
<span class="nc" id="L599">                    stat.setInt(index++, 1);</span>
                } else {
<span class="nc" id="L601">                    stat.setInt(index++, 0);</span>
                }
<span class="nc" id="L603">                String extraConfig = this.getExtraConfig(pageMetadata);</span>
<span class="nc" id="L604">                stat.setString(index++, extraConfig);</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">                Date updatedAt = pageMetadata.getUpdatedAt() != null ? pageMetadata.getUpdatedAt() : new Date();</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">                stat.setTimestamp(index++, updatedAt != null ? new java.sql.Timestamp(updatedAt.getTime()) : null);</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">                if (!isAdd) {</span>
<span class="nc" id="L608">                    stat.setString(index++, pageCode);</span>
                }
<span class="nc" id="L610">                stat.executeUpdate();</span>
<span class="nc" id="L611">            } catch (Throwable t) {</span>
<span class="nc" id="L612">                _logger.error(&quot;Error while saving the page metadata record for table {}&quot;, tableName, t);</span>
<span class="nc" id="L613">                throw new RuntimeException(&quot;Error while saving the page metadata record for table &quot; + tableName, t);</span>
            } finally {
<span class="nc" id="L615">                closeDaoResources(null, stat);</span>
            }
        }
<span class="nc" id="L618">    }</span>

    protected PageMetadata createPageMetadata(String code, ResultSet res, int startIndex) throws Throwable {
<span class="nc" id="L621">        PageMetadata pageMetadata = new PageMetadata();</span>
<span class="nc" id="L622">        int index = startIndex;</span>
<span class="nc" id="L623">        pageMetadata.setGroup(res.getString(index++));</span>
<span class="nc" id="L624">        String titleText = res.getString(index++);</span>
<span class="nc" id="L625">        ApsProperties titles = new ApsProperties();</span>
        try {
<span class="nc" id="L627">            titles.loadFromXml(titleText);</span>
<span class="nc" id="L628">        } catch (Throwable t) {</span>
<span class="nc" id="L629">            _logger.error(&quot;IO error detected while parsing the titles of the page {}&quot;, code, t);</span>
<span class="nc" id="L630">            String msg = &quot;IO error detected while parsing the titles of the page '&quot; + code + &quot;'&quot;;</span>
<span class="nc" id="L631">            throw new ApsSystemException(msg, t);</span>
<span class="nc" id="L632">        }</span>
<span class="nc" id="L633">        pageMetadata.setTitles(titles);</span>
<span class="nc" id="L634">        pageMetadata.setModel(this.getPageModelManager().getPageModel(res.getString(index++)));</span>
<span class="nc" id="L635">        Integer showable = res.getInt(index++);</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">        pageMetadata.setShowable(showable == 1);</span>
<span class="nc" id="L637">        String extraConfig = res.getString(index++);</span>
<span class="nc bnc" id="L638" title="All 4 branches missed.">        if (null != extraConfig &amp;&amp; extraConfig.trim().length() &gt; 0) {</span>
            try {
<span class="nc" id="L640">                PageExtraConfigDOM configDom = new PageExtraConfigDOM();</span>
<span class="nc" id="L641">                configDom.addExtraConfig(pageMetadata, extraConfig);</span>
<span class="nc" id="L642">            } catch (Throwable t) {</span>
<span class="nc" id="L643">                _logger.error(&quot;IO error detected while parsing the extra config of the page {}&quot;, code, t);</span>
<span class="nc" id="L644">                String msg = &quot;IO error detected while parsing the extra config of the page '&quot; + code + &quot;'&quot;;</span>
<span class="nc" id="L645">                throw new ApsSystemException(msg, t);</span>
<span class="nc" id="L646">            }</span>
        }
<span class="nc" id="L648">        Timestamp date = res.getTimestamp(index++);</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">        pageMetadata.setUpdatedAt(date != null ? new Date(date.getTime()) : null);</span>
<span class="nc" id="L650">        return pageMetadata;</span>
    }

    protected String getExtraConfig(PageMetadata pageMetadata) {
<span class="nc" id="L654">        PageExtraConfigDOM dom = this.getExtraConfigDOM();</span>
<span class="nc" id="L655">        return dom.extractXml(pageMetadata);</span>
    }

    protected PageExtraConfigDOM getExtraConfigDOM() {
<span class="nc" id="L659">        return new PageExtraConfigDOM();</span>
    }

    protected void addWidgetForPage(IPage page, WidgetConfigDest dest, Connection conn) throws ApsSystemException {
<span class="nc" id="L663">        PreparedStatement stat = null;</span>
        try {
<span class="nc" id="L665">            Widget[] widgets = null;</span>
<span class="nc" id="L666">            String query = &quot;&quot;;</span>
<span class="nc bnc" id="L667" title="All 2 branches missed.">            if (dest == WidgetConfigDest.ON_LINE) {</span>
<span class="nc" id="L668">                query = ADD_WIDGET_FOR_PAGE;</span>
<span class="nc" id="L669">                widgets = page.getWidgets();</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">            } else if (dest == WidgetConfigDest.DRAFT) {</span>
<span class="nc" id="L671">                query = ADD_WIDGET_FOR_PAGE_DRAFT;</span>
<span class="nc" id="L672">                widgets = page.getWidgets();</span>
            }
<span class="nc bnc" id="L674" title="All 2 branches missed.">            if (null == widgets) {</span>
<span class="nc" id="L675">                return;</span>
            }
<span class="nc" id="L677">            String pageCode = page.getCode();</span>
<span class="nc" id="L678">            stat = conn.prepareStatement(query);</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">            for (int i = 0; i &lt; widgets.length; i++) {</span>
<span class="nc" id="L680">                Widget widget = widgets[i];</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">                if (widget != null) {</span>
<span class="nc bnc" id="L682" title="All 2 branches missed.">                    if (null == widget.getType()) {</span>
<span class="nc" id="L683">                        _logger.error(&quot;Widget Type null when adding widget on frame '{}' of page '{}'&quot;, i, page.getCode());</span>
<span class="nc" id="L684">                        continue;</span>
                    }
<span class="nc" id="L686">                    this.valueAddWidgetStatement(pageCode, i, widget, stat);</span>
<span class="nc" id="L687">                    stat.addBatch();</span>
<span class="nc" id="L688">                    stat.clearParameters();</span>
                }
            }
<span class="nc" id="L691">            stat.executeBatch();</span>
<span class="nc" id="L692">        } catch (Throwable t) {</span>
<span class="nc" id="L693">            _logger.error(&quot;Error while inserting the widgets in a page&quot;, t);</span>
<span class="nc" id="L694">            throw new RuntimeException(&quot;Error while inserting the widgets in a page&quot;, t);</span>
        } finally {
<span class="nc" id="L696">            closeDaoResources(null, stat);</span>
        }
<span class="nc" id="L698">    }</span>

    @Override
    public void removeWidget(IPage page, int pos) {
<span class="nc" id="L702">        Connection conn = null;</span>
        try {
<span class="nc" id="L704">            conn = this.getConnection();</span>
<span class="nc" id="L705">            conn.setAutoCommit(false);</span>
<span class="nc" id="L706">            super.executeQueryWithoutResultset(conn, DELETE_WIDGET_FOR_PAGE_DRAFT, page.getCode(), pos);</span>
<span class="nc" id="L707">            Date now = new Date();</span>
<span class="nc" id="L708">            this.updatePageMetadataDraftLastUpdate(page.getCode(), now, conn);</span>
<span class="nc" id="L709">            page.getMetadata().setUpdatedAt(now);</span>
<span class="nc" id="L710">            conn.commit();</span>
<span class="nc" id="L711">        } catch (Throwable t) {</span>
<span class="nc" id="L712">            this.executeRollback(conn);</span>
<span class="nc" id="L713">            _logger.error(&quot;Error removing the widget from page '{}', frame {}&quot;, page.getCode(), pos, t);</span>
<span class="nc" id="L714">            throw new RuntimeException(&quot;Error removing the widget from page '&quot; + page.getCode() + &quot;', frame &quot; + pos, t);</span>
        } finally {
<span class="nc" id="L716">            closeConnection(conn);</span>
        }
<span class="nc" id="L718">    }</span>

    @Override
    public void joinWidget(IPage page, Widget widget, int pos) {
<span class="nc" id="L722">        String pageCode = page.getCode();</span>
<span class="nc" id="L723">        Connection conn = null;</span>
<span class="nc" id="L724">        PreparedStatement stat = null;</span>
        try {
<span class="nc" id="L726">            conn = this.getConnection();</span>
<span class="nc" id="L727">            conn.setAutoCommit(false);</span>
<span class="nc" id="L728">            super.executeQueryWithoutResultset(conn, DELETE_WIDGET_FOR_PAGE_DRAFT, pageCode, pos);</span>
<span class="nc" id="L729">            stat = conn.prepareStatement(ADD_WIDGET_FOR_PAGE_DRAFT);</span>
<span class="nc" id="L730">            this.valueAddWidgetStatement(pageCode, pos, widget, stat);</span>
<span class="nc" id="L731">            stat.executeUpdate();</span>
<span class="nc" id="L732">            Date now = new Date();</span>
<span class="nc" id="L733">            this.updatePageMetadataDraftLastUpdate(pageCode, now, conn);</span>
<span class="nc" id="L734">            page.getMetadata().setUpdatedAt(now);</span>
<span class="nc" id="L735">            conn.commit();</span>
<span class="nc" id="L736">        } catch (Throwable t) {</span>
<span class="nc" id="L737">            this.executeRollback(conn);</span>
<span class="nc" id="L738">            _logger.error(&quot;Error adding a widget in the frame '{}' of the page '{}'&quot;, pos, pageCode, t);</span>
<span class="nc" id="L739">            throw new RuntimeException(&quot;Error adding a widget in the frame &quot; + pos + &quot; of the page '&quot; + pageCode + &quot;'&quot;, t);</span>
        } finally {
<span class="nc" id="L741">            closeDaoResources(null, stat, conn);</span>
        }
<span class="nc" id="L743">    }</span>

    private void valueAddWidgetStatement(String pageCode, int pos, Widget widget, PreparedStatement stat) throws Throwable {
<span class="nc" id="L746">        stat.setString(1, pageCode);</span>
<span class="nc" id="L747">        stat.setInt(2, pos);</span>
<span class="nc" id="L748">        stat.setString(3, widget.getType().getCode());</span>
<span class="nc bnc" id="L749" title="All 2 branches missed.">        if (!widget.getType().isLogic()) {</span>
<span class="nc" id="L750">            String config = null;</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">            if (null != widget.getConfig()) {</span>
<span class="nc" id="L752">                config = widget.getConfig().toXml();</span>
            }
<span class="nc" id="L754">            stat.setString(4, config);</span>
<span class="nc" id="L755">        } else {</span>
<span class="nc" id="L756">            stat.setNull(4, Types.VARCHAR);</span>
        }
<span class="nc" id="L758">    }</span>

    @Override
    public void movePage(IPage currentPage, IPage newParent) {
<span class="nc" id="L762">        Connection conn = null;</span>
<span class="nc" id="L763">        PreparedStatement stat = null;</span>
        try {
<span class="nc" id="L765">            conn = this.getConnection();</span>
<span class="nc" id="L766">            conn.setAutoCommit(false);</span>
            // a moved page is always inserted in the last position into the new parent,
            // to avoid changes of the position of the &quot;sister&quot; pages.
<span class="nc" id="L769">            int pos = this.getLastPosition(newParent.getCode(), conn) + 1;</span>
<span class="nc" id="L770">            stat = conn.prepareStatement(UPDATE_PAGE_TREE_POSITION);</span>
<span class="nc" id="L771">            stat.setString(1, newParent.getCode());</span>
<span class="nc" id="L772">            stat.setInt(2, pos);</span>
<span class="nc" id="L773">            stat.setString(3, currentPage.getCode());</span>
<span class="nc" id="L774">            stat.executeUpdate();</span>
<span class="nc" id="L775">            this.shiftPages(currentPage.getParentCode(), currentPage.getPosition(), conn);</span>
<span class="nc" id="L776">            this.updatePageMetadataDraftLastUpdate(currentPage.getCode(), new Date(), conn);</span>
<span class="nc" id="L777">            conn.commit();</span>
<span class="nc" id="L778">        } catch (Throwable t) {</span>
<span class="nc" id="L779">            this.executeRollback(conn);</span>
<span class="nc" id="L780">            _logger.error(&quot;Error while moving the page {} under {}&quot; + newParent, currentPage, newParent, t);</span>
<span class="nc" id="L781">            throw new RuntimeException(&quot;Error while moving the page &quot; + currentPage + &quot; under &quot; + newParent, t);</span>
        } finally {
<span class="nc" id="L783">            this.closeDaoResources(null, stat, conn);</span>
        }
<span class="nc" id="L785">    }</span>

    private int getLastPosition(String parentPageCode, Connection conn) {
<span class="nc" id="L788">        int position = 0;</span>
<span class="nc" id="L789">        PreparedStatement stat = null;</span>
<span class="nc" id="L790">        ResultSet res = null;</span>
        try {
<span class="nc" id="L792">            stat = conn.prepareStatement(GET_LAST_CHILDREN_POSITION);</span>
<span class="nc" id="L793">            stat.setString(1, parentPageCode);</span>
<span class="nc" id="L794">            res = stat.executeQuery();</span>
<span class="nc bnc" id="L795" title="All 2 branches missed.">            if (res.next()) {</span>
<span class="nc" id="L796">                position = res.getInt(1);</span>
            }
<span class="nc" id="L798">        } catch (Throwable t) {</span>
<span class="nc" id="L799">            _logger.error(&quot;Error loading LastPosition&quot;, t);</span>
<span class="nc" id="L800">            throw new RuntimeException(&quot;Error loading LastPosition&quot;, t);</span>
        } finally {
<span class="nc" id="L802">            this.closeDaoResources(res, stat);</span>
        }
<span class="nc" id="L804">        return position;</span>
    }

    private void updatePageMetadataDraftLastUpdate(String pageCode, Date date, Connection conn) throws SQLException {
<span class="nc" id="L808">        this.updatePageMetatataUpdate(pageCode, date, PageMetadataDraft.TABLE_NAME, conn);</span>
<span class="nc" id="L809">    }</span>

    private void updatePageMetadataOnlineLastUpdate(String pageCode, Date date, Connection conn) throws SQLException {
<span class="nc" id="L812">        this.updatePageMetatataUpdate(pageCode, date, PageMetadataOnline.TABLE_NAME, conn);</span>
<span class="nc" id="L813">    }</span>

    private void updatePageMetatataUpdate(String pageCode, Date date, String tablename, Connection conn) throws SQLException {
<span class="nc" id="L816">        PreparedStatement stat = null;</span>
        try {
<span class="nc" id="L818">            String query = &quot;UPDATE &quot; + tablename + &quot; SET updatedat = ? WHERE code = ?&quot;;</span>
<span class="nc" id="L819">            stat = conn.prepareStatement(query);</span>
<span class="nc" id="L820">            stat.setTimestamp(1, new Timestamp(date.getTime()));</span>
<span class="nc" id="L821">            stat.setString(2, pageCode);</span>
<span class="nc" id="L822">            stat.executeUpdate();</span>
<span class="nc" id="L823">        } catch (Throwable t) {</span>
<span class="nc" id="L824">            _logger.error(&quot;Error while updating the page metadata record for table {} and page {}&quot;, PageMetadataDraft.TABLE_NAME, pageCode,</span>
                    t);
<span class="nc" id="L826">            throw new RuntimeException(&quot;Error while updating the page metadata record for table &quot; + PageMetadataDraft.TABLE_NAME</span>
                    + &quot; and page &quot; + pageCode, t);
        } finally {
<span class="nc" id="L829">            closeDaoResources(null, stat);</span>
        }
<span class="nc" id="L831">    }</span>

    @Override
    public List&lt;String&gt; loadLastUpdatedPages(int size) {
<span class="nc" id="L835">        Connection conn = null;</span>
<span class="nc" id="L836">        PreparedStatement stat = null;</span>
<span class="nc" id="L837">        ResultSet res = null;</span>
<span class="nc" id="L838">        List&lt;String&gt; pages = new ArrayList&lt;&gt;();</span>
        try {
<span class="nc" id="L840">            conn = this.getConnection();</span>
<span class="nc" id="L841">            String query = LOAD_LAST_UPDATED_PAGES;</span>
<span class="nc" id="L842">            stat = conn.prepareStatement(query);</span>
<span class="nc" id="L843">            res = stat.executeQuery();</span>
<span class="nc" id="L844">            int limit = 1;</span>
<span class="nc bnc" id="L845" title="All 4 branches missed.">            while (res.next() &amp;&amp; limit++ &lt;= size) {</span>
<span class="nc" id="L846">                pages.add(res.getString(&quot;code&quot;));</span>
            }
<span class="nc" id="L848">        } catch (Throwable t) {</span>
<span class="nc" id="L849">            _logger.error(&quot;Error loading lastUpdatedPages&quot;, t);</span>
<span class="nc" id="L850">            throw new RuntimeException(&quot;Error loading lastUpdatedPages&quot;, t);</span>
        } finally {
<span class="nc" id="L852">            closeDaoResources(res, stat, conn);</span>
        }
<span class="nc" id="L854">        return pages;</span>
    }

    protected IPageModelManager getPageModelManager() {
<span class="nc" id="L858">        return _pageModelManager;</span>
    }

    public void setPageModelManager(IPageModelManager pageModelManager) {
<span class="nc" id="L862">        this._pageModelManager = pageModelManager;</span>
<span class="nc" id="L863">    }</span>

    public IWidgetTypeManager getWidgetTypeManager() {
<span class="nc" id="L866">        return _widgetTypeManager;</span>
    }

    public void setWidgetTypeManager(IWidgetTypeManager widgetTypeManager) {
<span class="nc" id="L870">        this._widgetTypeManager = widgetTypeManager;</span>
<span class="nc" id="L871">    }</span>

<span class="nc" id="L873">    protected enum WidgetConfigDest {</span>
<span class="nc" id="L874">        ON_LINE, DRAFT</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>