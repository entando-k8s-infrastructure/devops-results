<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MailConfigDOM.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Entando Plugin: Email Sender</a> &gt; <a href="index.source.html" class="el_package">com.agiletec.plugins.jpmail.aps.services.mail.parse</a> &gt; <span class="el_source">MailConfigDOM.java</span></div><h1>MailConfigDOM.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2015-Present Entando Inc. (http://www.entando.com) All rights reserved.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the &quot;Software&quot;), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
package com.agiletec.plugins.jpmail.aps.services.mail.parse;

import java.io.StringReader;
import java.util.List;
import java.util.Map.Entry;

import org.jdom.Document;
import org.jdom.Element;
import org.jdom.input.SAXBuilder;
import org.jdom.output.XMLOutputter;

import com.agiletec.aps.system.ApsSystemUtils;
import com.agiletec.aps.system.exception.ApsSystemException;
import com.agiletec.plugins.jpmail.aps.services.JpmailSystemConstants;
import com.agiletec.plugins.jpmail.aps.services.mail.MailConfig;
import java.util.Iterator;
import org.jdom.output.Format;

/*
&lt;mailConfig&gt;
	&lt;active&gt;true&lt;/active&gt;
	&lt;senders&gt;
		&lt;sender code=&quot;CODE1&quot;&gt;EMAIL1@EMAIL.COM&lt;/sender&gt;
		&lt;sender code=&quot;CODE2&quot;&gt;EMAIL2@EMAIL.COM&lt;/sender&gt;
	&lt;/senders&gt;
	&lt;smtp debug=&quot;false&quot; &gt;
		&lt;host&gt;SMTP.EMAIL.COM&lt;/host&gt;
		&lt;port&gt;25&lt;/port&gt;
		&lt;timeout&gt;10000&lt;/timeout&gt;
		&lt;user&gt;USER&lt;/user&gt;
		&lt;password&gt;PASSWORD&lt;/password&gt;
		&lt;security&gt;STD|SSL|TLS&lt;/security&gt;
	&lt;/smtp&gt;
&lt;/mailConfig&gt;
 */

/**
 * Class that provides read and update operations for the jpmail plugin xml configuration.
 * @author E.Santoboni, E.Mezzano
 */
<span class="nc" id="L62">public class MailConfigDOM {</span>
	
	/**
	 * Extract the jpmail configuration from an xml.
	 * @param xml The xml containing the configuration.
	 * @return The jpmail configuration.
	 * @throws ApsSystemException In case of parsing errors.
	 */
	public MailConfig extractConfig(String xml) throws ApsSystemException {
<span class="nc" id="L71">		MailConfig config = new MailConfig();</span>
<span class="nc" id="L72">		Element root = this.getRootElement(xml);</span>
<span class="nc" id="L73">		Element activeElem = root.getChild(ACTIVE_ELEM);</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">		if (activeElem != null) {</span>
<span class="nc" id="L75">			String active = activeElem.getText();</span>
<span class="nc bnc" id="L76" title="All 4 branches missed.">			config.setActive(null != active &amp;&amp; active.equalsIgnoreCase(&quot;true&quot;));</span>
		}
<span class="nc" id="L78">		this.extractSenders(root, config);</span>
<span class="nc" id="L79">		this.extractSmtp(root, config);</span>
<span class="nc" id="L80">		return config;</span>
	}
	
	/**
	 * Create an xml containing the jpmail configuration.
	 * @param config The jpmail configuration.
	 * @return The xml containing the configuration.
	 * @throws ApsSystemException In case of errors.
	 */
	public String createConfigXml(MailConfig config) throws ApsSystemException {
<span class="nc" id="L90">		Element root = this.createConfigElement(config);</span>
<span class="nc" id="L91">		Document doc = new Document(root);</span>
<span class="nc" id="L92">		XMLOutputter out = new XMLOutputter();</span>
<span class="nc" id="L93">		Format format = Format.getPrettyFormat();</span>
<span class="nc" id="L94">		format.setIndent(&quot;\t&quot;);</span>
<span class="nc" id="L95">		out.setFormat(format);</span>
<span class="nc" id="L96">		return out.outputString(doc);</span>
	}
	
	/**
	 * Extract the senders from the xml element and save it into the MailConfig object.
	 * @param root The xml root element containing the senders configuration.
	 * @param config The configuration.
	 */
	private void extractSenders(Element root, MailConfig config) {
<span class="nc" id="L105">		Element sendersRootElem = root.getChild(SENDERS_ELEM);</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">		if (sendersRootElem!=null) {</span>
<span class="nc" id="L107">			List sendersElem = sendersRootElem.getChildren(SENDER_CHILD);</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">			for (int i=0; i&lt;sendersElem.size(); i++) {</span>
<span class="nc" id="L109">				Element senderElem = (Element) sendersElem.get(i);</span>
<span class="nc" id="L110">				String code = senderElem.getAttributeValue(SENDER_CODE_ATTR);</span>
<span class="nc" id="L111">				String sender = senderElem.getText();</span>
<span class="nc" id="L112">				config.addSender(code, sender);</span>
			}
		}
<span class="nc" id="L115">	}</span>
	
	/**
	 * Extract the smtp configuration from the xml element and save it into the MailConfig object.
	 * @param root The xml root element containing the smtp configuration.
	 * @param config The configuration.
	 */
	private void extractSmtp(Element root, MailConfig config) {
<span class="nc" id="L123">		Element smtpElem = root.getChild(SMTP_ELEM);</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">		if (smtpElem != null) {</span>
<span class="nc" id="L125">			String debug = smtpElem.getAttributeValue(SMTP_DEBUG_ATTR);</span>
<span class="nc" id="L126">			config.setDebug(&quot;true&quot;.equalsIgnoreCase(debug));</span>
<span class="nc" id="L127">			config.setSmtpHost(smtpElem.getChildText(SMTP_HOST_CHILD));</span>
<span class="nc" id="L128">			String port = smtpElem.getChildText(SMTP_PORT_CHILD);</span>
<span class="nc bnc" id="L129" title="All 4 branches missed.">			if (port != null &amp;&amp; port.trim().length() &gt; 0) {</span>
<span class="nc" id="L130">				config.setSmtpPort(new Integer(port.trim()));</span>
			}
<span class="nc" id="L132">			String timeout = smtpElem.getChildText(SMTP_TIMEOUT_CHILD);</span>
<span class="nc bnc" id="L133" title="All 4 branches missed.">			if (timeout != null &amp;&amp; timeout.trim().length() &gt; 0) {</span>
<span class="nc" id="L134">				config.setSmtpTimeout(new Integer(timeout.trim()));</span>
			}
<span class="nc" id="L136">			config.setSmtpUserName(smtpElem.getChildText(SMTP_USER_CHILD));</span>
<span class="nc" id="L137">			config.setSmtpPassword(smtpElem.getChildText(SMTP_PASSWORD_CHILD));</span>
<span class="nc" id="L138">			String proto = smtpElem.getChildText(SMTP_PROTOCOL_CHILD);</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">			if (null != proto) {</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">				if (proto.equalsIgnoreCase(PROTO_SSL)) {</span>
<span class="nc" id="L141">					config.setSmtpProtocol(JpmailSystemConstants.PROTO_SSL);</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">				} else if (proto.equalsIgnoreCase(PROTO_TLS)) {</span>
<span class="nc" id="L143">					config.setSmtpProtocol(JpmailSystemConstants.PROTO_TLS);</span>
				} else {
					// any unknown protocol will disable encryption
<span class="nc" id="L146">					config.setSmtpProtocol(JpmailSystemConstants.PROTO_STD);</span>
				}
			}
		}
<span class="nc" id="L150">	}</span>
	
	/**
	 * Extract the smtp configuration from the xml element and save it into the MailConfig object.
	 * @param root The xml root element containing the smtp configuration.
	 * @param config The configuration.
	 */
	private Element createConfigElement(MailConfig config) {
<span class="nc" id="L158">		Element configElem = new Element(ROOT);</span>
<span class="nc" id="L159">		Element activeElement = new Element(ACTIVE_ELEM);</span>
<span class="nc" id="L160">		activeElement.setText(String.valueOf(config.isActive()));</span>
<span class="nc" id="L161">		configElem.addContent(activeElement);</span>
<span class="nc" id="L162">		Element sendersElem = this.createSendersElement(config);</span>
<span class="nc" id="L163">		configElem.addContent(sendersElem);</span>
<span class="nc" id="L164">		Element smtpElem = this.createSmtpElement(config);</span>
<span class="nc" id="L165">		configElem.addContent(smtpElem);</span>
<span class="nc" id="L166">		return configElem;</span>
	}
	
	/**
	 * Create the senders element starting from the given MailConfig.
	 * @param config The configuration.
	 */
	private Element createSendersElement(MailConfig config) {
<span class="nc" id="L174">		Element sendersElem = new Element(SENDERS_ELEM);</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">		if (null != config.getSenders()) {</span>
<span class="nc" id="L176">			Iterator&lt;String&gt; codeIter = config.getSenders().keySet().iterator();</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">			while (codeIter.hasNext()) {</span>
<span class="nc" id="L178">				String key = codeIter.next();</span>
<span class="nc" id="L179">				Element senderElement = new Element(SENDER_CHILD);</span>
<span class="nc" id="L180">				senderElement.setAttribute(SENDER_CODE_ATTR, key);</span>
<span class="nc" id="L181">				senderElement.addContent(config.getSenders().get(key));</span>
<span class="nc" id="L182">				sendersElem.addContent(senderElement);</span>
<span class="nc" id="L183">			}</span>
		}
<span class="nc" id="L185">		return sendersElem;</span>
	}
	
	/**
	 * Create the smtp element starting from the given MailConfig.
	 * @param config The configuration.
	 */
	private Element createSmtpElement(MailConfig config) {
<span class="nc" id="L193">		Element smtpElem = new Element(SMTP_ELEM);</span>
<span class="nc" id="L194">		smtpElem.setAttribute(SMTP_DEBUG_ATTR, String.valueOf(config.isDebug()));</span>
		
<span class="nc" id="L196">		Element hostElem = new Element(SMTP_HOST_CHILD);</span>
<span class="nc" id="L197">		hostElem.addContent(config.getSmtpHost());</span>
<span class="nc" id="L198">		smtpElem.addContent(hostElem);</span>
		
<span class="nc" id="L200">		Integer port = config.getSmtpPort();</span>
<span class="nc bnc" id="L201" title="All 4 branches missed.">		if (null != port &amp;&amp; port.intValue() != 0) {</span>
<span class="nc" id="L202">			Element portElem = new Element(SMTP_PORT_CHILD);</span>
<span class="nc" id="L203">			portElem.addContent(config.getSmtpPort().toString());</span>
<span class="nc" id="L204">			smtpElem.addContent(portElem);</span>
		}
		
<span class="nc" id="L207">		Integer timeout = config.getSmtpTimeout();</span>
<span class="nc bnc" id="L208" title="All 4 branches missed.">		if (null != timeout &amp;&amp; timeout.intValue() != 0) {</span>
<span class="nc" id="L209">			Element timeoutElem = new Element(SMTP_TIMEOUT_CHILD);</span>
<span class="nc" id="L210">			timeoutElem.addContent(config.getSmtpTimeout().toString());</span>
<span class="nc" id="L211">			smtpElem.addContent(timeoutElem);</span>
		}
		
<span class="nc" id="L214">		Element userElem = new Element(SMTP_USER_CHILD);</span>
<span class="nc" id="L215">		userElem.addContent(config.getSmtpUserName());</span>
<span class="nc" id="L216">		smtpElem.addContent(userElem);</span>
		
<span class="nc" id="L218">		Element passwordElem = new Element(SMTP_PASSWORD_CHILD);</span>
<span class="nc" id="L219">		passwordElem.addContent(config.getSmtpPassword());</span>
<span class="nc" id="L220">		smtpElem.addContent(passwordElem);</span>
		
<span class="nc bnc" id="L222" title="All 2 branches missed.">		if (null != config.getSmtpProtocol()) {</span>
<span class="nc" id="L223">			Element protocolElem = new Element(SMTP_PROTOCOL_CHILD);</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">			if (config.getSmtpProtocol() == JpmailSystemConstants.PROTO_SSL) {</span>
<span class="nc" id="L225">				protocolElem.addContent(PROTO_SSL);</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">			} else if (config.getSmtpProtocol() == JpmailSystemConstants.PROTO_TLS) {</span>
<span class="nc" id="L227">				protocolElem.addContent(PROTO_TLS);</span>
			} else {
				// any other (unsupported) protocol falls back to STD (no security transport layer)
<span class="nc" id="L230">				protocolElem.addContent(PROTO_STD);</span>
			}
<span class="nc" id="L232">			smtpElem.addContent(protocolElem);</span>
		}
		
<span class="nc" id="L235">		return smtpElem;</span>
	}
	
	/**
	 * Returns the Xml element from a given text.
	 * @param xmlText The text containing an Xml.
	 * @return The Xml element from a given text.
	 * @throws ApsSystemException In case of parsing exceptions.
	 */
	private Element getRootElement(String xmlText) throws ApsSystemException {
<span class="nc" id="L245">		SAXBuilder builder = new SAXBuilder();</span>
<span class="nc" id="L246">		builder.setValidation(false);</span>
<span class="nc" id="L247">		StringReader reader = new StringReader(xmlText);</span>
<span class="nc" id="L248">		Element root = null;</span>
		try {
<span class="nc" id="L250">			Document doc = builder.build(reader);</span>
<span class="nc" id="L251">			root = doc.getRootElement();</span>
<span class="nc" id="L252">		} catch (Throwable t) {</span>
<span class="nc" id="L253">			ApsSystemUtils.getLogger().error(&quot;Error parsing xml: &quot; + t.getMessage());</span>
<span class="nc" id="L254">			throw new ApsSystemException(&quot;Error parsing xml&quot;, t);</span>
<span class="nc" id="L255">		}</span>
<span class="nc" id="L256">		return root;</span>
	}
	
<span class="nc" id="L259">	private final String ROOT = &quot;mailConfig&quot;;</span>
	
<span class="nc" id="L261">	private final String SENDERS_ELEM = &quot;senders&quot;;</span>
<span class="nc" id="L262">	private final String SENDER_CHILD = &quot;sender&quot;;</span>
<span class="nc" id="L263">	private final String SENDER_CODE_ATTR = &quot;code&quot;;</span>
	
<span class="nc" id="L265">	private final String ACTIVE_ELEM = &quot;active&quot;;</span>
	
<span class="nc" id="L267">	private final String SMTP_ELEM = &quot;smtp&quot;;</span>
<span class="nc" id="L268">	private final String SMTP_DEBUG_ATTR = &quot;debug&quot;;</span>
<span class="nc" id="L269">	private final String SMTP_HOST_CHILD = &quot;host&quot;;</span>
<span class="nc" id="L270">	private final String SMTP_PORT_CHILD = &quot;port&quot;;</span>
<span class="nc" id="L271">	private final String SMTP_TIMEOUT_CHILD = &quot;timeout&quot;;</span>
<span class="nc" id="L272">	private final String SMTP_USER_CHILD = &quot;user&quot;;</span>
<span class="nc" id="L273">	private final String SMTP_PASSWORD_CHILD = &quot;password&quot;;</span>
<span class="nc" id="L274">	private final String SMTP_PROTOCOL_CHILD = &quot;security&quot;;</span>
	
<span class="nc" id="L276">	private final String PROTO_SSL = &quot;ssl&quot;;</span>
<span class="nc" id="L277">	private final String PROTO_TLS = &quot;tls&quot;;</span>
<span class="nc" id="L278">	private final String PROTO_STD = &quot;std&quot;;</span>
	
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>