<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PageAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Entando Core: Administration Console</a> &gt; <a href="index.source.html" class="el_package">com.agiletec.apsadmin.portal</a> &gt; <span class="el_source">PageAction.java</span></div><h1>PageAction.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2015-Present Entando Inc. (http://www.entando.com) All rights reserved.
 *
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 */
package com.agiletec.apsadmin.portal;

import com.agiletec.aps.system.exception.ApsSystemException;
import com.agiletec.aps.system.services.group.Group;
import com.agiletec.aps.system.services.lang.Lang;
import com.agiletec.aps.system.services.page.*;
import com.agiletec.aps.system.services.pagemodel.IPageModelManager;
import com.agiletec.aps.system.services.pagemodel.PageModel;
import com.agiletec.aps.util.ApsProperties;
import com.agiletec.apsadmin.portal.helper.IPageActionHelper;
import com.agiletec.apsadmin.portal.helper.IPageActionReferencesHelper;
import com.agiletec.apsadmin.system.ApsAdminSystemConstants;
import com.agiletec.apsadmin.system.BaseActionHelper;
import org.apache.commons.beanutils.BeanComparator;
import org.apache.commons.lang3.StringUtils;
import org.apache.struts2.interceptor.ServletResponseAware;
import org.entando.entando.aps.system.services.actionlog.model.ActivityStreamInfo;
import org.entando.entando.apsadmin.portal.PageActionConstants;
import org.entando.entando.apsadmin.portal.rs.model.PageResponse;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.servlet.http.HttpServletResponse;
import javax.ws.rs.core.Response.Status;
import java.util.*;

/**
 * Main action for pages handling
 *
 * @author E.Santoboni
 */
<span class="nc" id="L45">public class PageAction extends AbstractPortalAction implements ServletResponseAware {</span>

<span class="nc" id="L47">    private static final Logger logger = LoggerFactory.getLogger(PageAction.class);</span>

    private static final int PAGE_TITLE_MAX_LENGTH = 70;
    
    private String pageCode;
    private String parentPageCode;
    private String copyPageCode;
    private String group;
    private boolean groupSelectLock;
<span class="nc" id="L56">    private Set&lt;String&gt; extraGroups = new TreeSet&lt;&gt;();</span>
    private String model;
<span class="nc" id="L58">    private boolean defaultShowlet = false;</span>
<span class="nc" id="L59">    private ApsProperties titles = new ApsProperties();</span>
<span class="nc" id="L60">    private boolean showable = false;</span>
    private boolean useExtraTitles;
    private int strutsAction;

    private String mimeType;
    private String charset;

    private String nodeToBeDelete;

    private String extraGroupNameToRemove;

    private IPage pageToShow;

    private Map references;

    private String _allowedMimeTypesCSV;
    private String _allowedCharsetsCSV;

    private String targetNode;
<span class="nc" id="L79">    private Set&lt;String&gt; treeNodesToOpen = new HashSet&lt;&gt;();</span>
    private String treeNodeActionMarkerCode;

    private HttpServletResponse response;

    private IPageModelManager pageModelManager;
    private IPageActionHelper pageActionHelper;
    private IPageActionReferencesHelper pageActionReferencesHelper;

    @Override
    public void validate() {
<span class="nc" id="L90">        super.validate();</span>
<span class="nc bnc" id="L91" title="All 4 branches missed.">        if (this.getStrutsAction() == ApsAdminSystemConstants.ADD || this.getStrutsAction() == ApsAdminSystemConstants.PASTE) {</span>
<span class="nc" id="L92">            this.checkParentNode(this.getParentPageCode());</span>
        }
<span class="nc" id="L94">        this.checkCode();</span>
<span class="nc" id="L95">        this.checkTitles();</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">        if (this.getAuthorizationManager().isAuthOnGroup(this.getCurrentUser(), Group.ADMINS_GROUP_NAME)) {</span>
            try {
<span class="nc bnc" id="L98" title="All 2 branches missed.">                IPage currentPage = (this.getStrutsAction() == ApsAdminSystemConstants.EDIT) ? this.getUpdatedPage() : this.buildNewPage();</span>
<span class="nc" id="L99">                boolean check = this.getPageActionHelper().checkPageGroup(currentPage, this);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">                if (!check) {</span>
<span class="nc" id="L101">                    logger.error(&quot;Error checking page group&quot;);</span>
<span class="nc" id="L102">                    this.addActionError(this.getText(&quot;error.page.scanGroup&quot;));</span>
                }
<span class="nc" id="L104">            } catch (Exception e) {</span>
<span class="nc" id="L105">                logger.error(&quot;Error validation groups&quot;, e);</span>
<span class="nc" id="L106">                throw new RuntimeException(&quot;Error validation groups&quot;, e);</span>
<span class="nc" id="L107">            }</span>
        }
<span class="nc" id="L109">    }</span>

    protected String checkParentNode(String selectedNode) {
<span class="nc bnc" id="L112" title="All 4 branches missed.">        if (null == selectedNode || selectedNode.trim().length() == 0) {</span>
<span class="nc" id="L113">            this.addFieldError(&quot;parentPageCode&quot;, this.getText(&quot;error.parentPage.noSelection&quot;));</span>
<span class="nc" id="L114">            return &quot;pageTree&quot;;</span>
        }
<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (VIRTUAL_ROOT_CODE.equals(selectedNode)) {</span>
<span class="nc" id="L117">            this.addFieldError(&quot;parentPageCode&quot;, this.getText(&quot;error.parentPage.virtualRootSelected&quot;));</span>
<span class="nc" id="L118">            return &quot;pageTree&quot;;</span>
        }
<span class="nc" id="L120">        IPage selectedPage = this.getPage(selectedNode);</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (null == selectedPage) {</span>
<span class="nc" id="L122">            this.addFieldError(&quot;parentPageCode&quot;, this.getText(&quot;error.parentPage.selectedPage.null&quot;));</span>
<span class="nc" id="L123">            return &quot;pageTree&quot;;</span>
        }
<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (!this.isUserAllowed(selectedPage)) {</span>
<span class="nc" id="L126">            this.addFieldError(&quot;parentPageCode&quot;, this.getText(&quot;error.parentPage.userNotAllowed&quot;));</span>
<span class="nc" id="L127">            return &quot;pageTree&quot;;</span>
        }
<span class="nc" id="L129">        return null;</span>
    }

    protected void checkTitles() {
<span class="nc" id="L133">        this.updateTitles();</span>
<span class="nc" id="L134">        Iterator&lt;Lang&gt; langsIter = this.getLangManager().getLangs().iterator();</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">        while (langsIter.hasNext()) {</span>
<span class="nc" id="L136">            Lang lang = langsIter.next();</span>
<span class="nc" id="L137">            String title = (String) this.getTitles().get(lang.getCode());</span>
<span class="nc" id="L138">            String titleKey = &quot;lang&quot; + lang.getCode();</span>
<span class="nc bnc" id="L139" title="All 4 branches missed.">            if (null == title || title.trim().length() == 0) {</span>
<span class="nc" id="L140">                String[] args = {lang.getDescr()};</span>
<span class="nc" id="L141">                this.addFieldError(titleKey, this.getText(&quot;error.page.insertTitle&quot;, args));</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">            } else if (title.length() &gt; PAGE_TITLE_MAX_LENGTH) {</span>
<span class="nc" id="L143">                String[] args = {lang.getCode(), String.valueOf(PAGE_TITLE_MAX_LENGTH)};</span>
<span class="nc" id="L144">                this.addFieldError(titleKey, this.getText(&quot;error.page.wrongTitleMaxLength&quot;, args));</span>
            }
<span class="nc" id="L146">        }</span>
<span class="nc" id="L147">    }</span>

    protected void updateTitles() {
<span class="nc" id="L150">        Iterator&lt;Lang&gt; langsIter = this.getLangManager().getLangs().iterator();</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">        while (langsIter.hasNext()) {</span>
<span class="nc" id="L152">            Lang lang = (Lang) langsIter.next();</span>
<span class="nc" id="L153">            String titleKey = &quot;lang&quot; + lang.getCode();</span>
<span class="nc" id="L154">            String title = this.getRequest().getParameter(titleKey);</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">            if (null != title) {</span>
<span class="nc" id="L156">                this.getTitles().put(lang.getCode(), title.trim());</span>
            }
<span class="nc" id="L158">        }</span>
<span class="nc" id="L159">    }</span>

    protected void checkCode() {
<span class="nc" id="L162">        String code = this.getPageCode();</span>
<span class="nc bnc" id="L163" title="All 6 branches missed.">        if ((this.getStrutsAction() == ApsAdminSystemConstants.ADD || this.getStrutsAction() == ApsAdminSystemConstants.PASTE)</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">                &amp;&amp; null != code &amp;&amp; code.trim().length() &gt; 0) {</span>
<span class="nc" id="L165">            String currectCode = BaseActionHelper.purgeString(code.trim());</span>
<span class="nc bnc" id="L166" title="All 4 branches missed.">            if (currectCode.length() &gt; 0 &amp;&amp; null != this.getPage(currectCode)) {</span>
<span class="nc" id="L167">                String[] args = {currectCode};</span>
<span class="nc" id="L168">                this.addFieldError(&quot;pageCode&quot;, this.getText(&quot;error.page.duplicateCode&quot;, args));</span>
            }
<span class="nc" id="L170">            this.setPageCode(currectCode);</span>
        }
<span class="nc" id="L172">    }</span>

    public String newPage() {
<span class="nc" id="L175">        String selectedNode = this.getParentPageCode();</span>
        try {
<span class="nc bnc" id="L177" title="All 2 branches missed.">            if (StringUtils.isEmpty(selectedNode)) {</span>
<span class="nc" id="L178">                selectedNode = this.getSelectedNode();</span>
            }
<span class="nc" id="L180">            IPage parentPage = null;</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">            if (StringUtils.isNotEmpty(selectedNode)) {</span>
<span class="nc" id="L182">                String check = this.checkSelectedNode(selectedNode);</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">                if (null != check) {</span>
<span class="nc" id="L184">                    return check;</span>
                }
<span class="nc" id="L186">                parentPage = this.getPage(selectedNode);</span>
            }
<span class="nc" id="L188">            this.valueFormForNew(parentPage);</span>
<span class="nc" id="L189">            this.setCharset(&quot;utf-8&quot;);</span>
<span class="nc" id="L190">            this.setMimeType(&quot;text/html&quot;);</span>
<span class="nc" id="L191">        } catch (Throwable t) {</span>
<span class="nc" id="L192">            logger.error(&quot;error in newPage&quot;, t);</span>
<span class="nc" id="L193">            return FAILURE;</span>
<span class="nc" id="L194">        }</span>
<span class="nc" id="L195">        return SUCCESS;</span>
    }

    public String settingsPage() {
<span class="nc" id="L199">        return SUCCESS;</span>
    }

    protected void valueFormForNew(IPage parentPage) {
<span class="nc" id="L203">        this.setStrutsAction(ApsAdminSystemConstants.ADD);</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">        if (parentPage != null) {</span>
<span class="nc" id="L205">            this.setParentPageCode(parentPage.getCode());</span>
<span class="nc" id="L206">            String groupName = parentPage.getGroup();</span>
<span class="nc" id="L207">            this.setGroup(groupName);</span>
        }
<span class="nc" id="L209">        this.setGroupSelectLock(false);</span>
<span class="nc" id="L210">        this.setDefaultShowlet(true);</span>
<span class="nc" id="L211">        this.setShowable(true);</span>
<span class="nc" id="L212">    }</span>

    public String edit() {
<span class="nc" id="L215">        String selectedPageCode = this.getSelectedNode();</span>
        try {
<span class="nc" id="L217">            String check = this.checkSelectedNode(selectedPageCode);</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">            if (null != check) {</span>
<span class="nc" id="L219">                return check;</span>
            }
<span class="nc" id="L221">            IPage page = this.getPage(selectedPageCode);</span>
<span class="nc" id="L222">            this.valueFormForEdit(page);</span>
<span class="nc" id="L223">        } catch (Throwable t) {</span>
<span class="nc" id="L224">            logger.error(&quot;error in edit&quot;, t);</span>
<span class="nc" id="L225">            return FAILURE;</span>
<span class="nc" id="L226">        }</span>
<span class="nc" id="L227">        return SUCCESS;</span>
    }

    public String entryEdit() {
        try {
<span class="nc" id="L232">            this.updateTitles();</span>
<span class="nc" id="L233">        } catch (Throwable t) {</span>
<span class="nc" id="L234">            logger.error(&quot;error in entry edit&quot;, t);</span>
<span class="nc" id="L235">            return FAILURE;</span>
<span class="nc" id="L236">        }</span>
<span class="nc" id="L237">        return SUCCESS;</span>
    }

    public String joinExtraGroup() {
        try {
<span class="nc" id="L242">            this.updateTitles();</span>
<span class="nc" id="L243">            String[] groupNameList = super.getParameters().get(&quot;extraGroupNameToAdd&quot;);</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">            if (groupNameList != null) {</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">                for (String groupName : groupNameList) {</span>
<span class="nc" id="L246">                    this.getExtraGroups().add(groupName);</span>
                }
            }
<span class="nc" id="L249">        } catch (Throwable t) {</span>
<span class="nc" id="L250">            logger.error(&quot;error in joinExtraGroup&quot;, t);</span>
<span class="nc" id="L251">            return FAILURE;</span>
<span class="nc" id="L252">        }</span>
<span class="nc" id="L253">        return SUCCESS;</span>
    }

    public String removeExtraGroup() {
        try {
<span class="nc" id="L258">            this.updateTitles();</span>
<span class="nc" id="L259">            this.getExtraGroups().remove(this.getExtraGroupNameToRemove());</span>
<span class="nc" id="L260">        } catch (Throwable t) {</span>
<span class="nc" id="L261">            logger.error(&quot;error in removeExtraGroup&quot;, t);</span>
<span class="nc" id="L262">            return FAILURE;</span>
<span class="nc" id="L263">        }</span>
<span class="nc" id="L264">        return SUCCESS;</span>
    }

    public String showDetail() {
<span class="nc" id="L268">        String selectedPageCode = this.getSelectedNode();</span>
        try {
<span class="nc" id="L270">            String check = this.checkSelectedNode(selectedPageCode);</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">            if (null != check) {</span>
<span class="nc" id="L272">                return check;</span>
            }
<span class="nc" id="L274">            IPage page = this.getPage(selectedPageCode);</span>
<span class="nc" id="L275">            Map extractedReferences = this.getPageActionHelper().getReferencingObjects(page, this.getRequest());</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">            if (null != extractedReferences) {</span>
<span class="nc" id="L277">                this.setReferences(extractedReferences);</span>
            }
<span class="nc" id="L279">            this.setPageToShow(page);</span>
<span class="nc" id="L280">        } catch (Throwable t) {</span>
<span class="nc" id="L281">            logger.error(&quot;error in showDetail&quot;, t);</span>
<span class="nc" id="L282">            return FAILURE;</span>
<span class="nc" id="L283">        }</span>
<span class="nc" id="L284">        return SUCCESS;</span>
    }

    protected void valueFormForEdit(IPage pageToEdit) throws CloneNotSupportedException {
<span class="nc" id="L288">        this.setStrutsAction(ApsAdminSystemConstants.EDIT);</span>
<span class="nc" id="L289">        this.setParentPageCode(pageToEdit.getParentCode());</span>
<span class="nc" id="L290">        this.setPageCode(pageToEdit.getCode());</span>
<span class="nc" id="L291">        this.setGroup(pageToEdit.getGroup());</span>
<span class="nc" id="L292">        PageMetadata draftMetadata = pageToEdit.getMetadata();</span>
<span class="nc" id="L293">        this.copyMetadataToForm(draftMetadata);</span>
<span class="nc" id="L294">        boolean isAdmin = this.getAuthorizationManager().isAuthOnGroup(this.getCurrentUser(), Group.ADMINS_GROUP_NAME);</span>
<span class="nc" id="L295">        IPage parentPage = this.getPageManager().getDraftPage(pageToEdit.getParentCode());</span>
<span class="nc bnc" id="L296" title="All 4 branches missed.">        boolean isParentFree = (pageToEdit.isRoot() || parentPage.getGroup().equals(Group.FREE_GROUP_NAME));</span>
<span class="nc bnc" id="L297" title="All 4 branches missed.">        this.setGroupSelectLock(!(isAdmin &amp;&amp; isParentFree));</span>
<span class="nc" id="L298">    }</span>

    public String copy() {
<span class="nc" id="L301">        String selectedNode = this.getSelectedNode();</span>
        try {
<span class="nc" id="L303">            String check = this.checkSelectedNode(selectedNode);</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">            if (null != check) {</span>
<span class="nc" id="L305">                return check;</span>
            }
<span class="nc" id="L307">            IPage pageToCopy = this.getPage(selectedNode);</span>
<span class="nc" id="L308">            IPage publicToCopy = this.getOnlinePage(selectedNode);</span>
<span class="nc" id="L309">            this.setStrutsAction(ApsAdminSystemConstants.PASTE);</span>
<span class="nc" id="L310">            this.setCopyPageCode(selectedNode);</span>
<span class="nc" id="L311">            this.setGroup(pageToCopy.getGroup());</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">            PageMetadata metadata = (null != publicToCopy) ? publicToCopy.getMetadata() : pageToCopy.getMetadata();</span>
<span class="nc" id="L313">            this.copyMetadataToForm(metadata);</span>
<span class="nc" id="L314">            this.getTitles().clear();</span>
<span class="nc" id="L315">            this.setParentPageCode(selectedNode);</span>
<span class="nc" id="L316">        } catch (Throwable t) {</span>
<span class="nc" id="L317">            logger.error(&quot;error in paste&quot;, t);</span>
<span class="nc" id="L318">            return FAILURE;</span>
<span class="nc" id="L319">        }</span>
<span class="nc" id="L320">        return SUCCESS;</span>
    }

    private void copyMetadataToForm(PageMetadata metadata) throws CloneNotSupportedException {
<span class="nc bnc" id="L324" title="All 2 branches missed.">        if (metadata != null) {</span>
<span class="nc" id="L325">            metadata = metadata.clone();</span>
<span class="nc" id="L326">            this.setTitles(metadata.getTitles());</span>
<span class="nc" id="L327">            this.setExtraGroups(metadata.getExtraGroups());</span>
<span class="nc" id="L328">            this.setModel(metadata.getModel().getCode());</span>
<span class="nc" id="L329">            this.setShowable(metadata.isShowable());</span>
<span class="nc" id="L330">            this.setUseExtraTitles(metadata.isUseExtraTitles());</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">            if (StringUtils.isNotBlank(metadata.getCharset())) {</span>
<span class="nc" id="L332">                this.setCharset(metadata.getCharset());</span>
            } else {
<span class="nc" id="L334">                this.setCharset(&quot;utf-8&quot;);</span>
            }
<span class="nc bnc" id="L336" title="All 2 branches missed.">            if (StringUtils.isNotBlank(metadata.getMimeType())) {</span>
<span class="nc" id="L337">                this.setMimeType(metadata.getMimeType());</span>
            } else {
<span class="nc" id="L339">                this.setMimeType(&quot;text/html&quot;);</span>
            }
        }
<span class="nc" id="L342">    }</span>

    public String save() {
<span class="nc" id="L345">        IPage page = null;</span>
        try {
<span class="nc bnc" id="L347" title="All 2 branches missed.">            if (this.getStrutsAction() == ApsAdminSystemConstants.EDIT) {</span>
<span class="nc" id="L348">                page = this.getUpdatedPage();</span>
<span class="nc" id="L349">                this.getPageManager().updatePage(page);</span>
<span class="nc" id="L350">                this.addActionMessage(this.getText(&quot;message.page.info.updated&quot;, new String[]{this.getTitle(page.getCode(), page</span>
<span class="nc" id="L351">                    .getTitles())}));</span>
<span class="nc" id="L352">                logger.debug(&quot;Updating page &quot; + page.getCode());</span>
            } else {
<span class="nc" id="L354">                page = this.buildNewPage();</span>
<span class="nc" id="L355">                this.getPageManager().addPage(page);</span>
<span class="nc" id="L356">                this.addActionMessage(this.getText(&quot;message.page.info.added&quot;, new String[]{this.getTitle(page.getCode(), page</span>
<span class="nc" id="L357">                    .getTitles())}));</span>
<span class="nc" id="L358">                logger.debug(&quot;Adding new page&quot;);</span>
            }
<span class="nc" id="L360">            this.addActivityStreamInfo(page, this.getStrutsAction(), true);</span>
<span class="nc" id="L361">        } catch (Throwable t) {</span>
<span class="nc" id="L362">            logger.error(&quot;error in save&quot;, t);</span>
<span class="nc" id="L363">            return FAILURE;</span>
<span class="nc" id="L364">        }</span>
<span class="nc" id="L365">        return SUCCESS;</span>
    }

    public String saveAndConfigure() {
<span class="nc" id="L369">        IPage page = null;</span>
        try {
<span class="nc bnc" id="L371" title="All 2 branches missed.">            if (this.getStrutsAction() == ApsAdminSystemConstants.EDIT) {</span>
<span class="nc" id="L372">                page = this.getUpdatedPage();</span>
<span class="nc" id="L373">                this.getPageManager().updatePage(page);</span>
<span class="nc" id="L374">                this.addActionMessage(this.getText(&quot;message.page.info.updated&quot;, new String[]{this.getTitle(page.getCode(), page</span>
<span class="nc" id="L375">                    .getTitles())}));</span>
<span class="nc" id="L376">                logger.debug(&quot;Updating page &quot; + page.getCode());</span>
            } else {
<span class="nc" id="L378">                page = this.buildNewPage();</span>
<span class="nc" id="L379">                this.getPageManager().addPage(page);</span>
<span class="nc" id="L380">                this.addActionMessage(this.getText(&quot;message.page.info.added&quot;, new String[]{this.getTitle(page.getCode(), page</span>
<span class="nc" id="L381">                    .getTitles())}));</span>
<span class="nc" id="L382">                logger.debug(&quot;Adding new page&quot;);</span>
            }
<span class="nc" id="L384">            this.addActivityStreamInfo(page, this.getStrutsAction(), true);</span>
<span class="nc" id="L385">            this.setPageCode(page.getCode());</span>
<span class="nc" id="L386">            this.setSelectedNode(page.getCode());</span>
<span class="nc" id="L387">        } catch (Throwable t) {</span>
<span class="nc" id="L388">            logger.error(&quot;error in save and configure&quot;, t);</span>
<span class="nc" id="L389">            return FAILURE;</span>
<span class="nc" id="L390">        }</span>
<span class="nc" id="L391">        return SUCCESS;</span>
    }

    public String pageDetails() {
<span class="nc" id="L395">        return SUCCESS;</span>
    }

    public PageResponse getPageDetailResponse() {
<span class="nc" id="L399">        PageResponse pageResponse = null;</span>
        try {
<span class="nc" id="L401">            IPage draftPage = null;</span>
<span class="nc" id="L402">            IPage onlinePage = null;</span>
<span class="nc" id="L403">            String check = this.checkSelectedNode(this.getPageCode());</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">            if (null == check) {</span>
<span class="nc" id="L405">                draftPage = this.getPage(this.getPageCode());</span>
<span class="nc" id="L406">                onlinePage = this.getOnlinePage(this.getPageCode());</span>
            }
<span class="nc" id="L408">            pageResponse = new PageResponse(this, draftPage, onlinePage);</span>
<span class="nc" id="L409">        } catch (Throwable t) {</span>
<span class="nc" id="L410">            logger.error(&quot;error in getPageJsonResponse&quot;, t);</span>
<span class="nc" id="L411">            this.getServletResponse().setStatus(Status.INTERNAL_SERVER_ERROR.getStatusCode());</span>
<span class="nc" id="L412">            return null;</span>
<span class="nc" id="L413">        }</span>
<span class="nc" id="L414">        return pageResponse;</span>
    }

    protected IPage buildNewPage() throws ApsSystemException {
<span class="nc" id="L418">        Page page = new Page();</span>
        try {
<span class="nc" id="L420">            page.setParentCode(this.getParentPageCode());</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">            if (this.getStrutsAction() == ApsAdminSystemConstants.PASTE) {</span>
<span class="nc" id="L422">                IPage copyPage = this.getPage(this.getCopyPageCode());</span>
<span class="nc" id="L423">                IPage publicPage = this.getOnlinePage(this.getCopyPageCode());</span>
<span class="nc bnc" id="L424" title="All 2 branches missed.">                page.setWidgets(null != publicPage ? publicPage.getWidgets() : copyPage.getWidgets());</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">                PageMetadata metadata = (null != publicPage) ? publicPage.getMetadata() : copyPage.getMetadata();</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">                if (metadata != null) {</span>
<span class="nc" id="L427">                    metadata = metadata.clone();</span>
<span class="nc" id="L428">                    metadata.setTitles(this.getTitles());</span>
<span class="nc" id="L429">                    page.setMetadata(metadata);</span>
                }
<span class="nc" id="L431">                page.setGroup(copyPage.getGroup());</span>
<span class="nc" id="L432">            } else {</span>
<span class="nc" id="L433">                page.setGroup(this.getGroup());</span>
<span class="nc" id="L434">                PageMetadata metadata = page.getMetadata();</span>
<span class="nc" id="L435">                this.valueMetadataFromForm(metadata);</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">                if (null != metadata.getModel()) {</span>
<span class="nc" id="L437">                    page.setWidgets(new Widget[metadata.getModel().getFrames().length]);</span>
                }
            }
            // ricava il codice
<span class="nc" id="L441">            page.setCode(this.buildNewPageCode(page.getMetadata()));</span>
<span class="nc" id="L442">        } catch (Throwable t) {</span>
<span class="nc" id="L443">            logger.error(&quot;Error building new page&quot;, t);</span>
<span class="nc" id="L444">            throw new ApsSystemException(&quot;Error building new page&quot;, t);</span>
<span class="nc" id="L445">        }</span>
<span class="nc" id="L446">        return page;</span>
    }

    private String buildNewPageCode(PageMetadata metadata) throws ApsSystemException {
<span class="nc" id="L450">        String newPageCode = this.getPageCode();</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">        if (StringUtils.isNotBlank(newPageCode)) {</span>
<span class="nc" id="L452">            newPageCode = newPageCode.trim();</span>
        } else {
<span class="nc" id="L454">            String defaultLangCode = this.getLangManager().getDefaultLang().getCode();</span>
<span class="nc" id="L455">            newPageCode = this.getPageActionHelper().buildCode(metadata.getTitle(defaultLangCode), &quot;page&quot;, 25);</span>
        }
<span class="nc" id="L457">        return newPageCode;</span>
    }

    protected IPage getUpdatedPage() throws ApsSystemException {
<span class="nc" id="L461">        Page page = null;</span>
        try {
<span class="nc" id="L463">            page = (Page) this.getPage(this.getPageCode());</span>
<span class="nc" id="L464">            page.setGroup(this.getGroup());</span>
<span class="nc" id="L465">            PageMetadata metadata = page.getMetadata();</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">            if (metadata == null) {</span>
<span class="nc" id="L467">                metadata = new PageMetadata();</span>
<span class="nc" id="L468">                page.setMetadata(metadata);</span>
            }
<span class="nc" id="L470">            PageModel oldModel = metadata.getModel();</span>
<span class="nc" id="L471">            this.valueMetadataFromForm(metadata);</span>
<span class="nc bnc" id="L472" title="All 4 branches missed.">            if (oldModel == null || !oldModel.getCode().equals(this.getModel())) {</span>
                // The model is changed, so I drop all the previous widgets
<span class="nc" id="L474">                page.setWidgets(new Widget[metadata.getModel().getFrames().length]);</span>
            }
<span class="nc" id="L476">        } catch (Throwable t) {</span>
<span class="nc" id="L477">            logger.error(&quot;Error updating page&quot;, t);</span>
<span class="nc" id="L478">            throw new ApsSystemException(&quot;Error updating page&quot;, t);</span>
<span class="nc" id="L479">        }</span>
<span class="nc" id="L480">        return page;</span>
    }

    private void valueMetadataFromForm(PageMetadata metadata) {
<span class="nc bnc" id="L484" title="All 4 branches missed.">        if (metadata.getModel() == null || !metadata.getModel().getCode().equals(this.getModel())) {</span>
            // Ho cambiato modello e allora cancello tutte le showlets
            // Precedenti
<span class="nc" id="L487">            PageModel model = this.getPageModelManager().getPageModel(this.getModel());</span>
<span class="nc" id="L488">            metadata.setModel(model);</span>
        }
<span class="nc" id="L490">        metadata.setShowable(this.isShowable());</span>
<span class="nc" id="L491">        metadata.setUseExtraTitles(this.isUseExtraTitles());</span>
<span class="nc" id="L492">        metadata.setTitles(this.getTitles());</span>
<span class="nc" id="L493">        metadata.setExtraGroups(this.getExtraGroups());</span>
<span class="nc" id="L494">        String charset = this.getCharset();</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">        metadata.setCharset(StringUtils.isNotBlank(charset) ? charset : null);</span>
<span class="nc" id="L496">        String mimetype = this.getMimeType();</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">        metadata.setMimeType(StringUtils.isNotBlank(mimetype) ? mimetype : null);</span>
<span class="nc" id="L498">        metadata.setUpdatedAt(new Date());</span>
<span class="nc" id="L499">    }</span>

    public String setDefaultWidgets() {
<span class="nc" id="L502">        Page page = null;</span>
        try {
<span class="nc" id="L504">            page = (Page) this.getPage(this.getPageCode());</span>
<span class="nc" id="L505">            PageModel model = page.getMetadata().getModel();</span>
<span class="nc" id="L506">            Widget[] defaultWidgets = model.getDefaultWidget();</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">            if (null == defaultWidgets) {</span>
<span class="nc" id="L508">                logger.info(&quot;No default Widget found for pagemodel '{}' of page '{}'&quot;, model.getCode(), page.getCode());</span>
<span class="nc" id="L509">                return SUCCESS;</span>
            }
<span class="nc" id="L511">            Widget[] widgets = new Widget[defaultWidgets.length];</span>
<span class="nc bnc" id="L512" title="All 2 branches missed.">            for (int i = 0; i &lt; defaultWidgets.length; i++) {</span>
<span class="nc" id="L513">                Widget defaultWidget = defaultWidgets[i];</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">                if (null != defaultWidget) {</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">                    if (null == defaultWidget.getType()) {</span>
<span class="nc" id="L516">                        logger.info(&quot;Widget Type null when adding defaulWidget (of pagemodel '{}') on frame '{}' of page '{}'&quot;, model</span>
<span class="nc" id="L517">                                .getCode(), i, page.getCode());</span>
<span class="nc" id="L518">                        continue;</span>
                    }
<span class="nc" id="L520">                    widgets[i] = defaultWidget;</span>
                }
            }
<span class="nc" id="L523">            page.setWidgets(widgets);</span>
<span class="nc" id="L524">            this.getPageManager().updatePage(page);</span>
<span class="nc" id="L525">        } catch (Throwable t) {</span>
<span class="nc" id="L526">            logger.error(&quot;Error setting default widget to page {}&quot;, this.getPageCode(), t);</span>
<span class="nc" id="L527">            return FAILURE;</span>
<span class="nc" id="L528">        }</span>
<span class="nc" id="L529">        return SUCCESS;</span>
    }

    public String checkSetOffline() {
<span class="nc" id="L533">        String selectedPageCode = this.getPageCode();</span>
        try {
<span class="nc bnc" id="L535" title="All 2 branches missed.">            if (StringUtils.isEmpty(selectedPageCode)) {</span>
<span class="nc" id="L536">                selectedPageCode = this.getSelectedNode();</span>
<span class="nc" id="L537">                this.setPageCode(selectedPageCode);</span>
            }
<span class="nc" id="L539">            String check = this.checkSetOffline(selectedPageCode);</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">            if (null != check) {</span>
<span class="nc" id="L541">                return check;</span>
            }
<span class="nc" id="L543">            IPage currentPage = this.getPage(selectedPageCode);</span>
<span class="nc" id="L544">            this.setSelectedNode(currentPage.getCode());</span>
<span class="nc" id="L545">        } catch (Throwable t) {</span>
<span class="nc" id="L546">            logger.error(&quot;error checking before putting page {} offline&quot;, selectedPageCode, t);</span>
<span class="nc" id="L547">            return FAILURE;</span>
<span class="nc" id="L548">        }</span>
<span class="nc" id="L549">        return SUCCESS;</span>
    }

    public String doSetOffline() {
<span class="nc" id="L553">        String selectedPageCode = this.getPageCode();</span>
        try {
<span class="nc bnc" id="L555" title="All 2 branches missed.">            if (StringUtils.isEmpty(selectedPageCode)) {</span>
<span class="nc" id="L556">                selectedPageCode = this.getSelectedNode();</span>
<span class="nc" id="L557">                this.setPageCode(selectedPageCode);</span>
            }
<span class="nc" id="L559">            IPageManager pageManager = this.getPageManager();</span>
<span class="nc" id="L560">            String check = this.checkSetOffline(selectedPageCode);</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">            if (null != check) {</span>
<span class="nc" id="L562">                return check;</span>
            }
<span class="nc" id="L564">            pageManager.setPageOffline(selectedPageCode);</span>
<span class="nc" id="L565">            IPage page = this.getPage(selectedPageCode);</span>
<span class="nc" id="L566">            this.addActionMessage(this.getText(&quot;message.page.set.offline&quot;, new String[]{this.getTitle(page.getCode(), page</span>
<span class="nc" id="L567">                .getTitles())}));</span>
            // TODO Define a new strutsAction to map &quot;offline&quot; operation
<span class="nc" id="L569">            this.addActivityStreamInfo(page, PageActionConstants.UNPUBLISH, true);</span>
<span class="nc" id="L570">        } catch (Throwable t) {</span>
<span class="nc" id="L571">            logger.error(&quot;error setting page {} offline&quot;, selectedPageCode, t);</span>
<span class="nc" id="L572">            return FAILURE;</span>
<span class="nc" id="L573">        }</span>
<span class="nc" id="L574">        return SUCCESS;</span>
    }

    public String checkSetOnline() {
<span class="nc" id="L578">        String selectedPageCode = this.getPageCode();</span>
        try {
<span class="nc bnc" id="L580" title="All 2 branches missed.">            if (StringUtils.isEmpty(selectedPageCode)) {</span>
<span class="nc" id="L581">                selectedPageCode = this.getSelectedNode();</span>
<span class="nc" id="L582">                this.setPageCode(selectedPageCode);</span>
            }
<span class="nc" id="L584">            String check = this.checkSelectedNode(selectedPageCode);</span>
<span class="nc bnc" id="L585" title="All 2 branches missed.">            if (null != check) {</span>
<span class="nc" id="L586">                return check;</span>
            }
<span class="nc" id="L588">        } catch (Throwable t) {</span>
<span class="nc" id="L589">            logger.error(&quot;error checking before putting page {} online&quot;, selectedPageCode, t);</span>
<span class="nc" id="L590">            return FAILURE;</span>
<span class="nc" id="L591">        }</span>
<span class="nc" id="L592">        return SUCCESS;</span>
    }

    public String doSetOnline() {
<span class="nc" id="L596">        String selectedPageCode = this.getPageCode();</span>
        try {
<span class="nc bnc" id="L598" title="All 2 branches missed.">            if (StringUtils.isEmpty(selectedPageCode)) {</span>
<span class="nc" id="L599">                selectedPageCode = this.getSelectedNode();</span>
<span class="nc" id="L600">                this.setPageCode(selectedPageCode);</span>
            }
<span class="nc" id="L602">            IPageManager pageManager = this.getPageManager();</span>
<span class="nc" id="L603">            String check = this.checkSelectedNode(selectedPageCode);</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">            if (null != check) {</span>
<span class="nc" id="L605">                return check;</span>
            }
<span class="nc" id="L607">            IPage page = this.getPage(selectedPageCode);</span>
<span class="nc" id="L608">            IPage parentPage = this.getPageManager().getDraftPage(page.getParentCode());</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">            if (!parentPage.isOnline()) {</span>
<span class="nc" id="L610">                this.addActionError(this.getText(&quot;error.page.parentDraft&quot;));</span>
<span class="nc" id="L611">                return &quot;pageTree&quot;;</span>
            }
<span class="nc" id="L613">            boolean success = this.getPageActionReferencesHelper().checkForSetOnline(page, this);</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">            if (!success) {</span>
<span class="nc" id="L615">                this.addActionError(this.getText(&quot;error.page.setOnline.scanContentRefs&quot;));</span>
<span class="nc" id="L616">                return &quot;pageTree&quot;;</span>
            }
<span class="nc bnc" id="L618" title="All 2 branches missed.">            if (this.hasErrors()) {</span>
<span class="nc" id="L619">                return &quot;pageTree&quot;;</span>
            }
<span class="nc" id="L621">            pageManager.setPageOnline(selectedPageCode);</span>
<span class="nc" id="L622">            this.addActionMessage(this.getText(&quot;message.page.set.online&quot;, new String[]{this.getTitle(page.getCode(), page</span>
<span class="nc" id="L623">                .getTitles())}));</span>
            // TODO Define a new strutsAction to map &quot;offline&quot; operation
<span class="nc" id="L625">            this.addActivityStreamInfo(page, PageActionConstants.PUBLISH, true);</span>
<span class="nc" id="L626">        } catch (Throwable t) {</span>
<span class="nc" id="L627">            logger.error(&quot;error setting page {} online&quot;, selectedPageCode, t);</span>
<span class="nc" id="L628">            return FAILURE;</span>
<span class="nc" id="L629">        }</span>
<span class="nc" id="L630">        return SUCCESS;</span>
    }

    public String trash() {
<span class="nc" id="L634">        String selectedNode = this.getSelectedNode();</span>
        try {
<span class="nc" id="L636">            String check = this.checkDelete(selectedNode);</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">            if (null != check) {</span>
<span class="nc" id="L638">                return check;</span>
            }
<span class="nc" id="L640">            IPage currentPage = this.getPage(selectedNode);</span>
<span class="nc" id="L641">            this.setNodeToBeDelete(selectedNode);</span>
<span class="nc" id="L642">            this.setSelectedNode(currentPage.getParentCode());</span>
<span class="nc" id="L643">        } catch (Throwable t) {</span>
<span class="nc" id="L644">            logger.error(&quot;error in trash&quot;, t);</span>
<span class="nc" id="L645">            return FAILURE;</span>
<span class="nc" id="L646">        }</span>
<span class="nc" id="L647">        return SUCCESS;</span>
    }

    public String delete() {
<span class="nc" id="L651">        String selectedNode = this.getNodeToBeDelete();</span>
        try {
<span class="nc" id="L653">            IPageManager pageManager = this.getPageManager();</span>
<span class="nc" id="L654">            String check = this.checkDelete(selectedNode);</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">            if (null != check) {</span>
<span class="nc" id="L656">                return check;</span>
            }
<span class="nc" id="L658">            IPage pageToDelete = this.getPage(selectedNode);</span>
<span class="nc" id="L659">            pageManager.deletePage(selectedNode);</span>
<span class="nc" id="L660">            this.setSelectedNode(pageToDelete.getParentCode());</span>
<span class="nc" id="L661">            this.addActivityStreamInfo(pageToDelete, ApsAdminSystemConstants.DELETE, false);</span>
<span class="nc" id="L662">        } catch (Throwable t) {</span>
<span class="nc" id="L663">            logger.error(&quot;error in delete&quot;, t);</span>
<span class="nc" id="L664">            return FAILURE;</span>
<span class="nc" id="L665">        }</span>
<span class="nc" id="L666">        return SUCCESS;</span>
    }

    protected String checkSetOffline(String selectedNode) throws ApsSystemException {
<span class="nc" id="L670">        String check = this.checkSelectedNode(selectedNode);</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">        if (null != check) {</span>
<span class="nc" id="L672">            return check;</span>
        }
<span class="nc" id="L674">        IPage currentPage = this.getPage(selectedNode);</span>
<span class="nc" id="L675">        String[] children = currentPage.getChildrenCodes();</span>
<span class="nc" id="L676">        IPage root = this.getPageManager().getOnlineRoot();</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">        if (root.getCode().equals(currentPage.getCode())) {</span>
<span class="nc" id="L678">            this.addActionError(this.getText(&quot;error.page.offlineHome.notAllowed&quot;));</span>
<span class="nc" id="L679">            return &quot;pageTree&quot;;</span>
<span class="nc bnc" id="L680" title="All 4 branches missed.">        } else if (null != children &amp;&amp; children.length != 0) {</span>
<span class="nc" id="L681">            boolean hasReferences = false;</span>
<span class="nc" id="L682">            boolean isOnline = currentPage.isOnline();</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">            for (int i = 0; i &lt; children.length; i++) {</span>
<span class="nc" id="L684">                IPage child = PageUtils.getPage(this.getPageManager(), isOnline, children[i]);</span>
<span class="nc bnc" id="L685" title="All 4 branches missed.">                if (null != child &amp;&amp; child.isOnline()) {</span>
<span class="nc" id="L686">                    this.addActionError(this.getText(&quot;error.page.offline.notAllowed&quot;));</span>
<span class="nc" id="L687">                    hasReferences = true;</span>
<span class="nc" id="L688">                    break;</span>
                }
            }
<span class="nc bnc" id="L691" title="All 2 branches missed.">            if (hasReferences) {</span>
<span class="nc" id="L692">                return &quot;pageTree&quot;;</span>
            }
        }
<span class="nc" id="L695">        Map extractedReferences = this.getPageActionHelper().getReferencingObjects(currentPage, this.getRequest());</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">        if (extractedReferences.size() &gt; 0) {</span>
<span class="nc" id="L697">            this.addActionError(this.getText(&quot;error.page.offline.references&quot;, new String[]{this.getTitle(currentPage.getCode(),</span>
<span class="nc" id="L698">                currentPage.getTitles())}));</span>
<span class="nc" id="L699">            this.setReferences(extractedReferences);</span>
<span class="nc" id="L700">            return &quot;references&quot;;</span>
        }
<span class="nc" id="L702">        return null;</span>
    }

    protected String checkDelete(String selectedNode) throws ApsSystemException {
<span class="nc" id="L706">        String check = this.checkSelectedNode(selectedNode);</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">        if (null != check) {</span>
<span class="nc" id="L708">            return check;</span>
        }
<span class="nc" id="L710">        IPage currentPage = this.getPage(selectedNode);</span>
<span class="nc" id="L711">        IPage root = this.getPageManager().getOnlineRoot();</span>
<span class="nc" id="L712">        IPage parentPage = this.getPageManager().getDraftPage(currentPage.getParentCode());</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">        if (root.getCode().equals(currentPage.getCode())) {</span>
<span class="nc" id="L714">            this.addActionError(this.getText(&quot;error.page.removeHome.notAllowed&quot;));</span>
<span class="nc" id="L715">            return &quot;pageTree&quot;;</span>
<span class="nc bnc" id="L716" title="All 4 branches missed.">        } else if (!isUserAllowed(currentPage) || !isUserAllowed(parentPage)) {</span>
<span class="nc" id="L717">            this.addActionError(this.getText(&quot;error.page.remove.notAllowed&quot;));</span>
<span class="nc" id="L718">            return &quot;pageTree&quot;;</span>
<span class="nc bnc" id="L719" title="All 4 branches missed.">        } else if (null != currentPage.getChildrenCodes() &amp;&amp; currentPage.getChildrenCodes().length != 0) {</span>
<span class="nc" id="L720">            this.addActionError(this.getText(&quot;error.page.remove.notAllowed2&quot;));</span>
<span class="nc" id="L721">            return &quot;pageTree&quot;;</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">        } else if (null != this.getOnlinePage(selectedNode)) {</span>
<span class="nc" id="L723">            this.addActionError(this.getText(&quot;error.page.remove.notAllowed3&quot;));</span>
<span class="nc" id="L724">            return &quot;pageTree&quot;;</span>
        } else {
<span class="nc" id="L726">            Map extractedReferences = this.getPageActionHelper().getReferencingObjects(currentPage, this.getRequest());</span>
<span class="nc bnc" id="L727" title="All 2 branches missed.">            if (extractedReferences.size() &gt; 0) {</span>
<span class="nc" id="L728">                this.setReferences(extractedReferences);</span>
<span class="nc" id="L729">                return &quot;references&quot;;</span>
            }
        }
<span class="nc" id="L732">        return null;</span>
    }

    protected void addActivityStreamInfo(IPage page, int strutsAction, boolean addLink) {
<span class="nc" id="L736">        ActivityStreamInfo asi = this.getPageActionHelper().createActivityStreamInfo(page, strutsAction, addLink, &quot;edit&quot;);</span>
<span class="nc" id="L737">        super.addActivityStreamInfo(asi);</span>
<span class="nc" id="L738">    }</span>

    public PageResponse getPageResponse() {
<span class="nc" id="L741">        IPage draftPage = null;</span>
<span class="nc" id="L742">        IPage onlinePage = null;</span>
<span class="nc bnc" id="L743" title="All 2 branches missed.">        if (StringUtils.isNotBlank(this.getPageCode())) {</span>
<span class="nc" id="L744">            draftPage = this.getPage(this.getPageCode());</span>
<span class="nc" id="L745">            onlinePage = this.getOnlinePage(this.getPageCode());</span>
        }
<span class="nc" id="L747">        PageResponse pageResponse = new PageResponse(this, draftPage, onlinePage);</span>
<span class="nc" id="L748">        pageResponse.setReferences(this.getReferences());</span>
<span class="nc" id="L749">        return pageResponse;</span>
    }

    /**
     * Return the list of allowed groups.
     *
     * @return The list of allowed groups.
     */
    public List&lt;Group&gt; getAllowedGroups() {
<span class="nc" id="L758">        return super.getActualAllowedGroups();</span>
    }

    /**
     * Return the list of system groups.
     *
     * @return The list of system groups.
     */
    public List&lt;Group&gt; getGroups() {
<span class="nc" id="L767">        List&lt;Group&gt; groups = this.getGroupManager().getGroups();</span>
<span class="nc" id="L768">        BeanComparator c = new BeanComparator(&quot;description&quot;);</span>
<span class="nc" id="L769">        Collections.sort(groups, c);</span>
<span class="nc" id="L770">        return groups;</span>
    }

    public List&lt;PageModel&gt; getPageModels() {
<span class="nc" id="L774">        return new ArrayList&lt;&gt;(this.getPageModelManager().getPageModels());</span>
    }

    public PageModel getPageModel(String code) {
<span class="nc" id="L778">        return this.getPageModelManager().getPageModel(code);</span>
    }

    public String getCopyPageCode() {
<span class="nc" id="L782">        return copyPageCode;</span>
    }

    public void setCopyPageCode(String copyPageCode) {
<span class="nc" id="L786">        this.copyPageCode = copyPageCode;</span>
<span class="nc" id="L787">    }</span>

    public boolean isDefaultShowlet() {
<span class="nc" id="L790">        return defaultShowlet;</span>
    }

    public void setDefaultShowlet(boolean defaultShowlet) {
<span class="nc" id="L794">        this.defaultShowlet = defaultShowlet;</span>
<span class="nc" id="L795">    }</span>

    public String getGroup() {
<span class="nc" id="L798">        return group;</span>
    }

    public void setGroup(String group) {
<span class="nc" id="L802">        this.group = group;</span>
<span class="nc" id="L803">    }</span>

    public boolean isGroupSelectLock() {
<span class="nc" id="L806">        return groupSelectLock;</span>
    }

    public void setGroupSelectLock(boolean groupSelectLock) {
<span class="nc" id="L810">        this.groupSelectLock = groupSelectLock;</span>
<span class="nc" id="L811">    }</span>

    public void setExtraGroups(Set&lt;String&gt; extraGroups) {
<span class="nc" id="L814">        this.extraGroups = extraGroups;</span>
<span class="nc" id="L815">    }</span>

    public Set&lt;String&gt; getExtraGroups() {
<span class="nc" id="L818">        return extraGroups;</span>
    }

    public String getModel() {
<span class="nc" id="L822">        return model;</span>
    }

    public void setModel(String model) {
<span class="nc" id="L826">        this.model = model;</span>
<span class="nc" id="L827">    }</span>

    public String getPageCode() {
<span class="nc" id="L830">        return pageCode;</span>
    }

    public void setPageCode(String pageCode) {
<span class="nc" id="L834">        this.pageCode = pageCode;</span>
<span class="nc" id="L835">    }</span>

    public String getParentPageCode() {
<span class="nc" id="L838">        return parentPageCode;</span>
    }

    public void setParentPageCode(String parentPageCode) {
<span class="nc" id="L842">        this.parentPageCode = parentPageCode;</span>
<span class="nc" id="L843">    }</span>

    public boolean isShowable() {
<span class="nc" id="L846">        return showable;</span>
    }

    public void setShowable(boolean showable) {
<span class="nc" id="L850">        this.showable = showable;</span>
<span class="nc" id="L851">    }</span>

    public boolean isUseExtraTitles() {
<span class="nc" id="L854">        return useExtraTitles;</span>
    }

    public void setUseExtraTitles(boolean useExtraTitles) {
<span class="nc" id="L858">        this.useExtraTitles = useExtraTitles;</span>
<span class="nc" id="L859">    }</span>

    public int getStrutsAction() {
<span class="nc" id="L862">        return strutsAction;</span>
    }

    public void setStrutsAction(int strutsAction) {
<span class="nc" id="L866">        this.strutsAction = strutsAction;</span>
<span class="nc" id="L867">    }</span>

    public String getCharset() {
<span class="nc" id="L870">        return charset;</span>
    }

    public void setCharset(String charset) {
<span class="nc" id="L874">        this.charset = charset;</span>
<span class="nc" id="L875">    }</span>

    public String getMimeType() {
<span class="nc" id="L878">        return mimeType;</span>
    }

    public void setMimeType(String mimeType) {
<span class="nc" id="L882">        this.mimeType = mimeType;</span>
<span class="nc" id="L883">    }</span>

    public ApsProperties getTitles() {
<span class="nc" id="L886">        return titles;</span>
    }

    public void setTitles(ApsProperties titles) {
<span class="nc" id="L890">        this.titles = titles;</span>
<span class="nc" id="L891">    }</span>

    public String getNodeToBeDelete() {
<span class="nc" id="L894">        return nodeToBeDelete;</span>
    }

    public void setNodeToBeDelete(String nodeToBeDelete) {
<span class="nc" id="L898">        this.nodeToBeDelete = nodeToBeDelete;</span>
<span class="nc" id="L899">    }</span>

    public IPage getPageToShow() {
<span class="nc" id="L902">        return pageToShow;</span>
    }

    protected void setPageToShow(IPage pageToShow) {
<span class="nc" id="L906">        this.pageToShow = pageToShow;</span>
<span class="nc" id="L907">    }</span>

    public Map getReferences() {
<span class="nc" id="L910">        return references;</span>
    }

    protected void setReferences(Map references) {
<span class="nc" id="L914">        this.references = references;</span>
<span class="nc" id="L915">    }</span>

    public String[] getAllowedCharsets() {
<span class="nc bnc" id="L918" title="All 2 branches missed.">        if (null == this.getAllowedCharsetsCSV()) {</span>
<span class="nc" id="L919">            return new String[0];</span>
        }
<span class="nc" id="L921">        return this.getAllowedCharsetsCSV().split(&quot;,&quot;);</span>
    }

    protected String getAllowedCharsetsCSV() {
<span class="nc" id="L925">        return _allowedCharsetsCSV;</span>
    }

    public void setAllowedCharsetsCSV(String allowedCharsetsCSV) {
<span class="nc" id="L929">        this._allowedCharsetsCSV = allowedCharsetsCSV;</span>
<span class="nc" id="L930">    }</span>

    public String[] getAllowedMimeTypes() {
<span class="nc bnc" id="L933" title="All 2 branches missed.">        if (null == this.getAllowedMimeTypesCSV()) {</span>
<span class="nc" id="L934">            return new String[0];</span>
        }
<span class="nc" id="L936">        return this.getAllowedMimeTypesCSV().split(&quot;,&quot;);</span>
    }

    protected String getAllowedMimeTypesCSV() {
<span class="nc" id="L940">        return _allowedMimeTypesCSV;</span>
    }

    public void setAllowedMimeTypesCSV(String allowedMimeTypesCSV) {
<span class="nc" id="L944">        this._allowedMimeTypesCSV = allowedMimeTypesCSV;</span>
<span class="nc" id="L945">    }</span>

    public String getTargetNode() {
<span class="nc" id="L948">        return targetNode;</span>
    }

    public void setTargetNode(String targetNode) {
<span class="nc" id="L952">        this.targetNode = targetNode;</span>
<span class="nc" id="L953">    }</span>

    public Set&lt;String&gt; getTreeNodesToOpen() {
<span class="nc" id="L956">        return treeNodesToOpen;</span>
    }

    public void setTreeNodesToOpen(Set&lt;String&gt; treeNodesToOpen) {
<span class="nc" id="L960">        this.treeNodesToOpen = treeNodesToOpen;</span>
<span class="nc" id="L961">    }</span>

    public String getTreeNodeActionMarkerCode() {
<span class="nc" id="L964">        return treeNodeActionMarkerCode;</span>
    }

    public void setTreeNodeActionMarkerCode(String treeNodeActionMarkerCode) {
<span class="nc" id="L968">        this.treeNodeActionMarkerCode = treeNodeActionMarkerCode;</span>
<span class="nc" id="L969">    }</span>

    @Override
    public void setServletResponse(HttpServletResponse response) {
<span class="nc" id="L973">        this.response = response;</span>
<span class="nc" id="L974">    }</span>

    public HttpServletResponse getServletResponse() {
<span class="nc" id="L977">        return this.response;</span>
    }

    protected IPageActionHelper getPageActionHelper() {
<span class="nc" id="L981">        return pageActionHelper;</span>
    }

    public void setPageActionHelper(IPageActionHelper pageActionHelper) {
<span class="nc" id="L985">        this.pageActionHelper = pageActionHelper;</span>
<span class="nc" id="L986">    }</span>

    protected IPageModelManager getPageModelManager() {
<span class="nc" id="L989">        return pageModelManager;</span>
    }

    public void setPageModelManager(IPageModelManager pageModelManager) {
<span class="nc" id="L993">        this.pageModelManager = pageModelManager;</span>
<span class="nc" id="L994">    }</span>

    protected IPageActionReferencesHelper getPageActionReferencesHelper() {
<span class="nc" id="L997">        return pageActionReferencesHelper;</span>
    }

    public void setPageActionReferencesHelper(IPageActionReferencesHelper pageActionReferencesHelper) {
<span class="nc" id="L1001">        this.pageActionReferencesHelper = pageActionReferencesHelper;</span>
<span class="nc" id="L1002">    }</span>

    public String getExtraGroupNameToRemove() {
<span class="nc" id="L1005">        return extraGroupNameToRemove;</span>
    }

    public void setExtraGroupNameToRemove(String extraGroupNameToRemove) {
<span class="nc" id="L1009">        this.extraGroupNameToRemove = extraGroupNameToRemove;</span>
<span class="nc" id="L1010">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>