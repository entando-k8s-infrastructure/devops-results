<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ContentSchedulerManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Entando Plugin: Content Scheduler</a> &gt; <a href="index.source.html" class="el_package">org.entando.entando.plugins.jpcontentscheduler.aps.system.services.content</a> &gt; <span class="el_source">ContentSchedulerManager.java</span></div><h1>ContentSchedulerManager.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2017-Present Entando Inc. (http://www.entando.com) All rights reserved.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the &quot;Software&quot;), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
package org.entando.entando.plugins.jpcontentscheduler.aps.system.services.content;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.entando.entando.aps.system.services.cache.CacheInfoEvict;
import org.entando.entando.aps.system.services.cache.ICacheInfoManager;
import org.entando.entando.aps.system.services.userprofile.model.UserProfile;
import org.entando.entando.plugins.jpcontentscheduler.aps.system.services.ContentThreadConstants;
import org.entando.entando.plugins.jpcontentscheduler.aps.system.services.content.model.ContentState;
import org.entando.entando.plugins.jpcontentscheduler.aps.system.services.content.model.ContentSuspendMove;
import org.entando.entando.plugins.jpcontentscheduler.aps.system.services.content.model.ContentThreadConfig;
import org.entando.entando.plugins.jpcontentscheduler.aps.system.services.content.model.ContentTypeElem;
import org.entando.entando.plugins.jpcontentscheduler.aps.system.services.content.parse.ContentThreadConfigDOM;
import org.entando.entando.plugins.jpcontentscheduler.aps.system.services.content.util.Utils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.cache.annotation.CacheEvict;

import com.agiletec.aps.system.ApsSystemUtils;
import com.agiletec.aps.system.SystemConstants;
import com.agiletec.aps.system.common.AbstractService;
import com.agiletec.aps.system.common.entity.model.EntitySearchFilter;
import com.agiletec.aps.system.common.entity.model.attribute.ITextAttribute;
import com.agiletec.aps.system.exception.ApsSystemException;
import com.agiletec.aps.system.services.authorization.IApsAuthority;
import com.agiletec.aps.system.services.authorization.IAuthorizationManager;
import com.agiletec.aps.system.services.baseconfig.ConfigInterface;
import com.agiletec.aps.system.services.baseconfig.SystemParamsUtils;
import com.agiletec.aps.system.services.keygenerator.IKeyGeneratorManager;
import com.agiletec.aps.system.services.user.IUserManager;
import com.agiletec.aps.system.services.user.UserDetails;
import com.agiletec.plugins.jacms.aps.system.services.content.IContentManager;
import com.agiletec.plugins.jacms.aps.system.services.content.IContentSearcherDAO;
import com.agiletec.plugins.jacms.aps.system.services.content.model.Content;
import com.agiletec.plugins.jpmail.aps.services.mail.IMailManager;

/**
 * Classe che implementa i servizi da necessari al thread di
 * pubblicazione/sospenzione automatica
 */
<span class="nc" id="L68">public class ContentSchedulerManager extends AbstractService implements IContentSchedulerManager {</span>

<span class="nc" id="L70">    private static final Logger _logger = LoggerFactory.getLogger(ContentSchedulerManager.class);</span>
    private static final long serialVersionUID = 6880576602469119814L;

    private IContentSearcherDAO _workContentSearcherDAO;

    private ConfigInterface configManager;
    private ContentThreadConfig config;
    private IAuthorizationManager _authorizationManager;
    private IUserManager _userManager;
    private IContentSchedulerDAO _contentSchedulerDAO;

    private IMailManager _mailManager;

    @Override
    public void init() throws Exception {
<span class="nc" id="L85">        this.loadConfigs();</span>
<span class="nc" id="L86">        _logger.info(this.getClass().getName() + &quot;: inizializzato&quot;);</span>
<span class="nc" id="L87">    }</span>

    /**
     * Carico la configurazione impostata nella tabella sysconfig di japsport
     * (parametro 'cthread_config')
     */
    private void loadConfigs() throws ApsSystemException {
        try {
<span class="nc" id="L95">            String xml = this.getConfigManager().getConfigItem(ContentThreadConstants.CONTENTTHREAD_CONFIG_ITEM);</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">            if (xml == null) {</span>
<span class="nc" id="L97">                throw new ApsSystemException(ContentThreadConstants.READ_CONFIG_ERROR + ContentThreadConstants.CONTENTTHREAD_CONFIG_ITEM);</span>
            }
<span class="nc" id="L99">            ContentThreadConfigDOM configDOM = new ContentThreadConfigDOM();</span>
<span class="nc" id="L100">            this.setConfig(configDOM.extractConfig(xml));</span>
<span class="nc" id="L101">        } catch (Throwable t) {</span>
<span class="nc" id="L102">            ApsSystemUtils.logThrowable(t, this, &quot;loadConfigs&quot;);</span>
<span class="nc" id="L103">            throw new ApsSystemException(ContentThreadConstants.INIT_ERROR, t);</span>
<span class="nc" id="L104">        }</span>
<span class="nc" id="L105">    }</span>

    @Override
    public void updateConfig(ContentThreadConfig config) throws ApsSystemException {
        try {
<span class="nc" id="L110">            String xml = new ContentThreadConfigDOM().createConfigXml(config);</span>
<span class="nc" id="L111">            this.getConfigManager().updateConfigItem(ContentThreadConstants.CONTENTTHREAD_CONFIG_ITEM, xml);</span>
<span class="nc" id="L112">            this.setConfig(config);</span>
<span class="nc" id="L113">        } catch (Throwable t) {</span>
<span class="nc" id="L114">            ApsSystemUtils.logThrowable(t, this, &quot;loadConfigs&quot;);</span>
<span class="nc" id="L115">            throw new ApsSystemException(&quot;error updating configuration&quot;, t);</span>
<span class="nc" id="L116">        }</span>

<span class="nc" id="L118">    }</span>

    /**
     * Restituisce tutti i contenuti che hanno un attributo con nome key
     * Data_inizio e valore la data corrente
     *
     * @throws com.agiletec.aps.system.exception.ApsSystemException
     */
    @Override
    public List&lt;String&gt; getContentIdToPublish() throws ApsSystemException {
<span class="nc" id="L128">        List&lt;String&gt; ans = new ArrayList&lt;String&gt;();</span>
        try {
<span class="nc bnc" id="L130" title="All 2 branches missed.">            for (Iterator&lt;ContentTypeElem&gt; i = this.getConfig().getTypesList().iterator(); i.hasNext();) {</span>
<span class="nc" id="L131">                ContentTypeElem elem = i.next();</span>
<span class="nc" id="L132">                String filterKey = elem.getStartDateAttr();</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">                if (null != filterKey) {</span>
<span class="nc" id="L134">                    Calendar cal = Calendar.getInstance();</span>
                    // cal.setTime(new Date());
<span class="nc" id="L136">                    cal.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L137">                    cal.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L138">                    cal.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L139">                    Date start = cal.getTime();</span>
<span class="nc" id="L140">                    cal.add(Calendar.DAY_OF_YEAR, 1);</span>
<span class="nc" id="L141">                    Date end = cal.getTime();</span>
<span class="nc" id="L142">                    EntitySearchFilter[] filters = new EntitySearchFilter[]{new EntitySearchFilter(filterKey, true, start, end)};</span>
<span class="nc" id="L143">                    List&lt;String&gt; retrieved = this.getWorkContentSearcherDAO().searchId(elem.getContentType(), filters);</span>
<span class="nc" id="L144">                    ans.addAll(retrieved);</span>
                }
<span class="nc" id="L146">            }</span>
<span class="nc" id="L147">        } catch (Throwable t) {</span>
<span class="nc" id="L148">            _logger.error(ContentThreadConstants.GET_CONTENTIDS_ERROR, t);</span>
<span class="nc" id="L149">            throw new ApsSystemException(ContentThreadConstants.GET_CONTENTIDS_ERROR, t);</span>
<span class="nc" id="L150">        }</span>
<span class="nc" id="L151">        return ans;</span>
    }

    /**
     * Restituisce tutti i contenuti che hanno un attributo con nome key
     * Data_fine e valore la data corrente
     *
     * @throws com.agiletec.aps.system.exception.ApsSystemException
     */
    @Override
    public List&lt;ContentSuspendMove&gt; getContentAttrDataFine() throws ApsSystemException {
<span class="nc" id="L162">        List&lt;ContentSuspendMove&gt; ans = new ArrayList&lt;&gt;();</span>
        try {
<span class="nc bnc" id="L164" title="All 2 branches missed.">            for (Iterator&lt;ContentTypeElem&gt; i = this.config.getTypesList().iterator(); i.hasNext();) {</span>
<span class="nc" id="L165">                ContentTypeElem elem = i.next();</span>
<span class="nc" id="L166">                String filterKey = elem.getEndDateAttro();</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">                if (null != filterKey) {</span>
<span class="nc" id="L168">                    Date actualDate = new Date();</span>
                    // Data fine compresa nella settimana
<span class="nc" id="L170">                    Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L171">                    cal.setTime(actualDate);</span>
<span class="nc" id="L172">                    cal.add(Calendar.DATE, -7);</span>
<span class="nc" id="L173">                    Date beginDate = cal.getTime();</span>
<span class="nc" id="L174">                    EntitySearchFilter blobFilter = new EntitySearchFilter(IContentManager.CONTENT_ONLINE_FILTER_KEY, false, null, false);</span>
<span class="nc" id="L175">                    EntitySearchFilter[] filters = new EntitySearchFilter[]{new EntitySearchFilter(filterKey, true, beginDate, new Date()), blobFilter};</span>
<span class="nc" id="L176">                    List&lt;String&gt; retrieved = this.getWorkContentSearcherDAO().searchId(elem.getContentType(), filters);</span>
<span class="nc" id="L177">                    ContentSuspendMove contSuspMov = new ContentSuspendMove(elem.getSuspend(),</span>
                            retrieved,
<span class="nc" id="L179">                            elem.getContentType(),</span>
<span class="nc" id="L180">                            this.getConfig().getGlobalCat(),</span>
<span class="nc" id="L181">                            elem.getIdsCategories(),</span>
<span class="nc" id="L182">                            elem.getIdContentReplace(),</span>
<span class="nc" id="L183">                            elem.getModelIdContentReplace());</span>
<span class="nc" id="L184">                    contSuspMov.setContentIdReplace(this.getConfig().getContentIdRepl());</span>
<span class="nc" id="L185">                    contSuspMov.setContentModelReplace(this.getConfig().getContentModelRepl());</span>
<span class="nc" id="L186">                    ans.add(contSuspMov);</span>
                }
<span class="nc" id="L188">            }</span>
<span class="nc" id="L189">        } catch (Throwable t) {</span>
<span class="nc" id="L190">            _logger.error(ContentThreadConstants.GET_CONTENTIDS_ERROR, t);</span>
<span class="nc" id="L191">            throw new ApsSystemException(ContentThreadConstants.GET_CONTENTIDS_ERROR, t);</span>
<span class="nc" id="L192">        }</span>
<span class="nc" id="L193">        return ans;</span>
    }

    /**
     * Metodo per spedire le mail come impostato nella configurazione
     *
     * @param publishedContents
     * @param suspendedContents
     * @throws ApsSystemException
     */
    @Override
    public void sendMailWithResults(List&lt;ContentState&gt; publishedContents, List&lt;ContentState&gt; suspendedContents, List&lt;ContentState&gt; movedContents, Date startJobDate,
            Date endJobDate) throws ApsSystemException {
        // TODO send to groups
        // sendToGroups(publishedContents, suspendedContents);
<span class="nc" id="L208">        sendToUsers(publishedContents, suspendedContents, movedContents, startJobDate, endJobDate);</span>
<span class="nc" id="L209">    }</span>

    /**
     * Spedisco agli utenti specificati nella configurazione
     *
     * @param publishedContents
     * @param suspendedContents
     * @param startJobDate
     * @param endJobDate
     * @throws ApsSystemException
     */
    private void sendToUsers(List&lt;ContentState&gt; publishedContents, List&lt;ContentState&gt; suspendedContents, List&lt;ContentState&gt; moveContents, Date startJobDate, Date endJobDate)
            throws ApsSystemException {
<span class="nc" id="L222">        Map&lt;String, List&lt;String&gt;&gt; mapUsers = this.getConfig().getUsersContentType();</span>
<span class="nc" id="L223">        Set&lt;String&gt; keys = mapUsers.keySet();</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">        for (Iterator&lt;String&gt; i = keys.iterator(); i.hasNext();) {</span>
<span class="nc" id="L225">            String key = i.next();</span>
<span class="nc" id="L226">            List&lt;String&gt; typesList = mapUsers.get(key);</span>
<span class="nc" id="L227">            List&lt;ContentState&gt; contentPList = contentOfTypes(publishedContents, typesList);</span>
<span class="nc" id="L228">            List&lt;ContentState&gt; contentSList = contentOfTypes(suspendedContents, typesList);</span>
<span class="nc" id="L229">            List&lt;ContentState&gt; contentMList = contentOfTypes(moveContents, typesList);</span>
<span class="nc bnc" id="L230" title="All 12 branches missed.">            if ((contentPList != null &amp;&amp; contentPList.size() &gt; 0) || (contentSList != null &amp;&amp; contentSList.size() &gt; 0) || (contentMList != null &amp;&amp; contentMList.size() &gt; 0)) {</span>
<span class="nc" id="L231">                UserDetails user = this.getUserManager().getUser(key);</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">                if (user == null) {</span>
<span class="nc" id="L233">                    ApsSystemUtils.getLogger().error(ContentThreadConstants.USER_IS_NULL + key);</span>
<span class="nc" id="L234">                    continue;</span>
                } else {
<span class="nc" id="L236">                    UserProfile profile = (UserProfile) user.getProfile();</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">                    if (null != profile) {</span>
<span class="nc" id="L238">                        ITextAttribute mailAttribute = (ITextAttribute) profile.getAttributeByRole(SystemConstants.USER_PROFILE_ATTRIBUTE_ROLE_MAIL);</span>
<span class="nc" id="L239">                        String[] email = new String[1];</span>
<span class="nc bnc" id="L240" title="All 4 branches missed.">                        if (null != mailAttribute &amp;&amp; mailAttribute.getText().trim().length() &gt; 0) {</span>
<span class="nc" id="L241">                            email[0] = mailAttribute.getText();</span>
<span class="nc" id="L242">                            String simpleText = Utils.prepareMailText(contentPList, contentSList, contentMList, this.getConfig(), startJobDate, endJobDate);</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">                            if (this.getConfig().isAlsoHtml()) {</span>
<span class="nc" id="L244">                                String applBaseUrl = this.getConfigManager().getParam(SystemConstants.PAR_APPL_BASE_URL);</span>
<span class="nc" id="L245">                                String htmlText = Utils.prepareMailHtml(contentPList, contentSList, contentMList, this.getConfig(), startJobDate, endJobDate, applBaseUrl);</span>
<span class="nc" id="L246">                                boolean issent = this.getMailManager().sendMixedMail(simpleText, htmlText, config.getSubject(), null, email, null, null, config.getSenderCode());</span>
                                // System.out.println(&quot;***MAIL html&quot;);
<span class="nc bnc" id="L248" title="All 2 branches missed.">                                if (issent) {</span>
<span class="nc" id="L249">                                    ApsSystemUtils.getLogger().info(ContentThreadConstants.MAIL_SENT + key);</span>
                                } else {
<span class="nc" id="L251">                                    ApsSystemUtils.getLogger().error(ContentThreadConstants.SEND_ERROR + key);</span>
                                }
<span class="nc" id="L253">                            } else {</span>
                                // System.out.println(&quot;***MAIL simple&quot;);
<span class="nc" id="L255">                                boolean issent = this.getMailManager().sendMail(simpleText, config.getSubject(), email, null, null, config.getSenderCode());</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">                                if (issent) {</span>
<span class="nc" id="L257">                                    ApsSystemUtils.getLogger().info(ContentThreadConstants.MAIL_SENT + key);</span>
                                } else {
<span class="nc" id="L259">                                    ApsSystemUtils.getLogger().error(ContentThreadConstants.SEND_ERROR + key);</span>
                                }
                            }
                        }
<span class="nc" id="L263">                    } else {</span>
<span class="nc" id="L264">                        ApsSystemUtils.getLogger().error(ContentThreadConstants.PROFILE_IS_NULL + key);</span>
                    }
                }
            }
<span class="nc" id="L268">        }</span>
<span class="nc" id="L269">    }</span>

    /**
     * Dato un array di contenuti, restituisce tutti quelli di tipo specificato
     * nell'array types. Serve per sapere quali contenuti un gruppo o un utente
     * deve sapere la pubblicazione o sospensione
     *
     * @param contentList
     * @param types
     * @return
     */
    private List&lt;ContentState&gt; contentOfTypes(List&lt;ContentState&gt; contentList, List&lt;String&gt; types) {
<span class="nc" id="L281">        List&lt;ContentState&gt; ans = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">        for (Iterator&lt;ContentState&gt; itContent = contentList.iterator(); itContent.hasNext();) {</span>
<span class="nc" id="L283">            ContentState currElem = itContent.next();</span>
<span class="nc" id="L284">            String currType = currElem.getType();</span>
<span class="nc bnc" id="L285" title="All 6 branches missed.">            if ((types != null &amp;&amp; types.size() == 1 &amp;&amp; types.get(0).equals(ContentThreadConstants.ALL_TYPES))) {</span>
<span class="nc" id="L286">                ans.add(currElem);</span>
            } else {
<span class="nc bnc" id="L288" title="All 2 branches missed.">                for (Iterator&lt;String&gt; itTypes = types.iterator(); itTypes.hasNext();) {</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">                    if (itTypes.next().equals(currType)) {</span>
<span class="nc" id="L290">                        ans.add(currElem);</span>
                    }
                }
            }
<span class="nc" id="L294">        }</span>
<span class="nc" id="L295">        return ans;</span>
    }

    /**
     * NON USATO metodo ausiliario a getAuthorizedUsers
     *
     * @param groupName
     * @return
     */
    public IApsAuthority getApsAuthority(String groupName) {
<span class="nc" id="L305">        IApsAuthority authority = null;</span>
        // this.getAuthorizatorManager().getAuthority(groupName);
<span class="nc" id="L307">        return authority;</span>
    }

    /**
     * Restituisce la lista degli utenti associati ad un determinato gruppo
     *
     * @param groupName
     * @return
     */
    public List&lt;UserDetails&gt; getAuthorizedUsers(String groupName) {
        // IApsAuthority auth = this.getApsAuthority(groupName);
<span class="nc" id="L318">        List&lt;UserDetails&gt; users = null;</span>
        try {
<span class="nc" id="L320">            List&lt;String&gt; usernames = this.getAuthorizationManager().getUsersByGroup(groupName, false);</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">            if (usernames.size() &gt; 0) {</span>
<span class="nc" id="L322">                users = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">                for (int i = 0; i &lt; usernames.size(); i++) {</span>
<span class="nc" id="L324">                    UserDetails u = this.getUserManager().getUser(usernames.get(i));</span>
<span class="nc" id="L325">                    users.add(u);</span>
                }
            }

<span class="nc" id="L329">            return users; // this.getAuthorizatorManager().getUsersByAuthority(auth);</span>
<span class="nc" id="L330">        } catch (Throwable t) {</span>
<span class="nc" id="L331">            ApsSystemUtils.logThrowable(t, this, &quot;getUserAuthorizated&quot;);</span>
<span class="nc" id="L332">            throw new RuntimeException(&quot;Errore in ricerca utenti autorizzati&quot;, t);</span>
        }
    }

    /**
     * Return the desired system parameter
     *
     * @param paramName
     * @return
     */
    @Override
    public String getSystemParam(String paramName) {
<span class="nc" id="L344">        String param = &quot;&quot;;</span>
        try {
<span class="nc" id="L346">            String xmlParams = this.getConfigManager().getConfigItem(SystemConstants.CONFIG_ITEM_PARAMS);</span>
<span class="nc" id="L347">            Map&lt;String, String&gt; systemParams = SystemParamsUtils.getParams(xmlParams);</span>
<span class="nc" id="L348">            param = systemParams.get(paramName);</span>
<span class="nc" id="L349">        } catch (Throwable t) {</span>
            // _logger.error(&quot;error getting the system parameter &quot; + paramName,
            // t);
<span class="nc" id="L352">            ApsSystemUtils.logThrowable(t, this, &quot;error getting the system parameter &quot; + paramName);</span>
<span class="nc" id="L353">        }</span>
<span class="nc" id="L354">        return param;</span>
    }

    protected IContentSchedulerDAO getContentSchedulerDAO() {
<span class="nc" id="L358">        return _contentSchedulerDAO;</span>
    }

    public void setContentSchedulerDAO(IContentSchedulerDAO contentSchedulerDAO) {
<span class="nc" id="L362">        this._contentSchedulerDAO = contentSchedulerDAO;</span>
<span class="nc" id="L363">    }</span>

    public IUserManager getUserManager() {
<span class="nc" id="L366">        return _userManager;</span>
    }

    public void setUserManager(IUserManager userManager) {
<span class="nc" id="L370">        this._userManager = userManager;</span>
<span class="nc" id="L371">    }</span>

    protected IContentSearcherDAO getWorkContentSearcherDAO() {
<span class="nc" id="L374">        return _workContentSearcherDAO;</span>
    }

    public void setWorkContentSearcherDAO(IContentSearcherDAO workContentSearcherDAO) {
<span class="nc" id="L378">        this._workContentSearcherDAO = workContentSearcherDAO;</span>
<span class="nc" id="L379">    }</span>

    public IMailManager getMailManager() {
<span class="nc" id="L382">        return _mailManager;</span>
    }

    public void setMailManager(IMailManager mailManager) {
<span class="nc" id="L386">        this._mailManager = mailManager;</span>
<span class="nc" id="L387">    }</span>

    @Override
    public ContentThreadConfig getConfig() {
<span class="nc" id="L391">        return config;</span>
    }

    public void setConfig(ContentThreadConfig config) {
<span class="nc" id="L395">        this.config = config;</span>
<span class="nc" id="L396">    }</span>

    public ConfigInterface getConfigManager() {
<span class="nc" id="L399">        return configManager;</span>
    }

    public void setConfigManager(ConfigInterface configManager) {
<span class="nc" id="L403">        this.configManager = configManager;</span>
<span class="nc" id="L404">    }</span>

    public IAuthorizationManager getAuthorizationManager() {
<span class="nc" id="L407">        return _authorizationManager;</span>
    }

    public void setAuthorizationManager(IAuthorizationManager authorizationManager) {
<span class="nc" id="L411">        this._authorizationManager = authorizationManager;</span>
<span class="nc" id="L412">    }</span>

    /**
     * Only for ONE SHOT Procedure
     *
     * @param content
     * @param updateDate
     * @throws ApsSystemException
     */
    @Override
    public void moveOnLineContent(Content content, boolean updateDate, boolean updateLastModified) throws ApsSystemException {
        try {
<span class="nc bnc" id="L424" title="All 2 branches missed.">            if (updateLastModified) {</span>
<span class="nc" id="L425">                content.setLastModified(new Date());</span>
            }
<span class="nc bnc" id="L427" title="All 2 branches missed.">            if (updateDate) {</span>
<span class="nc" id="L428">                content.incrementVersion(false);</span>
            }
<span class="nc bnc" id="L430" title="All 2 branches missed.">            if (null == content.getId()) {</span>
<span class="nc" id="L431">                IKeyGeneratorManager keyGenerator = (IKeyGeneratorManager) this.getService(SystemConstants.KEY_GENERATOR_MANAGER);</span>
<span class="nc" id="L432">                int key = keyGenerator.getUniqueKeyCurrentValue();</span>
<span class="nc" id="L433">                String id = content.getTypeCode() + key;</span>
<span class="nc" id="L434">                content.setId(id);</span>
<span class="nc" id="L435">                this.getContentSchedulerDAO().addEntity(content);</span>
<span class="nc" id="L436">            } else {</span>
<span class="nc" id="L437">                this.getContentSchedulerDAO().updateContent(content, updateDate);</span>
<span class="nc" id="L438">                this.getContentSchedulerDAO().publishContent(content);</span>
            }
<span class="nc" id="L440">        } catch (Throwable t) {</span>
<span class="nc" id="L441">            ApsSystemUtils.logThrowable(t, this, &quot;moveOnLineContent&quot;);</span>
<span class="nc" id="L442">            throw new ApsSystemException(&quot;Error while move content on line&quot;, t);</span>
<span class="nc" id="L443">        }</span>
<span class="nc" id="L444">    }</span>

    /**
     * Unpublish a content, preventing it from being displayed in the portal.
     * Obviously the content itself is not deleted.
     *
     * @param content the content to unpublish.
     * @param updateLastModified .
     * @throws ApsSystemException in case of error
     */
    @Override
    @CacheEvict(value = ICacheInfoManager.DEFAULT_CACHE_NAME, key = &quot;T(com.agiletec.plugins.jacms.aps.system.JacmsSystemConstants).CONTENT_CACHE_PREFIX.concat(#content.id)&quot;, condition = &quot;#content.id != null&quot;)
    @CacheInfoEvict(value = ICacheInfoManager.DEFAULT_CACHE_NAME, groups = &quot;T(com.agiletec.plugins.jacms.aps.system.services.cache.CmsCacheWrapperManager).getContentCacheGroupsToEvictCsv(#content.id, #content.typeCode)&quot;)
    public void removeOnLineContent(Content content, boolean updateLastModified) throws ApsSystemException {
        try {
<span class="nc bnc" id="L459" title="All 2 branches missed.">            if (updateLastModified) {</span>
<span class="nc" id="L460">                content.setLastModified(new Date());</span>
            }
<span class="nc" id="L462">            content.incrementVersion(false);</span>
<span class="nc bnc" id="L463" title="All 4 branches missed.">            if (null != content.getStatus() &amp;&amp; content.getStatus().equals(Content.STATUS_PUBLIC)) {</span>
<span class="nc" id="L464">                content.setStatus(Content.STATUS_READY);</span>
            }
<span class="nc" id="L466">            this.getContentSchedulerDAO().unpublishOnLineContent(content);</span>
            // this.notifyPublicContentChanging(content,
            // PublicContentChangedEvent.REMOVE_OPERATION_CODE);
<span class="nc" id="L469">        } catch (Throwable t) {</span>
<span class="nc" id="L470">            ApsSystemUtils.logThrowable(t, this, &quot;removeOnLineContent&quot;);</span>
<span class="nc" id="L471">            throw new ApsSystemException(&quot;Error while removing onLine content&quot;, t);</span>
<span class="nc" id="L472">        }</span>
<span class="nc" id="L473">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>